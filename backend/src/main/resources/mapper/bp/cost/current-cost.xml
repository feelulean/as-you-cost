<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    현상원가 프로젝트 관리 Mapper
    테이블: PCM_CUR_PJT_MSTR (현상원가 프로젝트 마스터)
-->
<mapper namespace="smartcost.app.bp.cost.currentcost.CurrentCostRepository">

    <!-- ============================================================
         목록 조회
         ============================================================ -->
    <select id="findListCurrentCostPjt" parameterType="map" resultType="map">
        SELECT  A.TEN_ID        AS "tenId"
              , A.CC_PJT_CD     AS "pjtCd"
              , A.CC_REV        AS "ccRev"
              , A.EC_PJT_CD     AS "ecPjtCd"
              , A.PJT_NM       AS "pjtNm"
              , A.BIZ_UNIT     AS "bizUnit"
              , A.CUST_NM      AS "custNm"
              , A.CAR_TYPE     AS "carType"
              , A.OEM_NM       AS "oemNm"
              , A.PROD_GRP     AS "prodGrp"
              , A.PROG_STS     AS "progSts"
              , CASE A.PROG_STS
                    WHEN 'D' THEN 'Draft'
                    WHEN 'P' THEN '진행중'
                    WHEN 'A' THEN '확정'
                    WHEN 'C' THEN '완료'
                    ELSE ''
                END            AS "progStsNm"
              , A.STS          AS "sts"
              , TO_CHAR(A.REG_DTTM, 'YYYY-MM-DD') AS "regDttm"
              , A.RMK          AS "rmk"
          FROM  PCM_CUR_PJT_MSTR A
         WHERE  A.TEN_ID = #{g.tenant}
        <if test="p.pjtCd != null and p.pjtCd != ''">
           AND  A.CC_PJT_CD LIKE '%' || #{p.pjtCd} || '%'
        </if>
        <if test="p.bizUnit != null and p.bizUnit != ''">
           AND  A.BIZ_UNIT = #{p.bizUnit}
        </if>
        <if test="p.custNm != null and p.custNm != ''">
           AND  A.CUST_NM LIKE '%' || #{p.custNm} || '%'
        </if>
        <if test="p.carType != null and p.carType != ''">
           AND  A.CAR_TYPE LIKE '%' || #{p.carType} || '%'
        </if>
         ORDER BY A.CC_PJT_CD, A.CC_REV DESC
    </select>

    <!-- ============================================================
         프로젝트 코드 자동 채번
         형식: CC + 연도(4) + 일련번호(4)  예) CC20260001
         ============================================================ -->
    <select id="findNewCurrentCostPjtCd" resultType="string">
        SELECT  'CC' || TO_CHAR(CURRENT_DATE, 'YYYY')
                     || LPAD((COALESCE(MAX(CAST(SUBSTRING(A.CC_PJT_CD FROM 7) AS INTEGER)), 0) + 1)::TEXT, 4, '0')
          FROM  PCM_CUR_PJT_MSTR A
         WHERE  A.TEN_ID = #{g.tenant}
           AND  A.CC_PJT_CD LIKE 'CC' || TO_CHAR(CURRENT_DATE, 'YYYY') || '%'
    </select>

    <!-- ============================================================
         신규 등록 (EC 이관)
         ============================================================ -->
    <insert id="insertCurrentCostPjt" parameterType="map">
        INSERT INTO PCM_CUR_PJT_MSTR (
            TEN_ID
          , CC_PJT_CD
          , CC_REV
          , EC_PJT_CD
          , PJT_NM
          , BIZ_UNIT
          , CUST_NM
          , CAR_TYPE
          , OEM_NM
          , PROD_GRP
          , PROG_STS
          , RMK
          , STS
          , REGR_ID
          , REG_DTTM
          , MODR_ID
          , MOD_DTTM
        ) VALUES (
            #{g.tenant}
          , #{p.pjtCd}
          , #{p.ccRev}
          , #{p.ecPjtCd}
          , #{p.pjtNm}
          , #{p.bizUnit}
          , #{p.custNm}
          , #{p.carType}
          , #{p.oemNm}
          , #{p.prodGrp}
          , #{p.progSts}
          , #{p.rmk}
          , #{p.sts}
          , #{g.username}
          , #{g.now}
          , #{g.username}
          , #{g.now}
        )
    </insert>

    <!-- ============================================================
         진행상태 변경
         ============================================================ -->
    <update id="updateCurrentCostProgSts" parameterType="map">
        UPDATE  PCM_CUR_PJT_MSTR
           SET  PROG_STS  = #{p.nextProgSts}
              , MODR_ID   = #{g.username}
              , MOD_DTTM  = #{g.now}
         WHERE  TEN_ID     = #{g.tenant}
           AND  CC_PJT_CD  = #{p.pjtCd}
           AND  CC_REV     = #{p.ccRev}
    </update>

    <!-- ============================================================
         최대 현상차수 조회
         ============================================================ -->
    <select id="findMaxCcRev" parameterType="map" resultType="int">
        SELECT  COALESCE(MAX(A.CC_REV), 0)
          FROM  PCM_CUR_PJT_MSTR A
         WHERE  A.TEN_ID    = #{g.tenant}
           AND  A.CC_PJT_CD = #{p.pjtCd}
    </select>

    <!-- ============================================================
         재산출 — 기존 차수 복사하여 신규 차수 생성
         ============================================================ -->
    <insert id="insertCurrentCostPjtByRecalc" parameterType="map">
        INSERT INTO PCM_CUR_PJT_MSTR (
            TEN_ID
          , CC_PJT_CD
          , CC_REV
          , EC_PJT_CD
          , PJT_NM
          , BIZ_UNIT
          , CUST_NM
          , CAR_TYPE
          , OEM_NM
          , PROD_GRP
          , PROG_STS
          , RMK
          , STS
          , REGR_ID
          , REG_DTTM
          , MODR_ID
          , MOD_DTTM
        )
        SELECT  A.TEN_ID
              , A.CC_PJT_CD
              , #{p.newCcRev}
              , A.EC_PJT_CD
              , A.PJT_NM
              , A.BIZ_UNIT
              , A.CUST_NM
              , A.CAR_TYPE
              , A.OEM_NM
              , A.PROD_GRP
              , #{p.progSts}
              , A.RMK
              , 'T'
              , #{g.username}
              , #{g.now}
              , #{g.username}
              , #{g.now}
          FROM  PCM_CUR_PJT_MSTR A
         WHERE  A.TEN_ID    = #{g.tenant}
           AND  A.CC_PJT_CD = #{p.pjtCd}
           AND  A.CC_REV    = #{p.ccRev}
    </insert>

</mapper>

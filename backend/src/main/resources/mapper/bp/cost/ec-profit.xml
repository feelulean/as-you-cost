<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    견적원가 수익성 분석 Mapper
    테이블: PCM_EC_PROFIT (견적원가 수익성 분석)
    연계:   PCM_EC_PJT_MSTR (프로젝트 목록), PCM_EC_BOM (재료비 집계)
-->
<mapper namespace="smartcost.app.bp.cost.ecprofit.EcProfitRepository">

    <!-- ============================================================
         프로젝트 목록 조회 (좌측 그리드용 — 견적원가 마스터)
         ============================================================ -->
    <select id="findListEcPjtForProfit" parameterType="map" resultType="map">
        SELECT  A.TEN_ID        AS "tenId"
              , A.EC_PJT_CD     AS "pjtCd"
              , A.PJT_NM        AS "pjtNm"
              , A.CUST_NM       AS "custNm"
              , A.STS           AS "sts"
              , CASE A.STS
                    WHEN 'T' THEN '작성중'
                    WHEN 'P' THEN '진행중'
                    WHEN 'A' THEN '확정'
                    WHEN 'R' THEN '탈락'
                    WHEN 'C' THEN '완료'
                    ELSE ''
                END             AS "stsNm"
          FROM  PCM_EC_PJT_MSTR A
         WHERE  A.TEN_ID = #{g.tenant}
        <if test="p.pjtCd != null and p.pjtCd != ''">
           AND  A.EC_PJT_CD LIKE '%' || TRIM(#{p.pjtCd}) || '%'
        </if>
        <if test="p.custNm != null and p.custNm != ''">
           AND  A.CUST_NM LIKE '%' || TRIM(#{p.custNm}) || '%'
        </if>
         ORDER BY A.REG_DTTM DESC
    </select>

    <!-- ============================================================
         수익성 분석 데이터 단건 조회
         ============================================================ -->
    <select id="findEcProfit" parameterType="map" resultType="map">
        SELECT  A.TEN_ID          AS "tenId"
              , A.EC_PJT_CD       AS "ecPjtCd"
              , A.MAT_COST        AS "matCost"
              , A.LABOR_COST      AS "laborCost"
              , A.MFG_COST        AS "mfgCost"
              , A.SGA_COST        AS "sgaCost"
              , A.TOTAL_ESTM_COST AS "totalEstmCost"
              , A.KD_RATE         AS "kdRate"
              , A.TAX_RATE        AS "taxRate"
              , A.DEBT_AMT        AS "debtAmt"
              , A.EQUITY_AMT      AS "equityAmt"
              , A.RF_RATE         AS "rfRate"
              , A.ERM_RATE        AS "ermRate"
              , A.BETA_VAL        AS "betaVal"
              , A.KE_RATE         AS "keRate"
              , A.WACC_RATE       AS "waccRate"
              , A.RMK             AS "rmk"
          FROM  PCM_EC_PROFIT A
         WHERE  A.TEN_ID    = #{g.tenant}
           AND  A.EC_PJT_CD = #{p.ecPjtCd}
    </select>

    <!-- ============================================================
         수익성 데이터 존재 여부 확인
         ============================================================ -->
    <select id="countEcProfit" parameterType="map" resultType="int">
        SELECT  COUNT(1)
          FROM  PCM_EC_PROFIT
         WHERE  TEN_ID    = #{g.tenant}
           AND  EC_PJT_CD = #{p.ecPjtCd}
    </select>

    <!-- ============================================================
         BOM 재료비 집계 (PCM_EC_BOM → 최상위 품목 MAT_COST 합계)
         ============================================================ -->
    <select id="aggregateMaterialCost" parameterType="map" resultType="java.math.BigDecimal">
        SELECT  COALESCE(SUM(B.MAT_COST), 0)
          FROM  PCM_EC_BOM B
         WHERE  B.TEN_ID    = #{g.tenant}
           AND  B.EC_PJT_CD = #{p.ecPjtCd}
           AND  (B.UP_ITEM_CD IS NULL OR B.UP_ITEM_CD = '')
    </select>

    <!-- ============================================================
         수익성 분석 데이터 신규 등록
         ============================================================ -->
    <insert id="insertEcProfit" parameterType="map">
        INSERT INTO PCM_EC_PROFIT (
            TEN_ID
          , EC_PJT_CD
          , MAT_COST
          , LABOR_COST
          , MFG_COST
          , SGA_COST
          , TOTAL_ESTM_COST
          , KD_RATE
          , TAX_RATE
          , DEBT_AMT
          , EQUITY_AMT
          , RF_RATE
          , ERM_RATE
          , BETA_VAL
          , KE_RATE
          , WACC_RATE
          , RMK
          , STS
          , REGR_ID
          , REG_DTTM
          , MODR_ID
          , MOD_DTTM
        ) VALUES (
            #{g.tenant}
          , #{p.ecPjtCd}
          , #{p.matCost}
          , #{p.laborCost}
          , #{p.mfgCost}
          , #{p.sgaCost}
          , #{p.totalEstmCost}
          , #{p.kdRate}
          , #{p.taxRate}
          , #{p.debtAmt}
          , #{p.equityAmt}
          , #{p.rfRate}
          , #{p.ermRate}
          , #{p.betaVal}
          , #{p.keRate}
          , #{p.waccRate}
          , #{p.rmk}
          , 'T'
          , #{g.username}
          , #{g.now}
          , #{g.username}
          , #{g.now}
        )
    </insert>

    <!-- ============================================================
         수익성 분석 데이터 수정
         ============================================================ -->
    <update id="updateEcProfit" parameterType="map">
        UPDATE  PCM_EC_PROFIT
           SET  MAT_COST        = #{p.matCost}
              , LABOR_COST      = #{p.laborCost}
              , MFG_COST        = #{p.mfgCost}
              , SGA_COST        = #{p.sgaCost}
              , TOTAL_ESTM_COST = #{p.totalEstmCost}
              , KD_RATE         = #{p.kdRate}
              , TAX_RATE        = #{p.taxRate}
              , DEBT_AMT        = #{p.debtAmt}
              , EQUITY_AMT      = #{p.equityAmt}
              , RF_RATE         = #{p.rfRate}
              , ERM_RATE        = #{p.ermRate}
              , BETA_VAL        = #{p.betaVal}
              , KE_RATE         = #{p.keRate}
              , WACC_RATE       = #{p.waccRate}
              , RMK             = #{p.rmk}
              , MODR_ID         = #{g.username}
              , MOD_DTTM        = #{g.now}
         WHERE  TEN_ID    = #{g.tenant}
           AND  EC_PJT_CD = #{p.ecPjtCd}
    </update>

</mapper>

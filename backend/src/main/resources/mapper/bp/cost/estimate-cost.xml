<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    견적원가 프로젝트 관리 Mapper
    테이블: PCM_EC_PJT_MSTR (견적원가 프로젝트 마스터)
-->
<mapper namespace="smartcost.app.bp.cost.estimatecost.EstimateCostRepository">

    <!-- ============================================================
         목록 조회
         ============================================================ -->
    <select id="findListEstimateCostPjt" parameterType="map" resultType="map">
        SELECT  A.TEN_ID        AS "tenId"
              , A.EC_PJT_CD     AS "pjtCd"
              , A.PJT_NM       AS "pjtNm"
              , A.BIZ_UNIT     AS "bizUnit"
              , A.CUST_NM      AS "custNm"
              , A.CAR_TYPE     AS "carType"
              , A.OEM_NM       AS "oemNm"
              , A.PROD_GRP     AS "prodGrp"
              , A.PROD_QTY     AS "prodQty"
              , A.SOP_DT       AS "sopDt"
              , A.BASE_CURRENCY AS "baseCurrency"
              , A.STS          AS "sts"
              , CASE A.STS
                    WHEN 'T' THEN '작성중'
                    WHEN 'P' THEN '진행중'
                    WHEN 'A' THEN '확정'
                    WHEN 'R' THEN '탈락'
                    WHEN 'C' THEN '완료'
                    ELSE ''
                END            AS "stsNm"
              , TO_CHAR(A.REG_DTTM, 'YYYY-MM-DD') AS "regDttm"
              , A.RMK          AS "rmk"
          FROM  PCM_EC_PJT_MSTR A
         WHERE  A.TEN_ID = #{g.tenant}
        <if test="p.pjtCd != null and p.pjtCd != ''">
           AND  A.EC_PJT_CD LIKE '%' || TRIM(#{p.pjtCd}) || '%'
        </if>
        <if test="p.bizUnit != null and p.bizUnit != ''">
           AND  A.BIZ_UNIT = #{p.bizUnit}
        </if>
        <if test="p.custNm != null and p.custNm != ''">
           AND  A.CUST_NM LIKE '%' || TRIM(#{p.custNm}) || '%'
        </if>
        <if test="p.carType != null and p.carType != ''">
           AND  A.CAR_TYPE LIKE '%' || TRIM(#{p.carType}) || '%'
        </if>
         ORDER BY A.REG_DTTM DESC
    </select>

    <!-- ============================================================
         프로젝트 코드 자동 채번
         형식: EC + 연도(4) + 일련번호(4)  예) EC20260001
         ============================================================ -->
    <select id="findNewEstimateCostPjtCd" resultType="string">
        SELECT  'EC' || TO_CHAR(CURRENT_DATE, 'YYYY')
                     || LPAD((COALESCE(MAX(CAST(SUBSTRING(A.EC_PJT_CD FROM 7) AS INTEGER)), 0) + 1)::TEXT, 4, '0')
          FROM  PCM_EC_PJT_MSTR A
         WHERE  A.TEN_ID = #{g.tenant}
           AND  A.EC_PJT_CD LIKE 'EC' || TO_CHAR(CURRENT_DATE, 'YYYY') || '%'
    </select>

    <!-- ============================================================
         신규 등록
         ============================================================ -->
    <insert id="insertEstimateCostPjt" parameterType="map">
        INSERT INTO PCM_EC_PJT_MSTR (
            TEN_ID
          , EC_PJT_CD
          , PJT_NM
          , BIZ_UNIT
          , CUST_NM
          , CAR_TYPE
          , OEM_NM
          , PROD_GRP
          , PROD_QTY
          , SOP_DT
          , BASE_CURRENCY
          , RMK
          , STS
          , REGR_ID
          , REG_DTTM
          , MODR_ID
          , MOD_DTTM
        ) VALUES (
            #{g.tenant}
          , #{p.pjtCd}
          , #{p.pjtNm}
          , #{p.bizUnit}
          , #{p.custNm}
          , #{p.carType}
          , #{p.oemNm}
          , #{p.prodGrp}
          , #{p.prodQty}
          , #{p.sopDt}
          , #{p.baseCurrency}
          , #{p.rmk}
          , #{p.sts}
          , #{g.username}
          , #{g.now}
          , #{g.username}
          , #{g.now}
        )
    </insert>

    <!-- ============================================================
         수정
         ============================================================ -->
    <update id="updateEstimateCostPjt" parameterType="map">
        UPDATE  PCM_EC_PJT_MSTR
           SET  PJT_NM    = #{p.pjtNm}
              , BIZ_UNIT  = #{p.bizUnit}
              , CUST_NM   = #{p.custNm}
              , CAR_TYPE  = #{p.carType}
              , OEM_NM    = #{p.oemNm}
              , PROD_GRP  = #{p.prodGrp}
              , PROD_QTY  = #{p.prodQty}
              , SOP_DT    = #{p.sopDt}
              , BASE_CURRENCY = #{p.baseCurrency}
              , RMK       = #{p.rmk}
              , MODR_ID   = #{g.username}
              , MOD_DTTM  = #{g.now}
         WHERE  TEN_ID     = #{g.tenant}
           AND  EC_PJT_CD  = #{p.pjtCd}
    </update>

    <!-- ============================================================
         삭제
         ============================================================ -->
    <delete id="deleteEstimateCostPjt" parameterType="map">
        DELETE FROM PCM_EC_PJT_MSTR
         WHERE  TEN_ID     = #{g.tenant}
           AND  EC_PJT_CD  = #{p.pjtCd}
    </delete>

</mapper>

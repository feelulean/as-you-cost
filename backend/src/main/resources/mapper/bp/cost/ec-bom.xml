<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    견적BOM 관리 Mapper
    테이블: PCM_EC_BOM (견적BOM)
    계층형 쿼리: PostgreSQL WITH RECURSIVE CTE
-->
<mapper namespace="smartcost.app.bp.cost.ecbom.EcBomRepository">

    <!-- ============================================================
         BOM 목록 조회 (계층 정렬 — WITH RECURSIVE)
         - 최상위(root)부터 재귀 탐색하여 DFS(깊이우선) 순서로 반환
         - path 컬럼으로 트리 순서를 보장
         ============================================================ -->
    <select id="findListEcBom" parameterType="map" resultType="map">
        WITH RECURSIVE bom_tree AS (
            -- Anchor: 최상위 품목 (UP_ITEM_CD IS NULL 또는 빈 문자열)
            SELECT  B.TEN_ID        AS tenId
                  , B.EC_PJT_CD     AS ecPjtCd
                  , B.COST_CD       AS costCd
                  , B.ITEM_CD       AS itemCd
                  , B.UP_ITEM_CD    AS upItemCd
                  , B.LVL           AS lvl
                  , B.ITEM_NM       AS itemNm
                  , B.SPEC          AS spec
                  , B.QTY           AS qty
                  , B.UNIT_PRICE    AS unitPrice
                  , B.MAT_COST      AS matCost
                  , B.NEW_PART_YN   AS newPartYn
                  , B.RMK           AS rmk
                  , ARRAY[B.ITEM_CD]::text[] AS path
              FROM  PCM_EC_BOM B
             WHERE  B.TEN_ID    = #{g.tenant}
               AND  B.EC_PJT_CD = #{p.ecPjtCd}
               AND  B.COST_CD   = #{p.costCd}
               AND  (B.UP_ITEM_CD IS NULL OR B.UP_ITEM_CD = '')

            UNION ALL

            -- Recursive: 자식 품목 탐색
            SELECT  C.TEN_ID        AS tenId
                  , C.EC_PJT_CD     AS ecPjtCd
                  , C.COST_CD       AS costCd
                  , C.ITEM_CD       AS itemCd
                  , C.UP_ITEM_CD    AS upItemCd
                  , C.LVL           AS lvl
                  , C.ITEM_NM       AS itemNm
                  , C.SPEC          AS spec
                  , C.QTY           AS qty
                  , C.UNIT_PRICE    AS unitPrice
                  , C.MAT_COST      AS matCost
                  , C.NEW_PART_YN   AS newPartYn
                  , C.RMK           AS rmk
                  , T.path || C.ITEM_CD AS path
              FROM  PCM_EC_BOM C
             INNER  JOIN bom_tree T
                ON  C.TEN_ID     = T.tenId
               AND  C.EC_PJT_CD  = T.ecPjtCd
               AND  C.COST_CD    = T.costCd
               AND  C.UP_ITEM_CD = T.itemCd
        )
        SELECT  tenId AS "tenId", ecPjtCd AS "ecPjtCd", costCd AS "costCd"
              , itemCd AS "itemCd"
              , upItemCd AS "upItemCd", lvl AS "lvl"
              , itemNm AS "itemNm", spec AS "spec", qty AS "qty"
              , unitPrice AS "unitPrice", matCost AS "matCost"
              , newPartYn AS "newPartYn", rmk AS "rmk"
          FROM  bom_tree
         ORDER BY path
    </select>

    <!-- ============================================================
         신규 등록 (단건)
         ============================================================ -->
    <insert id="insertEcBom" parameterType="map">
        INSERT INTO PCM_EC_BOM (
            TEN_ID
          , EC_PJT_CD
          , COST_CD
          , ITEM_CD
          , UP_ITEM_CD
          , LVL
          , ITEM_NM
          , SPEC
          , QTY
          , UNIT_PRICE
          , MAT_COST
          , NEW_PART_YN
          , RMK
          , STS
          , REGR_ID
          , REG_DTTM
          , MODR_ID
          , MOD_DTTM
        ) VALUES (
            #{g.tenant}
          , #{p.ecPjtCd}
          , #{p.costCd}
          , #{p.itemCd}
          , #{p.upItemCd}
          , #{p.lvl}
          , #{p.itemNm}
          , #{p.spec}
          , #{p.qty}
          , #{p.unitPrice}
          , #{p.matCost}
          , #{p.newPartYn}
          , #{p.rmk}
          , 'T'
          , #{g.username}
          , #{g.now}
          , #{g.username}
          , #{g.now}
        )
    </insert>

    <!-- ============================================================
         프로젝트 기준 BOM 전체 삭제 (Delete-Insert 저장 용)
         ============================================================ -->
    <delete id="deleteEcBomByPjt" parameterType="map">
        DELETE FROM PCM_EC_BOM
         WHERE  TEN_ID     = #{g.tenant}
           AND  EC_PJT_CD  = #{p.ecPjtCd}
           AND  COST_CD    = #{p.costCd}
    </delete>

    <!-- ============================================================
         선택 품목 + 하위 품목 재귀 삭제
         - WITH RECURSIVE로 해당 품목의 모든 자손을 찾아 삭제
         ============================================================ -->
    <delete id="deleteEcBomWithChildren" parameterType="map">
        DELETE FROM PCM_EC_BOM
         WHERE  TEN_ID    = #{g.tenant}
           AND  EC_PJT_CD = #{p.ecPjtCd}
           AND  COST_CD   = #{p.costCd}
           AND  ITEM_CD IN (
                WITH RECURSIVE del_tree AS (
                    SELECT ITEM_CD
                      FROM PCM_EC_BOM
                     WHERE TEN_ID    = #{g.tenant}
                       AND EC_PJT_CD = #{p.ecPjtCd}
                       AND COST_CD   = #{p.costCd}
                       AND ITEM_CD   = #{p.itemCd}

                    UNION ALL

                    SELECT C.ITEM_CD
                      FROM PCM_EC_BOM C
                     INNER JOIN del_tree D ON C.UP_ITEM_CD = D.ITEM_CD
                     WHERE C.TEN_ID    = #{g.tenant}
                       AND C.EC_PJT_CD = #{p.ecPjtCd}
                       AND C.COST_CD   = #{p.costCd}
                )
                SELECT ITEM_CD FROM del_tree
           )
    </delete>

    <!-- ============================================================
         모든 부품의 개별 재료비 갱신 (QTY × UNIT_PRICE)
         ============================================================ -->
    <update id="updateAllMatCost" parameterType="map">
        UPDATE  PCM_EC_BOM
           SET  MAT_COST = QTY * UNIT_PRICE
              , MODR_ID  = #{g.username}
              , MOD_DTTM = #{g.now}
         WHERE  TEN_ID    = #{g.tenant}
           AND  EC_PJT_CD = #{p.ecPjtCd}
           AND  COST_CD   = #{p.costCd}
    </update>

    <!-- ============================================================
         상위 품목에 하위 재료비 합계 누적
         - 자식 품목의 MAT_COST 합계를 부모의 MAT_COST에 추가
         ============================================================ -->
    <update id="updateParentMatCost" parameterType="map">
        UPDATE  PCM_EC_BOM P
           SET  MAT_COST = P.QTY * P.UNIT_PRICE
                         + COALESCE((
                             SELECT SUM(C.MAT_COST)
                               FROM PCM_EC_BOM C
                              WHERE C.TEN_ID     = P.TEN_ID
                                AND C.EC_PJT_CD  = P.EC_PJT_CD
                                AND C.COST_CD    = P.COST_CD
                                AND C.UP_ITEM_CD = P.ITEM_CD
                           ), 0)
              , MODR_ID  = #{g.username}
              , MOD_DTTM = #{g.now}
         WHERE  P.TEN_ID    = #{g.tenant}
           AND  P.EC_PJT_CD = #{p.ecPjtCd}
           AND  P.COST_CD   = #{p.costCd}
           AND  EXISTS (
                SELECT 1 FROM PCM_EC_BOM C2
                 WHERE C2.TEN_ID     = P.TEN_ID
                   AND C2.EC_PJT_CD  = P.EC_PJT_CD
                   AND C2.COST_CD    = P.COST_CD
                   AND C2.UP_ITEM_CD = P.ITEM_CD
           )
    </update>

    <!-- ============================================================
         총 재료비 조회 (최상위 품목 합계)
         ============================================================ -->
    <select id="findTotalMatCost" parameterType="map" resultType="java.math.BigDecimal">
        SELECT  COALESCE(SUM(B.MAT_COST), 0)
          FROM  PCM_EC_BOM B
         WHERE  B.TEN_ID    = #{g.tenant}
           AND  B.EC_PJT_CD = #{p.ecPjtCd}
           AND  B.COST_CD   = #{p.costCd}
           AND  (B.UP_ITEM_CD IS NULL OR B.UP_ITEM_CD = '')
    </select>

    <!-- ============================================================
         기존단가 일괄 업데이트 (I/F — Batch Update)
         - 품목별 단가(UNIT_PRICE) 갱신 + 재료비(MAT_COST) 재산출
         - PostgreSQL UPDATE ... FROM VALUES 구문 활용
         ============================================================ -->
    <update id="updateBatchEcBomPrice" parameterType="map">
        UPDATE  PCM_EC_BOM AS B
           SET  UNIT_PRICE = V.new_price
              , MAT_COST   = B.QTY * V.new_price
              , MODR_ID    = #{g.username}
              , MOD_DTTM   = #{g.now}
          FROM  (VALUES
                <foreach collection="p.priceList" item="row" separator=",">
                    (#{row.itemCd}, CAST(#{row.unitPrice} AS BIGINT))
                </foreach>
                ) AS V (item_cd, new_price)
         WHERE  B.TEN_ID    = #{g.tenant}
           AND  B.EC_PJT_CD = #{p.ecPjtCd}
           AND  B.COST_CD   = #{p.costCd}
           AND  B.ITEM_CD   = V.item_cd
    </update>

</mapper>

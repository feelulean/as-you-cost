<dom-module id="es-npv-analysis">
    <template>
        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/ec/findListEstimateCostPjt.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <sc-ajax id="findNpvAjax"
                 url="/bp/cost/ec/detail/findListNpv.do"
                 body="{{npvSearchParam}}"
                 on-response="onFindNpvResponse">
        </sc-ajax>

        <sc-ajax id="calculateNpvAjax"
                 url="/bp/cost/ec/detail/calculateNpv.do"
                 body="{{calcParam}}"
                 on-response="onCalculateNpvResponse">
        </sc-ajax>

        <sc-ajax id="saveNpvAjax"
                 url="/bp/cost/ec/detail/saveNpv.do"
                 body="{{saveParam}}"
                 on-response="onSaveNpvResponse">
        </sc-ajax>

        <style>
            .tab-btn { padding:6px 14px; border:none; background:#f0f1f5; cursor:pointer; font-size:12px; border-radius:4px 4px 0 0; }
            .tab-btn.active { background:#6954FE; color:#fff; font-weight:600; }
            .form-table { width:100%; border-collapse:collapse; }
            .form-table th { padding:8px 12px; background:#f8f9fc; text-align:left; font-weight:600; font-size:12px; width:140px; border:1px solid #e0e0e0; }
            .form-table td { padding:6px 12px; border:1px solid #e0e0e0; }
            .section-title { font-size:14px; font-weight:700; color:#30374F; padding:10px 0 8px; border-bottom:2px solid #6954FE; margin-bottom:8px; }
            .result-row { display:flex; gap:16px; margin-bottom:8px; }
            .result-item { flex:1; background:#f8f9fc; padding:12px; border-radius:6px; border:1px solid #e0e0e0; }
            .result-item label { font-size:11px; color:#667085; display:block; margin-bottom:4px; }
            .result-item .value { font-size:18px; font-weight:700; color:#30374F; }
            .wacc-display { display:flex; align-items:center; gap:8px; padding:8px 12px; background:#f0f1f5; border-radius:6px; margin-bottom:8px; }
            .wacc-display .wacc-label { font-size:12px; color:#667085; font-weight:600; }
            .wacc-display .wacc-value { font-size:16px; color:#6954FE; font-weight:700; }
        </style>

        <!-- ============================================================
             조회 조건 영역
             ============================================================ -->
        <sc-search-container on-search="onFindList" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트 코드"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.pjtCd}}" on-enter="onFindList"></sc-text-field>
                    </td>
                    <th><sc-label text="사업부"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.bizUnit}}"
                                          items="{{codes.bizUnitList}}"
                                          display-field="label"
                                          value-field="data"
                                          placeholder="전체">
                        </sc-combobox-field>
                    </td>
                    <th><sc-label text="고객사"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.custNm}}"></sc-text-field>
                    </td>
                </tr>
            </table>
        </sc-search-container>

        <!-- ============================================================
             좌우 Split 레이아웃
             ============================================================ -->
        <div class="hbox flex">
            <!-- ========== 좌측: 프로젝트 목록 그리드 (flex-3) ========== -->
            <sc-grid id="gridPanel"
                     data-provider="{{resultList}}"
                     on-item-click="onProjectClick"
                     class="flex-3"
                     use-state="false">

                <sc-grid-columns>
                    <sc-data-column data-field="pjtCd"
                                    header-text="프로젝트 코드"
                                    width="130"
                                    text-align="center"
                                    on-item-click="onProjectClick">
                    </sc-data-column>

                    <sc-data-column data-field="pjtNm"
                                    header-text="프로젝트명"
                                    width="180"
                                    text-align="left">
                    </sc-data-column>

                    <sc-data-column data-field="bizUnit"
                                    header-text="사업부"
                                    width="80"
                                    text-align="center">
                    </sc-data-column>

                    <sc-data-column data-field="estmSeqNo"
                                    header-text="견적차수"
                                    width="80"
                                    text-align="center">
                    </sc-data-column>

                    <sc-data-column data-field="sensitivitySeqNo"
                                    header-text="민감도차수"
                                    width="80"
                                    text-align="center">
                    </sc-data-column>
                </sc-grid-columns>
            </sc-grid>

            <div class="hspace-10"></div>

            <!-- ========== 우측: NPV 분석 상세 (flex-7) ========== -->
            <div class="vbox flex-7">
                <sc-toolbar>
                    <sc-button text="계산"           on-click="onCalculateNpv"  auth-code="S"></sc-button>
                    <sc-button text="조회"           on-click="onFindNpv"       auth-code="V"></sc-button>
                    <sc-button text="저장"           on-click="onSaveNpv"       auth-code="S"></sc-button>
                    <sc-button text="저장값 불러오기" on-click="onLoadSavedNpv"  auth-code="V"></sc-button>
                    <sc-button text="닫기"           on-click="onClose"         auth-code="V"></sc-button>
                </sc-toolbar>

                <!-- 프로젝트 기본 정보 -->
                <sc-panel title-text="프로젝트 기본 정보" collapsible="true">
                    <table class="form-table">
                        <colgroup>
                            <col style="width:120px"/><col/>
                            <col style="width:120px"/><col/>
                        </colgroup>
                        <tr>
                            <th><sc-label text="프로젝트명"></sc-label></th>
                            <td>
                                <sc-text-field value="{{pjtInfo.pjtNm}}" readonly="true"></sc-text-field>
                            </td>
                            <th><sc-label text="사업부"></sc-label></th>
                            <td>
                                <sc-text-field value="{{pjtInfo.bizUnit}}" readonly="true"></sc-text-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="고객사"></sc-label></th>
                            <td>
                                <sc-text-field value="{{pjtInfo.custNm}}" readonly="true"></sc-text-field>
                            </td>
                            <th><sc-label text="차종"></sc-label></th>
                            <td>
                                <sc-text-field value="{{pjtInfo.carType}}" readonly="true"></sc-text-field>
                            </td>
                        </tr>
                    </table>
                </sc-panel>

                <!-- WACC Rate 표시 -->
                <div class="wacc-display">
                    <span class="wacc-label">WACC Rate (할인율) :</span>
                    <span class="wacc-value">{{npvData.waccRate}}%</span>
                </div>

                <!-- NPV 분석 결과 카드 -->
                <div class="section-title">NPV 분석 결과</div>
                <div class="result-row">
                    <div class="result-item">
                        <label>NPV (순현재가치)</label>
                        <div class="value">{{npvData.npvValue}}</div>
                    </div>
                    <div class="result-item">
                        <label>IRR (내부수익률)</label>
                        <div class="value">{{npvData.irrValue}}%</div>
                    </div>
                    <div class="result-item">
                        <label>Payback Period (회수기간)</label>
                        <div class="value">{{npvData.paybackPeriod}}년</div>
                    </div>
                    <div class="result-item">
                        <label>PI (수익성지수)</label>
                        <div class="value">{{npvData.piValue}}</div>
                    </div>
                </div>

                <!-- Cash Flow 그리드 -->
                <sc-panel title-text="Cash Flow 분석표 (단위: {{baseCurrency}})" class="flex">
                    <sc-grid id="cashFlowGrid"
                             data-provider="{{cashFlowList}}"
                             editable="false"
                             class="flex">

                        <sc-grid-columns>
                            <sc-data-column data-field="yearNm"
                                            header-text="연도"
                                            width="80"
                                            text-align="center">
                            </sc-data-column>

                            <sc-data-column data-field="investAmt"
                                            header-text="투자비"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="operProfit"
                                            header-text="영업이익"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="depreciation"
                                            header-text="감가상각비"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="taxAmt"
                                            header-text="세금"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="freeCashFlow"
                                            header-text="Free Cash Flow"
                                            width="140"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="discountRate"
                                            header-text="할인율"
                                            width="100"
                                            text-align="right"
                                            data-type="number"
                                            format="#,##0.00">
                            </sc-data-column>

                            <sc-data-column data-field="presentValue"
                                            header-text="현재가치"
                                            width="140"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>
                        </sc-grid-columns>
                    </sc-grid>
                </sc-panel>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'es-npv-analysis',

            properties: {
                // 조회 조건 파라미터
                searchParam: {
                    type: Object,
                    value: function() { return {}; }
                },
                // 좌측 프로젝트 그리드 데이터
                resultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // 선택된 프로젝트 코드
                selectedPjtCd: {
                    type: String,
                    value: ''
                },
                // 기준통화
                baseCurrency: {
                    type: String,
                    value: 'KRW'
                },
                // 프로젝트 기본 정보
                pjtInfo: {
                    type: Object,
                    value: function() { return {}; }
                },
                // NPV 분석 결과 데이터
                npvData: {
                    type: Object,
                    value: function() {
                        return {
                            waccRate:      0,
                            npvValue:      0,
                            irrValue:      0,
                            paybackPeriod: 0,
                            piValue:       0
                        };
                    }
                },
                // Cash Flow 그리드 데이터
                cashFlowList: {
                    type: Array,
                    value: function() { return []; }
                },
                // Ajax 파라미터
                npvSearchParam: { type: Object, value: function() { return {}; } },
                calcParam:      { type: Object, value: function() { return {}; } },
                saveParam:      { type: Object, value: function() { return {}; } },
                // 공통코드 (DB 조회)
                codes: {
                    type: Object,
                    value: function() { return {}; }
                }
            },

            attached: function() {
                var me = this;
                UT.loadCodes({ bizUnitList: 'T004' }, function(codes) { me.set('codes', codes); });
                this.onFindList();
            },

            /* ==============================================================
               프로젝트 목록 조회 (좌측 그리드)
               ============================================================== */

            onFindList: function() {
                this._clearDetail();
                this.$.findListAjax.generateRequest();
            },

            onFindListResponse: function(e) {
                this.set('resultList', e.detail.response);
            },

            /* ==============================================================
               프로젝트 선택 → 우측 NPV 데이터 로드
               ============================================================== */

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row || !row.pjtCd) return;

                this.set('selectedPjtCd', row.pjtCd);
                this.set('baseCurrency', row.baseCurrency || 'KRW');
                this.set('pjtInfo', {
                    pjtCd:   row.pjtCd,
                    pjtNm:   row.pjtNm   || '',
                    bizUnit: row.bizUnit  || '',
                    custNm:  row.custNm   || '',
                    carType: row.carType  || ''
                });

                // NPV 데이터 조회
                this.set('npvSearchParam', { ecPjtCd: row.pjtCd });
                this.$.findNpvAjax.generateRequest();
            },

            /* ==============================================================
               NPV 데이터 조회
               ============================================================== */

            onFindNpv: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                this.set('npvSearchParam', { ecPjtCd: this.selectedPjtCd });
                this.$.findNpvAjax.generateRequest();
            },

            onFindNpvResponse: function(e) {
                var data = e.detail.response;
                if (data) {
                    // NPV 결과 데이터 바인딩
                    if (data.npvData) {
                        this.set('npvData', data.npvData);
                    } else {
                        this.set('npvData', {
                            waccRate:      0,
                            npvValue:      0,
                            irrValue:      0,
                            paybackPeriod: 0,
                            piValue:       0
                        });
                    }
                    // Cash Flow 그리드 바인딩
                    if (data.cashFlowList) {
                        this.set('cashFlowList', data.cashFlowList);
                    } else {
                        this.set('cashFlowList', this._getDefaultCashFlowList());
                    }
                }
            },

            /**
             * Cash Flow 기본 구조 (7년 + Total)
             */
            _getDefaultCashFlowList: function() {
                var list = [];
                for (var i = 1; i <= 7; i++) {
                    list.push({
                        yearNm:        'Y+' + i,
                        investAmt:     0,
                        operProfit:    0,
                        depreciation:  0,
                        taxAmt:        0,
                        freeCashFlow:  0,
                        discountRate:  0,
                        presentValue:  0
                    });
                }
                list.push({
                    yearNm:        'Total',
                    investAmt:     0,
                    operProfit:    0,
                    depreciation:  0,
                    taxAmt:        0,
                    freeCashFlow:  0,
                    discountRate:  0,
                    presentValue:  0
                });
                return list;
            },

            /* ==============================================================
               NPV 계산
               ============================================================== */

            onCalculateNpv: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                var me = this;
                UT.confirm('NPV 수익성 분석을 실행하시겠습니까?', function() {
                    me.set('calcParam', { ecPjtCd: me.selectedPjtCd });
                    me.$.calculateNpvAjax.generateRequest();
                });
            },

            onCalculateNpvResponse: function(e) {
                var data = e.detail.response;
                if (data) {
                    if (data.npvData) {
                        this.set('npvData', data.npvData);
                    }
                    if (data.cashFlowList) {
                        this.set('cashFlowList', data.cashFlowList);
                    }
                }
                UT.alert('NPV 수익성 분석이 완료되었습니다.');
            },

            /* ==============================================================
               저장
               ============================================================== */

            onSaveNpv: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                if (!this.npvData || (!this.npvData.npvValue && this.npvData.npvValue !== 0)) {
                    UT.alert('먼저 NPV 계산을 수행해 주세요.');
                    return;
                }

                var me = this;
                UT.confirm('MSG_COM_00002', function() { // 저장하시겠습니까?
                    me.set('saveParam', {
                        ecPjtCd:      me.selectedPjtCd,
                        npvData:      me.npvData,
                        cashFlowList: me.cashFlowList
                    });
                    me.$.saveNpvAjax.generateRequest();
                });
            },

            onSaveNpvResponse: function() {
                UT.alert('MSG_COM_00003'); // 저장되었습니다.
            },

            /* ==============================================================
               저장값 불러오기
               ============================================================== */

            onLoadSavedNpv: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                this.set('npvSearchParam', {
                    ecPjtCd:  this.selectedPjtCd,
                    loadSaved: 'Y'
                });
                this.$.findNpvAjax.generateRequest();
            },

            /* ==============================================================
               닫기
               ============================================================== */

            onClose: function() {
                // 이전 화면으로 이동 또는 탭 닫기
                UT.close();
            },

            _clearDetail: function() {
                this.set('selectedPjtCd', '');
                this.set('baseCurrency', 'KRW');
                this.set('pjtInfo', {});
                this.set('npvData', {
                    waccRate: 0, npvValue: 0, irrValue: 0,
                    paybackPeriod: 0, piValue: 0
                });
                this.set('cashFlowList', []);
            }
        });
    </script>
</dom-module>

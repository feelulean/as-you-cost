<dom-module id="es-sensitivity">
    <template>
        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/ec/findListEstimateCostPjt.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <sc-ajax id="findSensitivityAjax"
                 url="/bp/cost/ec/detail/findListSensitivity.do"
                 body="{{sensitivitySearchParam}}"
                 on-response="onFindSensitivityResponse">
        </sc-ajax>

        <sc-ajax id="saveSensitivityAjax"
                 url="/bp/cost/ec/detail/saveSensitivity.do"
                 body="{{saveSensitivityParam}}"
                 on-response="onSaveSensitivityResponse">
        </sc-ajax>

        <sc-ajax id="findVarListAjax"
                 url="/bp/cost/ec/detail/findListSensitivityVar.do"
                 body="{{varSearchParam}}"
                 on-response="onFindVarListResponse">
        </sc-ajax>

        <sc-ajax id="saveVarListAjax"
                 url="/bp/cost/ec/detail/saveSensitivityVar.do"
                 body="{{saveVarParam}}"
                 on-response="onSaveVarListResponse">
        </sc-ajax>

        <style>
            .tab-btn { padding:6px 14px; border:none; background:#f0f1f5; cursor:pointer; font-size:12px; border-radius:4px 4px 0 0; }
            .tab-btn.active { background:#6954FE; color:#fff; font-weight:600; }
            .form-table { width:100%; border-collapse:collapse; }
            .form-table th { padding:8px 12px; background:#f8f9fc; text-align:left; font-weight:600; font-size:12px; width:140px; border:1px solid #e0e0e0; }
            .form-table td { padding:6px 12px; border:1px solid #e0e0e0; }
            .section-title { font-size:14px; font-weight:700; color:#30374F; padding:10px 0 8px; border-bottom:2px solid #6954FE; margin-bottom:8px; }
            .result-row { display:flex; gap:16px; margin-bottom:8px; }
            .result-item { flex:1; background:#f8f9fc; padding:12px; border-radius:6px; border:1px solid #e0e0e0; }
            .result-item label { font-size:11px; color:#667085; display:block; margin-bottom:4px; }
            .result-item .value { font-size:18px; font-weight:700; color:#30374F; }
        </style>

        <!-- ============================================================
             조회 조건 영역
             ============================================================ -->
        <sc-search-container on-search="onFindList" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트 코드"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.pjtCd}}" on-enter="onFindList"></sc-text-field>
                    </td>
                    <th><sc-label text="사업부"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.bizUnit}}"
                                          items="{{codes.bizUnitList}}"
                                          display-field="label"
                                          value-field="data"
                                          placeholder="전체">
                        </sc-combobox-field>
                    </td>
                    <th><sc-label text="고객사"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.custNm}}"></sc-text-field>
                    </td>
                </tr>
            </table>
        </sc-search-container>

        <!-- ============================================================
             좌우 Split 레이아웃
             ============================================================ -->
        <div class="hbox flex">
            <!-- ========== 좌측: 프로젝트 목록 + 민감도 차수 (flex-4) ========== -->
            <div class="vbox flex-4">
                <!-- 프로젝트 목록 그리드 -->
                <sc-grid id="gridPanel"
                         data-provider="{{resultList}}"
                         on-item-click="onProjectClick"
                         class="flex-5"
                         use-state="false">

                    <sc-grid-columns>
                        <sc-data-column data-field="pjtCd"
                                        header-text="프로젝트 코드"
                                        width="130"
                                        text-align="center">
                        </sc-data-column>

                        <sc-data-column data-field="pjtNm"
                                        header-text="프로젝트명"
                                        width="200"
                                        text-align="left">
                        </sc-data-column>

                        <sc-data-column data-field="bizUnit"
                                        header-text="사업부"
                                        width="100"
                                        text-align="center">
                        </sc-data-column>

                        <sc-data-column data-field="stsNm"
                                        header-text="상태"
                                        width="80"
                                        text-align="center">
                        </sc-data-column>
                    </sc-grid-columns>
                </sc-grid>

                <div class="vspace-10"></div>

                <!-- 민감도분석 차수 목록 그리드 -->
                <sc-grid id="versionGrid"
                         data-provider="{{sensitivityVersionList}}"
                         on-item-click="onVersionClick"
                         class="flex-5"
                         use-state="false">

                    <sc-toolbar>
                        <sc-button text="신규" on-click="onAddVersion"  auth-code="S"></sc-button>
                        <sc-button text="수정" on-click="onEditVersion" auth-code="S"></sc-button>
                    </sc-toolbar>

                    <sc-grid-columns>
                        <sc-data-column data-field="seqNo"
                                        header-text="차수"
                                        width="60"
                                        text-align="center">
                        </sc-data-column>

                        <sc-data-column data-field="analysisNm"
                                        header-text="분석명"
                                        width="180"
                                        text-align="left">
                        </sc-data-column>

                        <sc-data-column data-field="completeYn"
                                        header-text="종료여부"
                                        width="80"
                                        text-align="center">
                        </sc-data-column>

                        <sc-data-column data-field="modDttm"
                                        header-text="변경일자"
                                        width="100"
                                        text-align="center">
                        </sc-data-column>
                    </sc-grid-columns>
                </sc-grid>
            </div>

            <div class="hspace-10"></div>

            <!-- ========== 우측: 민감도 분석 상세 (flex-6) ========== -->
            <div class="vbox flex-6">
                <!-- 프로젝트 기본 정보 -->
                <sc-panel title-text="프로젝트 기본 정보" collapsible="true">
                    <table class="form-table">
                        <colgroup>
                            <col style="width:120px"/><col/>
                            <col style="width:120px"/><col/>
                        </colgroup>
                        <tr>
                            <th><sc-label text="프로젝트 코드"></sc-label></th>
                            <td>
                                <sc-text-field value="{{pjtInfo.pjtCd}}" readonly="true"></sc-text-field>
                            </td>
                            <th><sc-label text="프로젝트명"></sc-label></th>
                            <td>
                                <sc-text-field value="{{pjtInfo.pjtNm}}" readonly="true"></sc-text-field>
                            </td>
                        </tr>
                    </table>
                </sc-panel>

                <!-- 민감도 변수 등록 -->
                <sc-panel title-text="민감도 변수 등록" class="flex-5">
                    <sc-grid id="varGrid"
                             data-provider="{{varList}}"
                             editable="true"
                             class="flex">

                        <sc-toolbar>
                            <sc-button text="추가"       on-click="onAddVar"        auth-code="S"></sc-button>
                            <sc-button text="삭제"       on-click="onDeleteVar"     auth-code="S"></sc-button>
                            <span class="vt-seperator"></span>
                            <sc-button text="임시저장"   on-click="onSaveVar"       auth-code="S"></sc-button>
                            <sc-button text="민감도 계산" on-click="onCalculate"     auth-code="S"></sc-button>
                            <sc-button text="산출종료"   on-click="onComplete"      auth-code="S"></sc-button>
                        </sc-toolbar>

                        <sc-grid-columns>
                            <sc-combobox-column data-field="varType"
                                               header-text="변수유형"
                                               width="120"
                                               editable="true"
                                               items="{{codes.varTypeList}}"
                                               display-field="label"
                                               value-field="data"
                                               required="true">
                            </sc-combobox-column>

                            <sc-data-column data-field="varNm"
                                            header-text="변수명"
                                            width="160"
                                            text-align="left"
                                            editable="true"
                                            required="true">
                            </sc-data-column>

                            <sc-data-column data-field="beforeVal"
                                            header-text="변경전"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt"
                                            editable="true">
                            </sc-data-column>

                            <sc-data-column data-field="afterVal"
                                            header-text="변경후"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt"
                                            editable="true">
                            </sc-data-column>
                        </sc-grid-columns>
                    </sc-grid>
                </sc-panel>

                <!-- 민감도 분석 결과 -->
                <sc-panel title-text="민감도 분석 결과" class="flex-5">
                    <sc-grid id="sensitivityResultGrid"
                             data-provider="{{sensitivityResultList}}"
                             editable="false"
                             class="flex">

                        <sc-grid-columns>
                            <sc-data-column data-field="itemNm"
                                            header-text="항목"
                                            width="120"
                                            text-align="left">
                            </sc-data-column>

                            <sc-data-column data-field="beforeSopAmt"
                                            header-text="변경전(양산첫해)"
                                            width="140"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="beforeTotalAmt"
                                            header-text="변경전(TOTAL)"
                                            width="140"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="afterSopAmt"
                                            header-text="변경후(양산첫해)"
                                            width="140"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="afterTotalAmt"
                                            header-text="변경후(TOTAL)"
                                            width="140"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="diffAmt"
                                            header-text="차이"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>
                        </sc-grid-columns>
                    </sc-grid>
                </sc-panel>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'es-sensitivity',

            properties: {
                // 조회 조건 파라미터
                searchParam: {
                    type: Object,
                    value: function() { return {}; }
                },
                // 좌측 프로젝트 그리드 데이터
                resultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // 선택된 프로젝트 코드
                selectedPjtCd: {
                    type: String,
                    value: ''
                },
                // 프로젝트 기본 정보
                pjtInfo: {
                    type: Object,
                    value: function() { return {}; }
                },
                // 민감도분석 차수 목록
                sensitivityVersionList: {
                    type: Array,
                    value: function() { return []; }
                },
                // 선택된 차수 정보
                selectedVersion: {
                    type: Object,
                    value: function() { return {}; }
                },
                // 민감도 변수 목록
                varList: {
                    type: Array,
                    value: function() { return []; }
                },
                // 민감도 분석 결과
                sensitivityResultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // Ajax 파라미터
                sensitivitySearchParam: { type: Object, value: function() { return {}; } },
                saveSensitivityParam:   { type: Object, value: function() { return {}; } },
                varSearchParam:         { type: Object, value: function() { return {}; } },
                saveVarParam:           { type: Object, value: function() { return {}; } },
                // 공통코드
                codes: {
                    type: Object,
                    value: function() {
                        return {
                            bizUnitList: [
                                { label: 'PT',   data: 'PT' },
                                { label: 'SEAT', data: 'SEAT' }
                            ],
                            varTypeList: [
                                { label: '환율',   data: 'EXCH' },
                                { label: '수량',   data: 'QTY' },
                                { label: '판가',   data: 'PRICE' },
                                { label: '재료비', data: 'MAT' },
                                { label: 'TCI',    data: 'TCI' }
                            ]
                        };
                    }
                }
            },

            /* ==============================================================
               프로젝트 목록 조회 (좌측 상단 그리드)
               ============================================================== */

            onFindList: function() {
                this.$.findListAjax.generateRequest();
            },

            onFindListResponse: function(e) {
                this.set('resultList', e.detail.response);
            },

            /* ==============================================================
               프로젝트 선택 → 민감도 차수 목록 로드
               ============================================================== */

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row || !row.pjtCd) return;

                this.set('selectedPjtCd', row.pjtCd);
                this.set('pjtInfo', {
                    pjtCd: row.pjtCd,
                    pjtNm: row.pjtNm || ''
                });

                // 민감도 차수 목록 조회
                this.set('sensitivitySearchParam', { ecPjtCd: row.pjtCd });
                this.$.findSensitivityAjax.generateRequest();

                // 우측 초기화
                this.set('varList', []);
                this.set('sensitivityResultList', []);
                this.set('selectedVersion', {});
            },

            onFindSensitivityResponse: function(e) {
                var data = e.detail.response;
                if (data && data.versionList) {
                    this.set('sensitivityVersionList', data.versionList);
                } else {
                    this.set('sensitivityVersionList', []);
                }
            },

            /* ==============================================================
               민감도 차수 선택 → 변수 목록 + 결과 로드
               ============================================================== */

            onVersionClick: function(e) {
                var row = e.detail.data;
                if (!row || !row.seqNo) return;

                this.set('selectedVersion', row);
                this.set('varSearchParam', {
                    ecPjtCd: this.selectedPjtCd,
                    seqNo:   row.seqNo
                });
                this.$.findVarListAjax.generateRequest();
            },

            onFindVarListResponse: function(e) {
                var data = e.detail.response;
                if (data && data.varList) {
                    this.set('varList', data.varList);
                } else {
                    this.set('varList', []);
                }
                if (data && data.resultList) {
                    this.set('sensitivityResultList', data.resultList);
                } else {
                    this.set('sensitivityResultList', []);
                }
            },

            /* ==============================================================
               민감도 차수 신규/수정
               ============================================================== */

            onAddVersion: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                var versionGrid = this.$.versionGrid;
                versionGrid.insertRow(0, {
                    ecPjtCd:    this.selectedPjtCd,
                    seqNo:      '',
                    analysisNm: '',
                    completeYn: 'N',
                    modDttm:    ''
                });
            },

            onEditVersion: function() {
                if (!this.selectedVersion || !this.selectedVersion.seqNo) {
                    UT.alert('수정할 민감도분석 차수를 선택해 주세요.');
                    return;
                }
                if (this.selectedVersion.completeYn === 'Y') {
                    UT.alert('종료된 차수는 수정할 수 없습니다.');
                    return;
                }
                // 선택된 차수의 편집 모드 활성화는 그리드 셀 클릭으로 처리
                UT.alert('그리드에서 직접 분석명을 수정한 후 임시저장 해주세요.');
            },

            /* ==============================================================
               민감도 변수 추가/삭제
               ============================================================== */

            onAddVar: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                if (!this.selectedVersion || !this.selectedVersion.seqNo) {
                    UT.alert('민감도분석 차수를 선택해 주세요.');
                    return;
                }

                var varGrid = this.$.varGrid;
                varGrid.insertRow(0, {
                    ecPjtCd:   this.selectedPjtCd,
                    seqNo:     this.selectedVersion.seqNo,
                    varType:   '',
                    varNm:     '',
                    beforeVal: 0,
                    afterVal:  0
                });
            },

            onDeleteVar: function() {
                var varGrid = this.$.varGrid;
                var selectedRows = varGrid.getSelectedRows();

                if (!selectedRows || selectedRows.length === 0) {
                    UT.alert('MSG_COM_00007'); // 선택된 데이터가 없습니다.
                    return;
                }

                varGrid.removeRows(selectedRows);
            },

            /* ==============================================================
               임시저장 (변수 목록)
               ============================================================== */

            onSaveVar: function() {
                if (!this.selectedPjtCd || !this.selectedVersion.seqNo) {
                    UT.alert('프로젝트와 민감도분석 차수를 선택해 주세요.');
                    return;
                }

                var varGrid = this.$.varGrid;
                var allRows = varGrid.getAllRows();

                // 필수값 검증: 변수유형, 변수명
                for (var i = 0; i < allRows.length; i++) {
                    if (!allRows[i].varType || !allRows[i].varNm) {
                        UT.alert('MSG_COM_00001'); // 필수 입력값을 확인하세요.
                        return;
                    }
                }

                var me = this;
                UT.confirm('MSG_COM_00002', function() { // 저장하시겠습니까?
                    me.set('saveVarParam', {
                        ecPjtCd: me.selectedPjtCd,
                        seqNo:   me.selectedVersion.seqNo,
                        varList: allRows
                    });
                    me.$.saveVarListAjax.generateRequest();
                });
            },

            onSaveVarListResponse: function() {
                UT.alert('MSG_COM_00003'); // 저장되었습니다.
            },

            /* ==============================================================
               민감도 계산
               ============================================================== */

            onCalculate: function() {
                if (!this.selectedPjtCd || !this.selectedVersion.seqNo) {
                    UT.alert('프로젝트와 민감도분석 차수를 선택해 주세요.');
                    return;
                }

                var varGrid = this.$.varGrid;
                var allRows = varGrid.getAllRows();

                if (!allRows || allRows.length === 0) {
                    UT.alert('민감도 변수를 먼저 등록해 주세요.');
                    return;
                }

                var me = this;
                UT.confirm('민감도 분석을 실행하시겠습니까?', function() {
                    me.set('saveVarParam', {
                        ecPjtCd:    me.selectedPjtCd,
                        seqNo:      me.selectedVersion.seqNo,
                        varList:    allRows,
                        calculateYn: 'Y'
                    });
                    me.$.saveVarListAjax.generateRequest();
                });
            },

            /* ==============================================================
               산출종료
               ============================================================== */

            onComplete: function() {
                if (!this.selectedPjtCd || !this.selectedVersion.seqNo) {
                    UT.alert('프로젝트와 민감도분석 차수를 선택해 주세요.');
                    return;
                }

                if (!this.sensitivityResultList || this.sensitivityResultList.length === 0) {
                    UT.alert('먼저 민감도 계산을 수행해 주세요.');
                    return;
                }

                var me = this;
                UT.confirm('민감도 분석을 종료 처리하시겠습니까?\n종료 후에는 수정할 수 없습니다.', function() {
                    me.set('saveSensitivityParam', {
                        ecPjtCd:    me.selectedPjtCd,
                        seqNo:      me.selectedVersion.seqNo,
                        completeYn: 'Y'
                    });
                    me.$.saveSensitivityAjax.generateRequest();
                });
            },

            onSaveSensitivityResponse: function(e) {
                UT.alert('민감도 분석이 종료 처리되었습니다.');
                // 차수 목록 재조회
                this.set('sensitivitySearchParam', { ecPjtCd: this.selectedPjtCd });
                this.$.findSensitivityAjax.generateRequest();
            }
        });
    </script>
</dom-module>

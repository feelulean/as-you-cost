<dom-module id="es-sga-cost-calc">
    <template>
        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/ec/findListEstimateCostPjt.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <sc-ajax id="findSgaCostAjax"
                 url="/bp/cost/ec/detail/findListSgaCost.do"
                 body="{{sgaSearchParam}}"
                 on-response="onFindSgaCostResponse">
        </sc-ajax>

        <sc-ajax id="calculateSgaCostAjax"
                 url="/bp/cost/ec/detail/calculateSgaCost.do"
                 body="{{calcParam}}"
                 on-response="onCalculateSgaCostResponse">
        </sc-ajax>

        <style>
            .tab-btn { padding:6px 14px; border:none; background:#f0f1f5; cursor:pointer; font-size:12px; border-radius:4px 4px 0 0; }
            .tab-btn.active { background:#6954FE; color:#fff; font-weight:600; }
            .form-table { width:100%; border-collapse:collapse; }
            .form-table th { padding:8px 12px; background:#f8f9fc; text-align:left; font-weight:600; font-size:12px; width:140px; border:1px solid #e0e0e0; }
            .form-table td { padding:6px 12px; border:1px solid #e0e0e0; }
            .section-title { font-size:14px; font-weight:700; color:#30374F; padding:10px 0 8px; border-bottom:2px solid #6954FE; margin-bottom:8px; }
            .result-row { display:flex; gap:16px; margin-bottom:8px; }
            .result-item { flex:1; background:#f8f9fc; padding:12px; border-radius:6px; border:1px solid #e0e0e0; }
            .result-item label { font-size:11px; color:#667085; display:block; margin-bottom:4px; }
            .result-item .value { font-size:18px; font-weight:700; color:#30374F; }
        </style>

        <!-- ============================================================
             조회 조건 영역
             ============================================================ -->
        <sc-search-container on-search="onFindList" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트 코드"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.pjtCd}}" on-enter="onFindList"></sc-text-field>
                    </td>
                    <th><sc-label text="사업부"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.bizUnit}}"
                                          items="{{codes.bizUnitList}}"
                                          display-field="label"
                                          value-field="data"
                                          placeholder="전체">
                        </sc-combobox-field>
                    </td>
                    <th><sc-label text="고객사"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.custNm}}"></sc-text-field>
                    </td>
                </tr>
            </table>
        </sc-search-container>

        <!-- ============================================================
             좌우 Split 레이아웃
             ============================================================ -->
        <div class="hbox flex">
            <!-- ========== 좌측: 프로젝트 목록 그리드 (flex-4) ========== -->
            <sc-grid id="gridPanel"
                     data-provider="{{resultList}}"
                     on-item-click="onProjectClick"
                     class="flex-4"
                     use-state="false">

                <sc-grid-columns>
                    <sc-data-column data-field="pjtCd"
                                    header-text="프로젝트 코드"
                                    width="130"
                                    text-align="center"
                                    on-item-click="onProjectClick">
                    </sc-data-column>

                    <sc-data-column data-field="pjtNm"
                                    header-text="프로젝트명"
                                    width="200"
                                    text-align="left">
                    </sc-data-column>

                    <sc-data-column data-field="bizUnit"
                                    header-text="사업부"
                                    width="100"
                                    text-align="center">
                    </sc-data-column>

                    <sc-data-column data-field="stsNm"
                                    header-text="상태"
                                    width="80"
                                    text-align="center">
                    </sc-data-column>
                </sc-grid-columns>
            </sc-grid>

            <div class="hspace-10"></div>

            <!-- ========== 우측: SGA 원가 계산 폼 (flex-6) ========== -->
            <div class="vbox flex-6">
                <sc-toolbar>
                    <sc-button text="계산"     on-click="onCalculateSgaCost" auth-code="S"></sc-button>
                    <sc-button text="계산완료" on-click="onCompleteSgaCost"  auth-code="S"></sc-button>
                </sc-toolbar>

                <!-- 판매관리비 비율 입력 폼 -->
                <sc-panel title-text="판매관리비 비율 입력 (SG&A Rate)" class="flex-4">
                    <table class="form-table">
                        <colgroup>
                            <col style="width:140px"/><col/>
                            <col style="width:140px"/><col/>
                        </colgroup>
                        <tr>
                            <th><sc-label text="판매인건비(%)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{sgaData.salesLaborRate}}"></sc-number-field>
                            </td>
                            <th><sc-label text="운반비(%)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{sgaData.transportRate}}"></sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="수출비(%)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{sgaData.exportRate}}"></sc-number-field>
                            </td>
                            <th><sc-label text="품질보증비(%)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{sgaData.warrantyRate}}"></sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="광고선전비(%)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{sgaData.advertisingRate}}"></sc-number-field>
                            </td>
                            <th><sc-label text="연구비(%)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{sgaData.researchRate}}"></sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="자산비용(%)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{sgaData.assetCostRate}}"></sc-number-field>
                            </td>
                            <th><sc-label text="인적비용(%)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{sgaData.hrCostRate}}"></sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="기타관련비(%)"></sc-label></th>
                            <td colspan="3">
                                <sc-number-field value="{{sgaData.etcRate}}"></sc-number-field>
                            </td>
                        </tr>
                    </table>
                </sc-panel>

                <!-- 판매관리비 계산 결과 그리드 -->
                <sc-panel title-text="판매관리비 계산 결과" class="flex-6">
                    <sc-grid id="sgaResultGrid"
                             data-provider="{{sgaResultList}}"
                             editable="false"
                             class="flex">

                        <sc-grid-columns>
                            <sc-data-column data-field="itemNm"
                                            header-text="항목"
                                            width="180"
                                            text-align="left">
                            </sc-data-column>

                            <sc-data-column data-field="rate"
                                            header-text="비율(%)"
                                            width="100"
                                            text-align="right"
                                            data-type="number"
                                            format="#,##0.00">
                            </sc-data-column>

                            <sc-data-column data-field="amt"
                                            header-text="금액(KRW)"
                                            width="150"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>
                        </sc-grid-columns>
                    </sc-grid>
                </sc-panel>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'es-sga-cost-calc',

            properties: {
                // 조회 조건 파라미터
                searchParam: {
                    type: Object,
                    value: function() { return {}; }
                },
                // 좌측 프로젝트 그리드 데이터
                resultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // 선택된 프로젝트 코드
                selectedPjtCd: {
                    type: String,
                    value: ''
                },
                // SGA 비율 입력 데이터
                sgaData: {
                    type: Object,
                    value: function() {
                        return {
                            salesLaborRate:  0,
                            transportRate:   0,
                            exportRate:      0,
                            warrantyRate:    0,
                            advertisingRate: 0,
                            researchRate:    0,
                            assetCostRate:   0,
                            hrCostRate:      0,
                            etcRate:         0
                        };
                    }
                },
                // SGA 계산 결과 그리드 데이터
                sgaResultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // Ajax 파라미터
                sgaSearchParam: { type: Object, value: function() { return {}; } },
                calcParam:      { type: Object, value: function() { return {}; } },
                // 공통코드
                codes: {
                    type: Object,
                    value: function() {
                        return {
                            bizUnitList: [
                                { label: 'PT',   data: 'PT' },
                                { label: 'SEAT', data: 'SEAT' }
                            ]
                        };
                    }
                }
            },

            /* ==============================================================
               프로젝트 목록 조회 (좌측 그리드)
               ============================================================== */

            onFindList: function() {
                this.$.findListAjax.generateRequest();
            },

            onFindListResponse: function(e) {
                this.set('resultList', e.detail.response);
            },

            /* ==============================================================
               프로젝트 선택 → 우측 SGA 데이터 로드
               ============================================================== */

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row || !row.pjtCd) return;

                this.set('selectedPjtCd', row.pjtCd);
                this.set('sgaSearchParam', { ecPjtCd: row.pjtCd });
                this.$.findSgaCostAjax.generateRequest();
            },

            onFindSgaCostResponse: function(e) {
                var data = e.detail.response;
                if (data && data.sgaData) {
                    this.set('sgaData', data.sgaData);
                } else {
                    // SGA 데이터 미등록 → 빈 폼 초기화
                    this.set('sgaData', {
                        salesLaborRate:  0,
                        transportRate:   0,
                        exportRate:      0,
                        warrantyRate:    0,
                        advertisingRate: 0,
                        researchRate:    0,
                        assetCostRate:   0,
                        hrCostRate:      0,
                        etcRate:         0
                    });
                }
                if (data && data.sgaResultList) {
                    this.set('sgaResultList', data.sgaResultList);
                } else {
                    this.set('sgaResultList', []);
                }
            },

            /* ==============================================================
               판매관리비 계산
               ============================================================== */

            onCalculateSgaCost: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                this.set('calcParam', {
                    ecPjtCd:         this.selectedPjtCd,
                    salesLaborRate:  this.sgaData.salesLaborRate,
                    transportRate:   this.sgaData.transportRate,
                    exportRate:      this.sgaData.exportRate,
                    warrantyRate:    this.sgaData.warrantyRate,
                    advertisingRate: this.sgaData.advertisingRate,
                    researchRate:    this.sgaData.researchRate,
                    assetCostRate:   this.sgaData.assetCostRate,
                    hrCostRate:      this.sgaData.hrCostRate,
                    etcRate:         this.sgaData.etcRate
                });
                this.$.calculateSgaCostAjax.generateRequest();
            },

            onCalculateSgaCostResponse: function(e) {
                var data = e.detail.response;
                if (data && data.sgaResultList) {
                    this.set('sgaResultList', data.sgaResultList);
                }
                UT.alert('판매관리비 계산이 완료되었습니다.');
            },

            /* ==============================================================
               계산완료 (상태 확정)
               ============================================================== */

            onCompleteSgaCost: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                if (!this.sgaResultList || this.sgaResultList.length === 0) {
                    UT.alert('먼저 판매관리비 계산을 수행해 주세요.');
                    return;
                }

                var me = this;
                UT.confirm('판매관리비 계산을 완료 처리하시겠습니까?', function() {
                    me.set('calcParam', {
                        ecPjtCd:   me.selectedPjtCd,
                        completeYn: 'Y',
                        sgaData:   me.sgaData
                    });
                    me.$.calculateSgaCostAjax.generateRequest();
                });
            }
        });
    </script>
</dom-module>

<dom-module id="es-mfg-cost-calc">
    <template>
        <style>
            /* ── 탭 버튼 스타일 ── */
            .tab-bar { display:flex; gap:2px; margin-top:10px; border-bottom:2px solid #e0e0e0; }
            .tab-btn { padding:6px 12px; border:none; background:#f0f1f5; cursor:pointer; font-size:11px; border-radius:4px 4px 0 0; }
            .tab-btn.active { background:#6954FE; color:#fff; font-weight:600; }
            .tab-btn:hover:not(.active) { background:#e2e3e8; }

            /* ── 결과 테이블 스타일 ── */
            .result-table { width:100%; border-collapse:collapse; font-size:12px; margin-top:6px; }
            .result-table th,
            .result-table td { border:1px solid #e0e0e0; padding:5px 8px; }
            .result-table th { background:#f5f6fa; font-weight:600; text-align:center; }
            .result-table td.amt { text-align:right; }
            .result-table tr.row-total { background:#f0f1f5; font-weight:600; }

            /* ── 상세 탭 콘텐츠 영역 ── */
            .detail-tab-content { border:1px solid #e0e0e0; border-top:none; padding:8px; min-height:200px; }

            /* ── 입력 폼 영역 스타일 ── */
            .input-section { margin-bottom:10px; }
            .input-section .tb-form th { width:160px; }
        </style>

        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/ec/findListEstimateCostPjt.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <sc-ajax id="findMfgCostAjax"
                 url="/bp/cost/ec/detail/findListMfgCost.do"
                 body="{{mfgCostSearchParam}}"
                 on-response="onFindMfgCostResponse">
        </sc-ajax>

        <sc-ajax id="calculateMfgCostAjax"
                 url="/bp/cost/ec/detail/calculateMfgCost.do"
                 body="{{calculateParam}}"
                 on-response="onCalculateMfgCostResponse">
        </sc-ajax>

        <sc-ajax id="validateCalcAjax"
                 url="/bp/cost/ec/detail/validateCalcPrereq.do"
                 body="{{validateParam}}"
                 on-response="onValidateCalcResponse">
        </sc-ajax>

        <!-- ============================================================
             조회 조건 영역
             ============================================================ -->
        <sc-search-container on-search="onFindList" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트 코드"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.pjtCd}}" on-enter="onFindList"></sc-text-field>
                    </td>
                    <th><sc-label text="사업부"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.bizUnit}}"
                                          items="{{codes.bizUnitList}}"
                                          display-field="label"
                                          value-field="data"
                                          placeholder="전체">
                        </sc-combobox-field>
                    </td>
                </tr>
                <tr>
                    <th><sc-label text="고객사"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.custNm}}"></sc-text-field>
                    </td>
                    <th><sc-label text="차종"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.carType}}"></sc-text-field>
                    </td>
                </tr>
            </table>
        </sc-search-container>

        <!-- ============================================================
             좌우 Split 레이아웃
             ============================================================ -->
        <div class="hbox flex">

            <!-- ========== 좌측: 프로젝트 목록 그리드 (flex-4) ========== -->
            <sc-grid id="gridPanel"
                     data-provider="{{pjtList}}"
                     on-item-click="onProjectClick"
                     class="flex-4"
                     use-state="false">

                <sc-grid-columns>
                    <sc-data-column data-field="pjtCd"
                                    header-text="프로젝트 코드"
                                    width="130"
                                    text-align="center"
                                    on-item-click="onProjectClick">
                    </sc-data-column>

                    <sc-data-column data-field="pjtNm"
                                    header-text="프로젝트명"
                                    width="200"
                                    text-align="left">
                    </sc-data-column>

                    <sc-data-column data-field="custNm"
                                    header-text="고객사"
                                    width="120">
                    </sc-data-column>

                    <sc-data-column data-field="carType"
                                    header-text="차종"
                                    width="100">
                    </sc-data-column>

                    <sc-data-column data-field="stsNm"
                                    header-text="상태"
                                    width="80"
                                    text-align="center">
                    </sc-data-column>
                </sc-grid-columns>
            </sc-grid>

            <div class="hspace-10"></div>

            <!-- ========== 우측: 제조경비 계산 영역 (flex-6) ========== -->
            <div class="vbox flex-6">

                <!-- ── 제조경비 산출 정보 입력 ── -->
                <sc-panel title-text="제조경비 산출 정보 입력" class="input-section">
                    <sc-toolbar>
                        <sc-button text="데이터 점검" on-click="onValidateCalc" auth-code="V"></sc-button>
                        <sc-button text="계산"     on-click="onCalculate"     auth-code="S"></sc-button>
                        <sc-button text="계산완료"  on-click="onCalcComplete"  auth-code="S"></sc-button>
                    </sc-toolbar>

                    <table class="tb-form">
                        <colgroup>
                            <col style="width:160px"/><col/>
                            <col style="width:160px"/><col/>
                        </colgroup>
                        <tr>
                            <th><sc-label text="임금인상률(%)"></sc-label></th>
                            <td>
                                <sc-text-field value="{{mfgCostData.wageIncRate}}"
                                               data-type="rate">
                                </sc-text-field>
                            </td>
                            <th><sc-label text="물가상승률(%)"></sc-label></th>
                            <td>
                                <sc-text-field value="{{mfgCostData.inflationRate}}"
                                               data-type="rate">
                                </sc-text-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="생산직접경비 비율(%)"></sc-label></th>
                            <td>
                                <sc-text-field value="{{mfgCostData.prodDirectRate}}"
                                               data-type="rate">
                                </sc-text-field>
                            </td>
                            <th><sc-label text="인건비성경비 비율(%)"></sc-label></th>
                            <td>
                                <sc-text-field value="{{mfgCostData.laborRelatedRate}}"
                                               data-type="rate">
                                </sc-text-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="기타제조경비 비율(%)"></sc-label></th>
                            <td>
                                <sc-text-field value="{{mfgCostData.etcMfgRate}}"
                                               data-type="rate">
                                </sc-text-field>
                            </td>
                            <th><sc-label text="금형비 (단위당)"></sc-label></th>
                            <td>
                                <sc-text-field value="{{mfgCostData.moldCostUnit}}"
                                               data-type="amount">
                                </sc-text-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="외주가공비 (단위당/비율%)"></sc-label></th>
                            <td colspan="3">
                                <sc-text-field value="{{mfgCostData.outsrcCostUnit}}"
                                               data-type="amount">
                                </sc-text-field>
                            </td>
                        </tr>
                    </table>
                </sc-panel>

                <!-- ── 제조경비 계산 결과 ── -->
                <sc-panel title-text="제조경비 계산 결과 (단위: {{baseCurrency}})">
                    <table class="result-table">
                        <colgroup>
                            <col style="width:40px"/>
                            <col style="width:200px"/>
                            <col/>
                            <col style="width:160px"/>
                        </colgroup>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>원가항목</th>
                                <th>단위당 금액</th>
                                <th>비고</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align:center">1</td>
                                <td>직접노무비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.directLaborCost)}}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="text-align:center">2</td>
                                <td>간접노무비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.indirectLaborCost)}}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="text-align:center">3</td>
                                <td>생산직접경비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.prodDirectCost)}}</td>
                                <td>직접노무비 x {{mfgCostData.prodDirectRate}}%</td>
                            </tr>
                            <tr>
                                <td style="text-align:center">4</td>
                                <td>인건비성경비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.laborRelatedCost)}}</td>
                                <td>노무비 x {{mfgCostData.laborRelatedRate}}%</td>
                            </tr>
                            <tr>
                                <td style="text-align:center">5</td>
                                <td>기타제조경비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.etcMfgCost)}}</td>
                                <td>노무비 x {{mfgCostData.etcMfgRate}}%</td>
                            </tr>
                            <tr>
                                <td style="text-align:center">6</td>
                                <td>감가상각비(건구축물)</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.deprBldgCost)}}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="text-align:center">7</td>
                                <td>감가상각비(생산라인)</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.deprLineCost)}}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="text-align:center">8</td>
                                <td>감가상각비(기타)</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.deprEtcCost)}}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="text-align:center">9</td>
                                <td>외주가공비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.outsrcCost)}}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="text-align:center">10</td>
                                <td>금형비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.moldCost)}}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="text-align:center">11</td>
                                <td>연구개발비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.rndCost)}}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="text-align:center">12</td>
                                <td>기타경비</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.etcCost)}}</td>
                                <td></td>
                            </tr>
                            <tr class="row-total">
                                <td style="text-align:center"></td>
                                <td>합계</td>
                                <td class="amt">{{_formatAmt(mfgCostResult.totalMfgCost)}}</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </sc-panel>

                <!-- ── 상세 탭 (10개 세부 탭) ── -->
                <sc-panel title-text="세부 원가 상세">
                    <div class="tab-bar">
                        <button class$="tab-btn {{_tabClass('directLabor')}}"
                                on-click="_onTabDirectLabor">직접</button>
                        <button class$="tab-btn {{_tabClass('indirectLabor')}}"
                                on-click="_onTabIndirectLabor">간접</button>
                        <button class$="tab-btn {{_tabClass('prodDirect')}}"
                                on-click="_onTabProdDirect">생산직접비</button>
                        <button class$="tab-btn {{_tabClass('laborRelated')}}"
                                on-click="_onTabLaborRelated">인건비성경비</button>
                        <button class$="tab-btn {{_tabClass('etcMfg')}}"
                                on-click="_onTabEtcMfg">기타제조경비</button>
                        <button class$="tab-btn {{_tabClass('deprBldg')}}"
                                on-click="_onTabDeprBldg">감가상각비 건구축</button>
                        <button class$="tab-btn {{_tabClass('deprLine')}}"
                                on-click="_onTabDeprLine">감가상각비 생산라인</button>
                        <button class$="tab-btn {{_tabClass('deprEtc')}}"
                                on-click="_onTabDeprEtc">감가상각비 기타</button>
                        <button class$="tab-btn {{_tabClass('outsrc')}}"
                                on-click="_onTabOutsrc">외주가공비</button>
                        <button class$="tab-btn {{_tabClass('mold')}}"
                                on-click="_onTabMold">금형비</button>
                    </div>

                    <div class="detail-tab-content">

                        <!-- ── 직접노무비 탭 ── -->
                        <template is="dom-if" if="{{_isTab('directLabor')}}">
                            <sc-grid id="gridDirectLabor"
                                     data-provider="{{detailDirectLabor}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="lineNm"
                                                    header-text="라인명"
                                                    width="140"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-combobox-column data-field="lineType"
                                                    header-text="구분"
                                                    width="80"
                                                    text-align="center"
                                                    items="{{codes.mpTypeList}}"
                                                    display-field="label"
                                                    value-field="data">
                                    </sc-combobox-column>
                                    <sc-data-column data-field="workerCnt"
                                                    header-text="인원(명)"
                                                    width="80"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="wagePerPerson"
                                                    header-text="인당임금"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="annualCost"
                                                    header-text="연간노무비"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 간접노무비 탭 ── -->
                        <template is="dom-if" if="{{_isTab('indirectLabor')}}">
                            <sc-grid id="gridIndirectLabor"
                                     data-provider="{{detailIndirectLabor}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="lineNm"
                                                    header-text="라인명"
                                                    width="140"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-combobox-column data-field="lineType"
                                                    header-text="구분"
                                                    width="80"
                                                    text-align="center"
                                                    items="{{codes.mpTypeList}}"
                                                    display-field="label"
                                                    value-field="data">
                                    </sc-combobox-column>
                                    <sc-data-column data-field="workerCnt"
                                                    header-text="인원(명)"
                                                    width="80"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="wagePerPerson"
                                                    header-text="인당임금"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="annualCost"
                                                    header-text="연간노무비"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 생산직접비 탭 ── -->
                        <template is="dom-if" if="{{_isTab('prodDirect')}}">
                            <sc-grid id="gridProdDirect"
                                     data-provider="{{detailProdDirect}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="costItemNm"
                                                    header-text="경비항목"
                                                    width="160"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-data-column data-field="lineType" header-text="구분" width="80" text-align="center"></sc-data-column>
                                    <sc-data-column data-field="baseAmt"
                                                    header-text="기준금액"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="rateApplied"
                                                    header-text="적용비율(%)"
                                                    width="100"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 인건비성경비 탭 ── -->
                        <template is="dom-if" if="{{_isTab('laborRelated')}}">
                            <sc-grid id="gridLaborRelated"
                                     data-provider="{{detailLaborRelated}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="costItemNm"
                                                    header-text="경비항목"
                                                    width="160"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-data-column data-field="lineType" header-text="구분" width="80" text-align="center"></sc-data-column>
                                    <sc-data-column data-field="baseAmt"
                                                    header-text="기준금액"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="rateApplied"
                                                    header-text="적용비율(%)"
                                                    width="100"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 기타제조경비 탭 ── -->
                        <template is="dom-if" if="{{_isTab('etcMfg')}}">
                            <sc-grid id="gridEtcMfg"
                                     data-provider="{{detailEtcMfg}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="costItemNm"
                                                    header-text="경비항목"
                                                    width="160"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-data-column data-field="lineType" header-text="구분" width="80" text-align="center"></sc-data-column>
                                    <sc-data-column data-field="baseAmt"
                                                    header-text="기준금액"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="rateApplied"
                                                    header-text="적용비율(%)"
                                                    width="100"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 감가상각비 건구축 탭 ── -->
                        <template is="dom-if" if="{{_isTab('deprBldg')}}">
                            <sc-grid id="gridDeprBldg"
                                     data-provider="{{detailDeprBldg}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="assetNm"
                                                    header-text="자산명"
                                                    width="160"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-combobox-column data-field="lineType"
                                                    header-text="구분"
                                                    width="80"
                                                    text-align="center"
                                                    items="{{codes.investTypeList}}"
                                                    display-field="label"
                                                    value-field="data">
                                    </sc-combobox-column>
                                    <sc-data-column data-field="acqAmt"
                                                    header-text="취득가액"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="usefulLife"
                                                    header-text="내용연수(년)"
                                                    width="100"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="annualDepr"
                                                    header-text="연간상각비"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 감가상각비 생산라인 탭 ── -->
                        <template is="dom-if" if="{{_isTab('deprLine')}}">
                            <sc-grid id="gridDeprLine"
                                     data-provider="{{detailDeprLine}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="assetNm"
                                                    header-text="설비/라인명"
                                                    width="160"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-combobox-column data-field="lineType"
                                                    header-text="구분"
                                                    width="80"
                                                    text-align="center"
                                                    items="{{codes.lineNewList}}"
                                                    display-field="label"
                                                    value-field="data">
                                    </sc-combobox-column>
                                    <sc-data-column data-field="acqAmt"
                                                    header-text="취득가액"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="usefulLife"
                                                    header-text="내용연수(년)"
                                                    width="100"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="annualDepr"
                                                    header-text="연간상각비"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 감가상각비 기타 탭 ── -->
                        <template is="dom-if" if="{{_isTab('deprEtc')}}">
                            <sc-grid id="gridDeprEtc"
                                     data-provider="{{detailDeprEtc}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="assetNm"
                                                    header-text="자산명"
                                                    width="160"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-combobox-column data-field="lineType"
                                                    header-text="구분"
                                                    width="80"
                                                    text-align="center"
                                                    items="{{codes.investTypeList}}"
                                                    display-field="label"
                                                    value-field="data">
                                    </sc-combobox-column>
                                    <sc-data-column data-field="acqAmt"
                                                    header-text="취득가액"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="usefulLife"
                                                    header-text="내용연수(년)"
                                                    width="100"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="annualDepr"
                                                    header-text="연간상각비"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 외주가공비 탭 ── -->
                        <template is="dom-if" if="{{_isTab('outsrc')}}">
                            <sc-grid id="gridOutsrc"
                                     data-provider="{{detailOutsrc}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="processNm"
                                                    header-text="공정명"
                                                    width="160"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-data-column data-field="lineType" header-text="구분" width="80" text-align="center"></sc-data-column>
                                    <sc-data-column data-field="outsrcVendor"
                                                    header-text="외주업체"
                                                    width="120"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitPrice"
                                                    header-text="단가"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                        <!-- ── 금형비 탭 ── -->
                        <template is="dom-if" if="{{_isTab('mold')}}">
                            <sc-grid id="gridMold"
                                     data-provider="{{detailMold}}"
                                     class="flex"
                                     use-state="false">
                                <sc-grid-columns>
                                    <sc-data-column data-field="moldNm"
                                                    header-text="금형명"
                                                    width="160"
                                                    text-align="left">
                                    </sc-data-column>
                                    <sc-data-column data-field="lineType" header-text="구분" width="80" text-align="center"></sc-data-column>
                                    <sc-data-column data-field="moldAcqAmt"
                                                    header-text="취득가액"
                                                    width="130"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="totalProdQty"
                                                    header-text="총생산수량"
                                                    width="110"
                                                    text-align="right"
                                                    data-type="number">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY1"
                                                    header-text="1차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY2"
                                                    header-text="2차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                    <sc-data-column data-field="unitCostY3"
                                                    header-text="3차년도 단위당"
                                                    width="120"
                                                    text-align="right"
                                                    data-type="number"
                                                    format-type="amt">
                                    </sc-data-column>
                                </sc-grid-columns>
                            </sc-grid>
                        </template>

                    </div>
                </sc-panel>

            </div><!-- /vbox flex-6 -->
        </div><!-- /hbox flex -->
    </template>

    <script>
        Polymer({
            is: 'es-mfg-cost-calc',

            properties: {
                /* ── 조회 조건 ── */
                searchParam: {
                    type: Object,
                    value: function() { return {}; }
                },

                /* ── 좌측 프로젝트 목록 ── */
                pjtList: {
                    type: Array,
                    value: function() { return []; }
                },

                /* ── 선택된 프로젝트 ── */
                selectedPjt: {
                    type: Object,
                    value: function() { return {}; }
                },

                /* ── 기준통화 ── */
                baseCurrency: {
                    type: String,
                    value: 'KRW'
                },

                /* ── 제조경비 산출 입력 데이터 ── */
                mfgCostData: {
                    type: Object,
                    value: function() {
                        return {
                            ecPjtCd:          '',
                            wageIncRate:      0,    // 임금인상률(%)
                            inflationRate:    0,    // 물가상승률(%)
                            prodDirectRate:   0,    // 생산직접경비 비율(%)
                            laborRelatedRate: 0,    // 인건비성경비 비율(%)
                            etcMfgRate:       0,    // 기타제조경비 비율(%)
                            moldCostUnit:     0,    // 금형비 (단위당)
                            outsrcCostUnit:   0     // 외주가공비 (단위당/비율)
                        };
                    }
                },

                /* ── 제조경비 계산 결과 (요약) ── */
                mfgCostResult: {
                    type: Object,
                    value: function() {
                        return {
                            directLaborCost:   0,
                            indirectLaborCost: 0,
                            prodDirectCost:    0,
                            laborRelatedCost:  0,
                            etcMfgCost:        0,
                            deprBldgCost:      0,
                            deprLineCost:      0,
                            deprEtcCost:       0,
                            outsrcCost:        0,
                            moldCost:          0,
                            rndCost:           0,
                            etcCost:           0,
                            totalMfgCost:      0
                        };
                    }
                },

                /* ── 활성 상세 탭 ── */
                activeDetailTab: {
                    type: String,
                    value: 'directLabor'
                },

                /* ── 상세 탭별 그리드 데이터 ── */
                detailDirectLabor:   { type: Array, value: function() { return []; } },
                detailIndirectLabor: { type: Array, value: function() { return []; } },
                detailProdDirect:    { type: Array, value: function() { return []; } },
                detailLaborRelated:  { type: Array, value: function() { return []; } },
                detailEtcMfg:        { type: Array, value: function() { return []; } },
                detailDeprBldg:      { type: Array, value: function() { return []; } },
                detailDeprLine:      { type: Array, value: function() { return []; } },
                detailDeprEtc:       { type: Array, value: function() { return []; } },
                detailOutsrc:        { type: Array, value: function() { return []; } },
                detailMold:          { type: Array, value: function() { return []; } },

                /* ── Ajax 파라미터 ── */
                mfgCostSearchParam: { type: Object, value: function() { return {}; } },
                calculateParam:     { type: Object, value: function() { return {}; } },

                /* ── 공통코드 ── */
                codes: {
                    type: Object,
                    value: function() { return {}; }
                }
            },

            attached: function() {
                var me = this;
                UT.loadCodes({
                    bizUnitList:    'T004',
                    mpTypeList:     'T007',
                    lineNewList:    'T038',
                    investTypeList: 'T039'
                }, function(codes) { me.set('codes', codes); });
                this.onFindList();
            },

            /* ==============================================================
               프로젝트 목록 조회 (좌측 그리드)
               ============================================================== */

            onFindList: function() {
                this._clearDetail();
                this.$.findListAjax.generateRequest();
            },

            onFindListResponse: function(e) {
                this.set('pjtList', e.detail.response);
            },

            /* ==============================================================
               프로젝트 선택 → 우측 제조경비 데이터 로드
               ============================================================== */

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row || !row.pjtCd) return;

                this.set('selectedPjt', row);
                this.set('baseCurrency', row.baseCurrency || 'KRW');
                this.set('mfgCostSearchParam', { ecPjtCd: row.pjtCd });
                this.$.findMfgCostAjax.generateRequest();
            },

            onFindMfgCostResponse: function(e) {
                var data = e.detail.response;
                if (!data) {
                    this._initEmptyForm();
                    return;
                }

                // 입력 데이터 바인딩
                if (data.inputData) {
                    this.set('mfgCostData', data.inputData);
                } else {
                    this._initEmptyForm();
                }

                // 결과 요약 바인딩
                if (data.resultSummary) {
                    this.set('mfgCostResult', data.resultSummary);
                }

                // 상세 탭 데이터 바인딩
                this.set('detailDirectLabor',   data.detailDirectLabor   || []);
                this.set('detailIndirectLabor', data.detailIndirectLabor || []);
                this.set('detailProdDirect',    data.detailProdDirect    || []);
                this.set('detailLaborRelated',  data.detailLaborRelated  || []);
                this.set('detailEtcMfg',        data.detailEtcMfg        || []);
                this.set('detailDeprBldg',      data.detailDeprBldg      || []);
                this.set('detailDeprLine',      data.detailDeprLine      || []);
                this.set('detailDeprEtc',       data.detailDeprEtc       || []);
                this.set('detailOutsrc',        data.detailOutsrc        || []);
                this.set('detailMold',          data.detailMold          || []);
            },

            /**
             * 빈 폼 초기화
             */
            _initEmptyForm: function() {
                this.set('mfgCostData', {
                    ecPjtCd:          this.selectedPjt.pjtCd || '',
                    wageIncRate:      0,
                    inflationRate:    0,
                    prodDirectRate:   0,
                    laborRelatedRate: 0,
                    etcMfgRate:       0,
                    moldCostUnit:     0,
                    outsrcCostUnit:   0
                });
                this.set('mfgCostResult', {
                    directLaborCost:   0,
                    indirectLaborCost: 0,
                    prodDirectCost:    0,
                    laborRelatedCost:  0,
                    etcMfgCost:        0,
                    deprBldgCost:      0,
                    deprLineCost:      0,
                    deprEtcCost:       0,
                    outsrcCost:        0,
                    moldCost:          0,
                    rndCost:           0,
                    etcCost:           0,
                    totalMfgCost:      0
                });
                this._clearDetailGrids();
            },

            /**
             * 상세 그리드 전체 초기화
             */
            _clearDetailGrids: function() {
                this.set('detailDirectLabor',   []);
                this.set('detailIndirectLabor', []);
                this.set('detailProdDirect',    []);
                this.set('detailLaborRelated',  []);
                this.set('detailEtcMfg',        []);
                this.set('detailDeprBldg',      []);
                this.set('detailDeprLine',      []);
                this.set('detailDeprEtc',       []);
                this.set('detailOutsrc',        []);
                this.set('detailMold',          []);
            },

            /* ==============================================================
               제조경비 계산 실행
               ============================================================== */

            /**
             * 계산 버튼 클릭 — 서버에 계산 요청
             * 입력 파라미터(비율, 금형비, 외주가공비 등)를 전송하여
             * 생산라인 마스터 + 투자등록 데이터 기반으로 제조경비를 계산한다.
             */
            /* ── 데이터 점검 (Validation) ── */
            onValidateCalc: function() {
                if (!this.selectedPjt || !this.selectedPjt.pjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                this.set('validateParam', { ecPjtCd: this.selectedPjt.pjtCd });
                this._validateMode = 'CHECK';
                this.$.validateCalcAjax.generateRequest();
            },

            onValidateCalcResponse: function(e) {
                var data = e.detail.response;
                if (!data || data.status !== 'OK') return;

                var msgs = data.messages || [];
                // MFG 화면이므로 MFG 관련 메시지만 필터링
                var mfgMsgs = [];
                for (var i = 0; i < msgs.length; i++) {
                    if (msgs[i].calcStep === 'MFG') mfgMsgs.push(msgs[i]);
                }

                if (mfgMsgs.length === 0) {
                    if (this._validateMode === 'CALC') {
                        this._doCalculate();
                    } else {
                        UT.alert('제조경비 계산에 필요한 데이터가 정상 등록되어 있습니다.');
                    }
                    return;
                }

                var lines = [];
                var icons = { 'ERROR': '[오류]', 'WARNING': '[경고]', 'INFO': '[참고]' };
                for (var i = 0; i < mfgMsgs.length; i++) {
                    var m = mfgMsgs[i];
                    lines.push(icons[m.level] + ' ' + m.category + ': ' + m.message);
                }

                var hasError = false;
                for (var i = 0; i < mfgMsgs.length; i++) {
                    if (mfgMsgs[i].level === 'ERROR') { hasError = true; break; }
                }

                var summary = lines.join('\n');

                if (this._validateMode === 'CALC') {
                    if (hasError) {
                        UT.alert('계산을 수행할 수 없습니다.\n\n' + summary);
                    } else {
                        var me = this;
                        UT.confirm(summary + '\n\n계속 계산하시겠습니까?', function() {
                            me._doCalculate();
                        });
                    }
                } else {
                    UT.alert(summary);
                }
            },

            onCalculate: function() {
                if (!this.selectedPjt || !this.selectedPjt.pjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                // 필수 입력값 검증
                var d = this.mfgCostData;
                if (!d.wageIncRate && d.wageIncRate !== 0) {
                    UT.alert('임금인상률을 입력해 주세요.');
                    return;
                }

                // 산출 전 자동 점검
                this.set('validateParam', { ecPjtCd: this.selectedPjt.pjtCd });
                this._validateMode = 'CALC';
                this.$.validateCalcAjax.generateRequest();
            },

            _doCalculate: function() {
                var me = this;
                var d = me.mfgCostData;
                me.set('calculateParam', {
                    ecPjtCd:          me.selectedPjt.pjtCd,
                    wageIncRate:      Number(d.wageIncRate)      || 0,
                    inflationRate:    Number(d.inflationRate)    || 0,
                    prodDirectRate:   Number(d.prodDirectRate)   || 0,
                    laborRelatedRate: Number(d.laborRelatedRate) || 0,
                    etcMfgRate:       Number(d.etcMfgRate)       || 0,
                    moldCostUnit:     Number(d.moldCostUnit)     || 0,
                    outsrcCostUnit:   Number(d.outsrcCostUnit)   || 0
                });
                me.$.calculateMfgCostAjax.generateRequest();
            },

            onCalculateMfgCostResponse: function(e) {
                var data = e.detail.response;
                if (!data) {
                    UT.alert('계산 결과를 수신하지 못했습니다.');
                    return;
                }
                if (data.status === 'FAIL') {
                    UT.alert(data.message);
                    return;
                }

                // 결과 요약 바인딩
                if (data.resultSummary) {
                    this.set('mfgCostResult', data.resultSummary);
                }

                // 상세 탭 데이터 바인딩
                this.set('detailDirectLabor',   data.detailDirectLabor   || []);
                this.set('detailIndirectLabor', data.detailIndirectLabor || []);
                this.set('detailProdDirect',    data.detailProdDirect    || []);
                this.set('detailLaborRelated',  data.detailLaborRelated  || []);
                this.set('detailEtcMfg',        data.detailEtcMfg        || []);
                this.set('detailDeprBldg',      data.detailDeprBldg      || []);
                this.set('detailDeprLine',      data.detailDeprLine      || []);
                this.set('detailDeprEtc',       data.detailDeprEtc       || []);
                this.set('detailOutsrc',        data.detailOutsrc        || []);
                this.set('detailMold',          data.detailMold          || []);

                UT.alert('제조경비 계산이 완료되었습니다.\n합계: '
                         + (data.resultSummary ? data.resultSummary.totalMfgCost.toLocaleString() : '0'));
            },

            /* ==============================================================
               계산완료 (확정 처리)
               ============================================================== */

            /**
             * 계산완료 버튼 — 제조경비 계산 결과를 확정하여
             * 수익성 분석(es-ec-profit-mgt)으로 연계할 수 있도록 상태를 변경한다.
             */
            onCalcComplete: function() {
                if (!this.selectedPjt || !this.selectedPjt.pjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                var total = this.mfgCostResult.totalMfgCost || 0;
                if (total <= 0) {
                    UT.alert('계산 결과가 없습니다. 먼저 계산을 실행해 주세요.');
                    return;
                }

                var me = this;
                UT.confirm('제조경비 계산 결과를 확정하시겠습니까?\n(합계: ' + total.toLocaleString() + ')', function() {
                    // 계산완료 시 동일 Ajax로 completeYn='Y' 플래그를 추가하여 전송
                    var d = me.mfgCostData;
                    me.set('calculateParam', {
                        ecPjtCd:          me.selectedPjt.pjtCd,
                        wageIncRate:      Number(d.wageIncRate)      || 0,
                        inflationRate:    Number(d.inflationRate)    || 0,
                        prodDirectRate:   Number(d.prodDirectRate)   || 0,
                        laborRelatedRate: Number(d.laborRelatedRate) || 0,
                        etcMfgRate:       Number(d.etcMfgRate)       || 0,
                        moldCostUnit:     Number(d.moldCostUnit)     || 0,
                        outsrcCostUnit:   Number(d.outsrcCostUnit)   || 0,
                        completeYn:       'Y'
                    });
                    me.$.calculateMfgCostAjax.generateRequest();
                });
            },

            /* ==============================================================
               상세 탭 전환
               ============================================================== */

            _onTabDirectLabor:   function() { this.set('activeDetailTab', 'directLabor'); },
            _onTabIndirectLabor: function() { this.set('activeDetailTab', 'indirectLabor'); },
            _onTabProdDirect:    function() { this.set('activeDetailTab', 'prodDirect'); },
            _onTabLaborRelated:  function() { this.set('activeDetailTab', 'laborRelated'); },
            _onTabEtcMfg:        function() { this.set('activeDetailTab', 'etcMfg'); },
            _onTabDeprBldg:      function() { this.set('activeDetailTab', 'deprBldg'); },
            _onTabDeprLine:      function() { this.set('activeDetailTab', 'deprLine'); },
            _onTabDeprEtc:       function() { this.set('activeDetailTab', 'deprEtc'); },
            _onTabOutsrc:        function() { this.set('activeDetailTab', 'outsrc'); },
            _onTabMold:          function() { this.set('activeDetailTab', 'mold'); },

            /**
             * 탭 버튼 class 계산 — 활성 탭이면 'active' 반환
             */
            _tabClass: function(tabName) {
                return this.activeDetailTab === tabName ? 'active' : '';
            },

            /**
             * dom-if 조건 — 현재 활성 탭과 일치 여부
             */
            _isTab: function(tabName) {
                return this.activeDetailTab === tabName;
            },

            /* ==============================================================
               유틸리티 — 금액 포맷
               ============================================================== */

            /**
             * 숫자를 천단위 콤마 형식으로 변환
             * @param {Number} val
             * @return {String}
             */
            _formatAmt: function(val) {
                var num = Number(val) || 0;
                return num.toLocaleString();
            },

            _clearDetail: function() {
                this.set('selectedPjt', {});
                this.set('baseCurrency', 'KRW');
                this.set('mfgCostData', {});
                this.set('mfgCostResult', {});
                this.set('detailDirectLabor', []);
                this.set('detailIndirectLabor', []);
                this.set('detailProdDirect', []);
                this.set('detailLaborRelated', []);
                this.set('detailEtcMfg', []);
                this.set('detailDeprBldg', []);
                this.set('detailDeprLine', []);
                this.set('detailDeprEtc', []);
                this.set('detailOutsrc', []);
                this.set('detailMold', []);
            }
        });
    </script>
</dom-module>

<dom-module id="cc-diff-analysis">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            .tab-bar {
                display: flex;
                gap: 2px;
                border-bottom: 2px solid #6954FE;
                margin-bottom: 8px;
            }
            .tab-btn {
                padding: 8px 16px;
                border: none;
                background: #f0f1f5;
                cursor: pointer;
                font-size: 12px;
                border-radius: 4px 4px 0 0;
                white-space: nowrap;
            }
            .tab-btn:hover {
                background: #e0e1e8;
            }
            .tab-btn.active {
                background: #6954FE;
                color: #fff;
                font-weight: 600;
            }
            .detail-form-table {
                width: 100%;
                border-collapse: collapse;
            }
            .detail-form-table th {
                background: #f7f8fa;
                padding: 6px 10px;
                text-align: right;
                font-weight: 500;
                font-size: 12px;
                color: #555;
                border: 1px solid #e0e0e0;
                white-space: nowrap;
            }
            .detail-form-table td {
                padding: 4px 8px;
                border: 1px solid #e0e0e0;
            }
            .section-title {
                font-size: 13px;
                font-weight: 600;
                color: #333;
                padding: 8px 0 4px 0;
                border-bottom: 1px solid #ddd;
                margin-bottom: 8px;
            }
            .info-bar {
                display: flex;
                gap: 16px;
                padding: 6px 12px;
                background: #f8f9fc;
                border: 1px solid #e0e0e0;
                border-radius: 4px;
                margin-bottom: 8px;
                font-size: 12px;
            }
            .info-bar .info-item {
                display: flex;
                gap: 4px;
            }
            .info-bar .info-item label {
                font-weight: 600;
                color: #555;
            }
            .info-bar .info-item span {
                color: #30374F;
            }
        </style>

        <!-- CC 프로젝트 목록 Ajax -->
        <sc-ajax id="findPjtListAjax"
                 url="/bp/cost/cc/findListCurrentCostPjt.do"
                 body="{{pjtSearchParam}}"
                 on-response="onFindPjtListResponse">
        </sc-ajax>

        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->

        <!-- 프로젝트 정보 조회 -->
        <sc-ajax id="findPjtInfoAjax"
                 url="/bp/cost/cc/findCurrentCostPjt.do"
                 body="{{pjtInfoParam}}"
                 on-response="onFindPjtInfoResponse">
        </sc-ajax>

        <!-- 단계별 차이분석 조회 -->
        <sc-ajax id="findStepDiffAjax"
                 url="/bp/cost/cc/detail/findListDiffAnalysis.do"
                 body="{{stepSearchParam}}"
                 on-response="onFindStepDiffResponse">
        </sc-ajax>

        <!-- 단계별 차이분석 생성 -->
        <sc-ajax id="createStepDiffAjax"
                 url="/bp/cost/cc/detail/generateDiffAnalysis.do"
                 body="{{createParam}}"
                 on-response="onCreateStepDiffResponse">
        </sc-ajax>

        <!-- 단계별 차이분석 저장 -->
        <sc-ajax id="saveStepDiffAjax"
                 url="/bp/cost/cc/detail/saveListDiffAnalysis.do"
                 body="{{saveParam}}"
                 on-response="onSaveStepDiffResponse">
        </sc-ajax>

        <!-- 누적 차이분석 조회 -->
        <sc-ajax id="findCumDiffAjax"
                 url="/bp/cost/cc/detail/findListCumDiff.do"
                 body="{{cumSearchParam}}"
                 on-response="onFindCumDiffResponse">
        </sc-ajax>

        <!-- 좌우 분할 레이아웃 -->
        <div class="hbox flex">
            <!-- 좌측: CC 프로젝트 목록 -->
            <div class="vbox flex-3">
                <sc-search-container on-search="onFindPjtList" auth-code="V">
                    <table>
                        <colgroup>
                            <col style="width:80px"/><col/>
                        </colgroup>
                        <tr>
                            <th><sc-label text="프로젝트"></sc-label></th>
                            <td><sc-text-field value="{{pjtSearchParam.pjtCd}}" on-enter="onFindPjtList" placeholder="코드/명칭"></sc-text-field></td>
                        </tr>
                    </table>
                </sc-search-container>

                <sc-grid id="pjtGrid"
                         data-provider="{{pjtList}}"
                         selection-mode="radio"
                         on-item-click="onProjectClick"
                         class="flex">
                    <sc-grid-columns>
                        <sc-data-column data-field="pjtCd" header-text="프로젝트코드" width="120" text-align="center"></sc-data-column>
                        <sc-data-column data-field="pjtNm" header-text="프로젝트명" width="160"></sc-data-column>
                        <sc-data-column data-field="ccRev" header-text="차수" width="50" text-align="center"></sc-data-column>
                        <sc-data-column data-field="progStsNm" header-text="상태" width="70" text-align="center"></sc-data-column>
                    </sc-grid-columns>
                </sc-grid>
            </div>

            <div class="hspace-10"></div>

            <!-- 우측: 상세 콘텐츠 -->
            <div class="vbox flex-7" style="overflow:auto;">

        <!-- ============================================================
             프로젝트 정보 표시 영역
             ============================================================ -->
        <div class="info-bar">
            <div class="info-item">
                <label>프로젝트코드:</label>
                <span>{{pjtInfo.pjtCd}}</span>
            </div>
            <div class="info-item">
                <label>프로젝트명:</label>
                <span>{{pjtInfo.pjtNm}}</span>
            </div>
            <div class="info-item">
                <label>현상차수:</label>
                <span>{{pjtInfo.ccRev}}</span>
            </div>
            <div class="info-item">
                <label>사업부:</label>
                <span>{{pjtInfo.bizUnit}}</span>
            </div>
        </div>

        <!-- ============================================================
             탭 바
             ============================================================ -->
        <div class="tab-bar">
            <button class$="tab-btn {{_activeTab(activeTab,'STEP')}}"
                    on-click="_setTab" data-tab="STEP">단계별 차이분석</button>
            <button class$="tab-btn {{_activeTab(activeTab,'CUM')}}"
                    on-click="_setTab" data-tab="CUM">누적 차이분석</button>
        </div>

        <!-- ============================================================
             TAB 1: 단계별 차이분석 (STEP)
             ============================================================ -->
        <template is="dom-if" if="{{_isTab(activeTab,'STEP')}}">
            <sc-grid id="stepDiffGrid"
                     data-provider="{{stepDiffList}}"
                     editable="true"
                     class="flex"
                     on-cell-value-changed="_onStepCellChanged">

                <sc-toolbar>
                    <sc-button text="생성"  on-click="onCreateStepDiff"  auth-code="S"></sc-button>
                    <sc-button text="저장"  on-click="onSaveStepDiff"    auth-code="S"></sc-button>
                    <sc-button text="닫기"  on-click="onClose"           auth-code="V"></sc-button>
                </sc-toolbar>

                <sc-grid-columns>
                    <sc-data-column data-field="itemNm"
                                    header-text="원가항목"
                                    width="180"
                                    text-align="left"
                                    editable="false">
                    </sc-data-column>

                    <sc-data-column data-field="ecCostAmt"
                                    header-text="견적원가"
                                    width="130"
                                    text-align="right"
                                    data-type="number"
                                    format-type="amt"
                                    editable="false">
                    </sc-data-column>

                    <sc-data-column data-field="ccCostAmt"
                                    header-text="현상원가"
                                    width="130"
                                    text-align="right"
                                    data-type="number"
                                    format-type="amt"
                                    editable="true">
                    </sc-data-column>

                    <sc-data-column data-field="diffAmt"
                                    header-text="차이금액"
                                    width="130"
                                    text-align="right"
                                    data-type="number"
                                    format-type="amt"
                                    editable="false">
                    </sc-data-column>

                    <sc-data-column data-field="diffRate"
                                    header-text="차이율(%)"
                                    width="100"
                                    text-align="right"
                                    data-type="number"
                                    editable="false">
                    </sc-data-column>
                </sc-grid-columns>

                <sc-grid-fields>
                    <sc-grid-field data-field="ccPjtCd"></sc-grid-field>
                    <sc-grid-field data-field="ccRev"></sc-grid-field>
                    <sc-grid-field data-field="itemCd"></sc-grid-field>
                    <sc-grid-field data-field="itemLevel"></sc-grid-field>
                </sc-grid-fields>
            </sc-grid>
        </template>

        <!-- ============================================================
             TAB 2: 누적 차이분석 (CUM)
             ============================================================ -->
        <template is="dom-if" if="{{_isTab(activeTab,'CUM')}}">
            <sc-grid id="cumDiffGrid"
                     data-provider="{{cumDiffList}}"
                     editable="false"
                     class="flex">

                <sc-toolbar>
                    <sc-button text="닫기"  on-click="onClose"  auth-code="V"></sc-button>
                </sc-toolbar>

                <sc-grid-columns>
                    <sc-data-column data-field="itemNm"
                                    header-text="원가항목"
                                    width="180"
                                    text-align="left">
                    </sc-data-column>

                    <sc-data-column data-field="cumEcCostAmt"
                                    header-text="누적견적원가"
                                    width="140"
                                    text-align="right"
                                    data-type="number"
                                    format-type="amt">
                    </sc-data-column>

                    <sc-data-column data-field="cumCcCostAmt"
                                    header-text="누적현상원가"
                                    width="140"
                                    text-align="right"
                                    data-type="number"
                                    format-type="amt">
                    </sc-data-column>

                    <sc-data-column data-field="cumDiffAmt"
                                    header-text="누적차이금액"
                                    width="140"
                                    text-align="right"
                                    data-type="number"
                                    format-type="amt">
                    </sc-data-column>
                </sc-grid-columns>

                <sc-grid-fields>
                    <sc-grid-field data-field="ccPjtCd"></sc-grid-field>
                    <sc-grid-field data-field="ccRev"></sc-grid-field>
                    <sc-grid-field data-field="itemCd"></sc-grid-field>
                    <sc-grid-field data-field="itemLevel"></sc-grid-field>
                </sc-grid-fields>
            </sc-grid>
        </template>

            </div><!-- /vbox flex-7 (우측) -->
        </div><!-- /hbox flex (좌우분할) -->
    </template>

    <script>
        Polymer({
            is: 'cc-diff-analysis',

            properties: {
                /* ── URL 파라미터 ── */
                ccPjtCd: {
                    type: String,
                    value: ''
                },
                ccRev: {
                    type: String,
                    value: ''
                },

                /* ── 프로젝트 정보 ── */
                pjtInfo: {
                    type: Object,
                    value: function() { return {}; }
                },

                /* ── 활성 탭 ── */
                activeTab: {
                    type: String,
                    value: 'STEP'
                },

                /* ── 단계별 차이분석 데이터 ── */
                stepDiffList: {
                    type: Array,
                    value: function() { return []; }
                },

                /* ── 누적 차이분석 데이터 ── */
                cumDiffList: {
                    type: Array,
                    value: function() { return []; }
                },

                /* ── CC 프로젝트 목록 ── */
                pjtSearchParam: { type: Object, value: function() { return {}; } },
                pjtList:        { type: Array,  value: function() { return []; } },

                /* ── Ajax 파라미터 ── */
                pjtInfoParam:    { type: Object, value: function() { return {}; } },
                stepSearchParam: { type: Object, value: function() { return {}; } },
                cumSearchParam:  { type: Object, value: function() { return {}; } },
                createParam:     { type: Object, value: function() { return {}; } },
                saveParam:       { type: Object, value: function() { return {}; } }
            },

            /* ==============================================================
               라이프사이클 — 초기화
               ============================================================== */

            attached: function() {
                var param = UT.getParameter();
                if (param) {
                    this.ccPjtCd = param.ccPjtCd || '';
                    this.ccRev   = param.ccRev   || '';
                }
                this.$.findPjtListAjax.generateRequest();
                if (this.ccPjtCd) {
                    this._loadProjectData();
                }
            },

            /* ==============================================================
               CC 프로젝트 목록
               ============================================================== */

            onFindPjtList: function() {
                this.$.findPjtListAjax.generateRequest();
            },

            onFindPjtListResponse: function(e) {
                this.set('pjtList', e.detail.response || []);
            },

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row) return;
                this._clearDetail();
                this.ccPjtCd = row.pjtCd;
                this.ccRev   = row.ccRev || '';
                this._loadProjectData();
            },

            _loadProjectData: function() {
                this._loadPjtInfo();
                this._loadStepDiff();
            },

            _clearDetail: function() {
                this.set('pjtInfo', {});
                this.set('stepDiffList', []);
                this.set('cumDiffList', []);
                this.set('activeTab', 'STEP');
            },

            /* ==============================================================
               탭 제어 헬퍼
               ============================================================== */

            _activeTab: function(activeTab, tabName) {
                return activeTab === tabName ? 'active' : '';
            },

            _isTab: function(activeTab, tabName) {
                return activeTab === tabName;
            },

            _setTab: function(e) {
                var tabName = e.currentTarget.getAttribute('data-tab');
                this.set('activeTab', tabName);
                this._loadTabData(tabName);
            },

            _loadTabData: function(tabName) {
                switch (tabName) {
                    case 'STEP':
                        this._loadStepDiff();
                        break;
                    case 'CUM':
                        this._loadCumDiff();
                        break;
                }
            },

            /* ==============================================================
               프로젝트 정보 조회
               ============================================================== */

            _loadPjtInfo: function() {
                this.set('pjtInfoParam', {
                    ccPjtCd: this.ccPjtCd,
                    ccRev:   this.ccRev
                });
                this.$.findPjtInfoAjax.generateRequest();
            },

            onFindPjtInfoResponse: function(e) {
                var data = e.detail.response;
                if (data) {
                    this.set('pjtInfo', data);
                }
            },

            /* ==============================================================
               TAB 1: 단계별 차이분석 — 조회 / 생성 / 저장
               ============================================================== */

            _loadStepDiff: function() {
                this.set('stepSearchParam', {
                    ccPjtCd: this.ccPjtCd,
                    ccRev:   this.ccRev
                });
                this.$.findStepDiffAjax.generateRequest();
            },

            onFindStepDiffResponse: function(e) {
                var data = e.detail.response;
                if (data && Array.isArray(data)) {
                    this.set('stepDiffList', data);
                } else if (data && data.diffList) {
                    this.set('stepDiffList', data.diffList);
                } else {
                    this.set('stepDiffList', this._getDefaultDiffItems());
                }
            },

            /**
             * 단계별 차이분석 데이터 생성 (서버에서 EC/CC 데이터 기반으로 생성)
             */
            onCreateStepDiff: function() {
                if (!this.ccPjtCd) {
                    UT.alert('프로젝트 코드가 지정되지 않았습니다.');
                    return;
                }

                var me = this;
                UT.confirm('견적원가와 현상원가 기준으로 차이분석 데이터를 생성하시겠습니까?', function() {
                    me.set('createParam', {
                        ccPjtCd: me.ccPjtCd,
                        ccRev:   me.ccRev
                    });
                    me.$.createStepDiffAjax.generateRequest();
                });
            },

            onCreateStepDiffResponse: function(e) {
                UT.alert('차이분석 데이터가 생성되었습니다.');
                this._loadStepDiff();
            },

            /**
             * 현상원가 셀 값 변경 시 차이금액, 차이율 자동 계산
             */
            _onStepCellChanged: function(e) {
                var field = e.detail.dataField;
                if (field === 'ccCostAmt') {
                    var grid     = this.$$('#stepDiffGrid') || this.$['stepDiffGrid'];
                    if (!grid) return;
                    var rowIndex = e.detail.rowIndex;

                    var ecCost = Number(grid.getCellData(rowIndex, 'ecCostAmt')) || 0;
                    var ccCost = Number(grid.getCellData(rowIndex, 'ccCostAmt')) || 0;

                    // 차이금액 = 견적원가 - 현상원가
                    var diffAmt = ecCost - ccCost;
                    grid.setCellData(rowIndex, 'diffAmt', diffAmt);

                    // 차이율(%) = (차이금액 / 견적원가) * 100
                    var diffRate = 0;
                    if (ecCost !== 0) {
                        diffRate = Math.round(diffAmt / ecCost * 10000) / 100;
                    }
                    grid.setCellData(rowIndex, 'diffRate', diffRate);
                }
            },

            /**
             * 단계별 차이분석 저장
             */
            onSaveStepDiff: function() {
                var grid = this.$$('#stepDiffGrid') || this.$['stepDiffGrid'];
                if (!grid) return;

                var modifiedRows = grid.getModifiedRows();
                if (!modifiedRows || modifiedRows.length === 0) {
                    UT.alert('MSG_COM_00006');
                    return;
                }

                var me = this;
                UT.confirm('MSG_COM_00002', function() {
                    me.set('saveParam', {
                        ccPjtCd:  me.ccPjtCd,
                        ccRev:    me.ccRev,
                        saveList: modifiedRows
                    });
                    me.$.saveStepDiffAjax.generateRequest();
                });
            },

            onSaveStepDiffResponse: function() {
                UT.alert('MSG_COM_00003');
                this._loadStepDiff();
            },

            /* ==============================================================
               TAB 2: 누적 차이분석 — 조회 (읽기전용)
               ============================================================== */

            _loadCumDiff: function() {
                this.set('cumSearchParam', {
                    ccPjtCd: this.ccPjtCd,
                    ccRev:   this.ccRev
                });
                this.$.findCumDiffAjax.generateRequest();
            },

            onFindCumDiffResponse: function(e) {
                var data = e.detail.response;
                if (data && Array.isArray(data)) {
                    this.set('cumDiffList', data);
                } else if (data && data.diffList) {
                    this.set('cumDiffList', data.diffList);
                } else {
                    this.set('cumDiffList', this._getDefaultCumDiffItems());
                }
            },

            /* ==============================================================
               기본 항목 구조
               ============================================================== */

            /**
             * 단계별 차이분석 기본 P&L 항목 구조
             */
            _getDefaultDiffItems: function() {
                var items = [
                    { itemNm: '매출액',              itemCd: 'REVENUE',         itemLevel: 0 },
                    { itemNm: '재료비',              itemCd: 'MAT_COST',        itemLevel: 0 },
                    { itemNm: '노무비',              itemCd: 'LABOR_COST',      itemLevel: 0 },
                    { itemNm: '  직접노무비',        itemCd: 'DIRECT_LABOR',    itemLevel: 1 },
                    { itemNm: '  간접노무비',        itemCd: 'INDIRECT_LABOR',  itemLevel: 1 },
                    { itemNm: '제조경비',            itemCd: 'MFG_COST',        itemLevel: 0 },
                    { itemNm: '  생산직접경비',      itemCd: 'PROD_DIRECT',     itemLevel: 1 },
                    { itemNm: '  인건비성경비',      itemCd: 'LABOR_RELATED',   itemLevel: 1 },
                    { itemNm: '  기타제조경비',      itemCd: 'ETC_MFG',         itemLevel: 1 },
                    { itemNm: '  감가상각비(건구축물)', itemCd: 'DEPR_BLDG',    itemLevel: 1 },
                    { itemNm: '  감가상각비(생산라인)', itemCd: 'DEPR_LINE',    itemLevel: 1 },
                    { itemNm: '  감가상각비(기타)',    itemCd: 'DEPR_ETC',      itemLevel: 1 },
                    { itemNm: '  외주가공비',        itemCd: 'OUTSRC_COST',     itemLevel: 1 },
                    { itemNm: '  금형비',            itemCd: 'MOLD_COST',       itemLevel: 1 },
                    { itemNm: '  연구개발비',        itemCd: 'RND_COST',        itemLevel: 1 },
                    { itemNm: '  기타경비',          itemCd: 'ETC_COST',        itemLevel: 1 },
                    { itemNm: '판매관리비',          itemCd: 'SGA_COST',        itemLevel: 0 },
                    { itemNm: '영업이익',            itemCd: 'OPER_PROFIT',     itemLevel: 0 },
                    { itemNm: '영업이익률(%)',        itemCd: 'OPER_MARGIN',     itemLevel: 0 }
                ];
                for (var i = 0; i < items.length; i++) {
                    items[i].ecCostAmt = 0;
                    items[i].ccCostAmt = 0;
                    items[i].diffAmt   = 0;
                    items[i].diffRate  = 0;
                }
                return items;
            },

            /**
             * 누적 차이분석 기본 P&L 항목 구조
             */
            _getDefaultCumDiffItems: function() {
                var items = [
                    { itemNm: '매출액',              itemCd: 'REVENUE',         itemLevel: 0 },
                    { itemNm: '재료비',              itemCd: 'MAT_COST',        itemLevel: 0 },
                    { itemNm: '노무비',              itemCd: 'LABOR_COST',      itemLevel: 0 },
                    { itemNm: '  직접노무비',        itemCd: 'DIRECT_LABOR',    itemLevel: 1 },
                    { itemNm: '  간접노무비',        itemCd: 'INDIRECT_LABOR',  itemLevel: 1 },
                    { itemNm: '제조경비',            itemCd: 'MFG_COST',        itemLevel: 0 },
                    { itemNm: '  생산직접경비',      itemCd: 'PROD_DIRECT',     itemLevel: 1 },
                    { itemNm: '  인건비성경비',      itemCd: 'LABOR_RELATED',   itemLevel: 1 },
                    { itemNm: '  기타제조경비',      itemCd: 'ETC_MFG',         itemLevel: 1 },
                    { itemNm: '  감가상각비(건구축물)', itemCd: 'DEPR_BLDG',    itemLevel: 1 },
                    { itemNm: '  감가상각비(생산라인)', itemCd: 'DEPR_LINE',    itemLevel: 1 },
                    { itemNm: '  감가상각비(기타)',    itemCd: 'DEPR_ETC',      itemLevel: 1 },
                    { itemNm: '  외주가공비',        itemCd: 'OUTSRC_COST',     itemLevel: 1 },
                    { itemNm: '  금형비',            itemCd: 'MOLD_COST',       itemLevel: 1 },
                    { itemNm: '  연구개발비',        itemCd: 'RND_COST',        itemLevel: 1 },
                    { itemNm: '  기타경비',          itemCd: 'ETC_COST',        itemLevel: 1 },
                    { itemNm: '판매관리비',          itemCd: 'SGA_COST',        itemLevel: 0 },
                    { itemNm: '영업이익',            itemCd: 'OPER_PROFIT',     itemLevel: 0 },
                    { itemNm: '영업이익률(%)',        itemCd: 'OPER_MARGIN',     itemLevel: 0 }
                ];
                for (var i = 0; i < items.length; i++) {
                    items[i].cumEcCostAmt = 0;
                    items[i].cumCcCostAmt = 0;
                    items[i].cumDiffAmt   = 0;
                }
                return items;
            },

            /* ==============================================================
               닫기
               ============================================================== */

            onClose: function() {
                UT.navigateTo('es-current-cost-project-list');
            }
        });
    </script>
</dom-module>

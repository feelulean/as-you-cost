<dom-module id="ep-estimate-cost-search-popup">
    <template>
        <!-- Ajax -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/ec/findListEstimateCostPjt.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <!-- Search conditions -->
        <sc-search-container on-search="onSearch" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트 코드"></sc-label></th>
                    <td><sc-text-field value="{{searchParam.pjtCd}}" on-enter="onSearch"></sc-text-field></td>
                    <th><sc-label text="프로젝트명"></sc-label></th>
                    <td><sc-text-field value="{{searchParam.pjtNm}}" on-enter="onSearch"></sc-text-field></td>
                </tr>
                <tr>
                    <th><sc-label text="사업부"></sc-label></th>
                    <td><sc-text-field value="{{searchParam.bizUnit}}" on-enter="onSearch"></sc-text-field></td>
                    <th><sc-label text="고객사"></sc-label></th>
                    <td><sc-text-field value="{{searchParam.custNm}}" on-enter="onSearch"></sc-text-field></td>
                </tr>
            </table>
        </sc-search-container>

        <!-- Grid -->
        <sc-grid id="gridPanel"
                 data-provider="{{projectList}}"
                 selection-mode="radio"
                 on-item-dblclick="onRowDblClick"
                 style="height:350px">

            <sc-grid-columns>
                <sc-data-column data-field="pjtCd"    header-text="프로젝트 코드" width="120" text-align="center"></sc-data-column>
                <sc-data-column data-field="pjtNm"    header-text="프로젝트명"    width="200" text-align="left"></sc-data-column>
                <sc-data-column data-field="bizUnit"  header-text="사업부"        width="100" text-align="center"></sc-data-column>
                <sc-data-column data-field="custNm"   header-text="고객사"        width="120" text-align="left"></sc-data-column>
                <sc-data-column data-field="carType"  header-text="차종"          width="100" text-align="center"></sc-data-column>
                <sc-data-column data-field="oemNm"    header-text="OEM"           width="100" text-align="center"></sc-data-column>
                <sc-data-column data-field="prodGrp"  header-text="제품군"        width="100" text-align="center"></sc-data-column>
                <sc-data-column data-field="stsNm"    header-text="상태"          width="80"  text-align="center"></sc-data-column>
            </sc-grid-columns>
        </sc-grid>

        <!-- Buttons -->
        <div style="text-align:center; margin-top:10px;">
            <sc-button text="선택" on-click="onSelect"></sc-button>
            <sc-button text="닫기" on-click="onClose"></sc-button>
        </div>
    </template>

    <script>
        Polymer({
            is: 'ep-estimate-cost-search-popup',
            properties: {
                searchParam:  { type: Object, value: function() { return {}; } },
                projectList:  { type: Array,  value: function() { return []; } }
            },
            attached: function() {
                var param = UT.getParameter();
                if (param && param.pjtCd) this.set('searchParam.pjtCd', param.pjtCd);
                this.$.findListAjax.generateRequest();
            },
            onSearch: function() {
                this.$.findListAjax.generateRequest();
            },
            onFindListResponse: function(e) {
                this.set('projectList', e.detail.response || []);
            },
            onRowDblClick: function(e) {
                var row = e.detail.data || e.detail.row;
                if (row) this._returnResult(row);
            },
            onSelect: function() {
                var grid = this.$.gridPanel;
                var selectedRows = grid.getSelectedRows();
                if (!selectedRows || selectedRows.length === 0) {
                    UT.alert('프로젝트를 선택해 주세요.');
                    return;
                }
                this._returnResult(selectedRows[0]);
            },
            onClose: function() {
                window.close();
            },
            _returnResult: function(row) {
                sessionStorage.setItem('__UT_POPUP_RESULT__', JSON.stringify({
                    ecPjtCd: row.pjtCd,
                    pjtNm:   row.pjtNm,
                    bizUnit: row.bizUnit,
                    custNm:  row.custNm,
                    carType: row.carType,
                    oemNm:   row.oemNm,
                    prodGrp: row.prodGrp
                }));
                window.close();
            }
        });
    </script>
</dom-module>

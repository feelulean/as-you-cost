<dom-module id="es-pl-statement">
    <template>
        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/ec/findListEstimateCostPjt.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <sc-ajax id="findPlStmtAjax"
                 url="/bp/cost/ec/detail/findListPlStmt.do"
                 body="{{plSearchParam}}"
                 on-response="onFindPlStmtResponse">
        </sc-ajax>

        <sc-ajax id="calculatePlStmtAjax"
                 url="/bp/cost/ec/detail/calculatePlStmt.do"
                 body="{{calcParam}}"
                 on-response="onCalculatePlStmtResponse">
        </sc-ajax>

        <sc-ajax id="validateCalcAjax"
                 url="/bp/cost/ec/detail/validateCalcPrereq.do"
                 body="{{validateParam}}"
                 on-response="onValidateCalcResponse">
        </sc-ajax>

        <sc-ajax id="findCostGrpListAjax"
                 url="/bp/cost/ec/detail/findListCostGrp.do"
                 body="{{grpSearchParam}}"
                 on-response="onFindCostGrpListResponse">
        </sc-ajax>

        <sc-ajax id="findCostCodeListAjax"
                 url="/bp/cost/ec/detail/findListCostCode.do"
                 body="{{codeSearchParam}}"
                 on-response="onFindCostCodeListResponse">
        </sc-ajax>

        <style>
            .tab-btn { padding:6px 14px; border:none; background:#f0f1f5; cursor:pointer; font-size:12px; border-radius:4px 4px 0 0; }
            .tab-btn.active { background:#6954FE; color:#fff; font-weight:600; }
            .form-table { width:100%; border-collapse:collapse; }
            .form-table th { padding:8px 12px; background:#f8f9fc; text-align:left; font-weight:600; font-size:12px; width:140px; border:1px solid #e0e0e0; }
            .form-table td { padding:6px 12px; border:1px solid #e0e0e0; }
            .section-title { font-size:14px; font-weight:700; color:#30374F; padding:10px 0 8px; border-bottom:2px solid #6954FE; margin-bottom:8px; }
            .result-row { display:flex; gap:16px; margin-bottom:8px; }
            .result-item { flex:1; background:#f8f9fc; padding:12px; border-radius:6px; border:1px solid #e0e0e0; }
            .result-item label { font-size:11px; color:#667085; display:block; margin-bottom:4px; }
            .result-item .value { font-size:18px; font-weight:700; color:#30374F; }
            .filter-bar { display:flex; gap:12px; align-items:center; padding:8px 0; margin-bottom:8px; }
            .filter-bar .filter-label { font-size:12px; font-weight:600; color:#30374F; }
        </style>

        <!-- ============================================================
             조회 조건 영역
             ============================================================ -->
        <sc-search-container on-search="onFindList" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트 코드"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.pjtCd}}" on-enter="onFindList"></sc-text-field>
                    </td>
                    <th><sc-label text="사업부"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.bizUnit}}"
                                          items="{{codes.bizUnitList}}"
                                          display-field="label"
                                          value-field="data"
                                          placeholder="전체">
                        </sc-combobox-field>
                    </td>
                    <th><sc-label text="고객사"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.custNm}}"></sc-text-field>
                    </td>
                </tr>
            </table>
        </sc-search-container>

        <!-- ============================================================
             좌우 Split 레이아웃
             ============================================================ -->
        <div class="hbox flex">
            <!-- ========== 좌측: 프로젝트 목록 그리드 (flex-3) ========== -->
            <sc-grid id="gridPanel"
                     data-provider="{{resultList}}"
                     on-item-click="onProjectClick"
                     class="flex-3"
                     use-state="false">

                <sc-grid-columns>
                    <sc-data-column data-field="pjtCd"
                                    header-text="프로젝트 코드"
                                    width="130"
                                    text-align="center"
                                    on-item-click="onProjectClick">
                    </sc-data-column>

                    <sc-data-column data-field="pjtNm"
                                    header-text="프로젝트명"
                                    width="200"
                                    text-align="left">
                    </sc-data-column>

                    <sc-data-column data-field="bizUnit"
                                    header-text="사업부"
                                    width="100"
                                    text-align="center">
                    </sc-data-column>

                    <sc-data-column data-field="stsNm"
                                    header-text="상태"
                                    width="80"
                                    text-align="center">
                    </sc-data-column>
                </sc-grid-columns>
            </sc-grid>

            <div class="hspace-10"></div>

            <!-- ========== 우측: P&L 손익계산서 (flex-7) ========== -->
            <div class="vbox flex-7">
                <sc-toolbar>
                    <div class="filter-bar">
                        <span class="filter-label">유형</span>
                        <sc-combobox-field value="{{plParam.viewType}}"
                                          items="{{codes.viewTypeList}}"
                                          display-field="label"
                                          value-field="data"
                                          width="140"
                                          on-value-changed="_onViewTypeChanged">
                        </sc-combobox-field>

                        <!-- 원가그룹 선택 (유형=GRP일 때 표시) -->
                        <span class="filter-label" style$="{{_viewTypeDisplay(plParam.viewType, 'GRP')}}">원가그룹</span>
                        <sc-combobox-field value="{{plParam.costGrpCd}}"
                                          items="{{codes.costGrpList}}"
                                          display-field="label"
                                          value-field="data"
                                          width="160"
                                          placeholder="원가그룹 선택"
                                          style$="{{_viewTypeDisplay(plParam.viewType, 'GRP')}}">
                        </sc-combobox-field>

                        <!-- 원가코드 선택 (유형=CODE일 때 표시) -->
                        <span class="filter-label" style$="{{_viewTypeDisplay(plParam.viewType, 'CODE')}}">원가코드</span>
                        <sc-combobox-field value="{{plParam.costCd}}"
                                          items="{{codes.costCodeList}}"
                                          display-field="label"
                                          value-field="data"
                                          width="160"
                                          placeholder="원가코드 선택"
                                          style$="{{_viewTypeDisplay(plParam.viewType, 'CODE')}}">
                        </sc-combobox-field>

                        <span class="filter-label">기준</span>
                        <sc-combobox-field value="{{plParam.basisType}}"
                                          items="{{codes.basisTypeList}}"
                                          display-field="label"
                                          value-field="data"
                                          width="120">
                        </sc-combobox-field>
                    </div>
                    <sc-button text="조회"         on-click="onFindPlStmt"      auth-code="V"></sc-button>
                    <sc-button text="데이터 점검"   on-click="onValidateCalc"    auth-code="V"></sc-button>
                    <sc-button text="견적원가 산출" on-click="onCalculatePlStmt" auth-code="S"></sc-button>
                </sc-toolbar>

                <!-- P&L 손익계산서 그리드 -->
                <sc-panel title-text="견적원가 손익계산서 (P&L Statement) (단위: {{baseCurrency}})" class="flex">
                    <sc-grid id="plGrid"
                             data-provider="{{plResultList}}"
                             editable="false"
                             class="flex">

                        <sc-grid-columns>
                            <sc-data-column data-field="itemNm"
                                            header-text="항목"
                                            width="160"
                                            text-align="left">
                            </sc-data-column>

                            <sc-data-column data-field="sopYear"
                                            header-text="SOP Year"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y1"
                                            header-text="Y+1"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y2"
                                            header-text="Y+2"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y3"
                                            header-text="Y+3"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y4"
                                            header-text="Y+4"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y5"
                                            header-text="Y+5"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="totalAmt"
                                            header-text="TOTAL"
                                            width="140"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>
                        </sc-grid-columns>
                    </sc-grid>
                </sc-panel>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'es-pl-statement',

            properties: {
                // 조회 조건 파라미터
                searchParam: {
                    type: Object,
                    value: function() { return {}; }
                },
                // 좌측 프로젝트 그리드 데이터
                resultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // 선택된 프로젝트 코드
                selectedPjtCd: {
                    type: String,
                    value: ''
                },
                // 기준통화
                baseCurrency: {
                    type: String,
                    value: 'KRW'
                },
                // P&L 조회 파라미터
                plParam: {
                    type: Object,
                    value: function() {
                        return {
                            viewType:  'PJT',
                            basisType: 'UNIT',
                            costGrpCd: '',
                            costCd:    ''
                        };
                    }
                },
                // P&L 결과 그리드 데이터
                plResultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // Ajax 파라미터
                plSearchParam:  { type: Object, value: function() { return {}; } },
                calcParam:      { type: Object, value: function() { return {}; } },
                grpSearchParam: { type: Object, value: function() { return {}; } },
                codeSearchParam:{ type: Object, value: function() { return {}; } },
                // 공통코드
                codes: {
                    type: Object,
                    value: function() {
                        return {
                            viewTypeList: [
                                { label: '프로젝트',  data: 'PJT' },
                                { label: '원가그룹',  data: 'GRP' },
                                { label: '원가코드',  data: 'CODE' }
                            ],
                            basisTypeList: [
                                { label: '단위당', data: 'UNIT' },
                                { label: '총액',   data: 'TOTAL' }
                            ],
                            costGrpList:  [],
                            costCodeList: []
                        };
                    }
                }
            },

            attached: function() {
                var me = this;
                UT.loadCodes({ bizUnitList: 'T004' }, function(codes) {
                    var merged = Object.assign({}, me.codes, codes);
                    me.set('codes', merged);
                });
                this.onFindList();
            },

            /* ==============================================================
               프로젝트 목록 조회 (좌측 그리드)
               ============================================================== */

            onFindList: function() {
                this._clearDetail();
                this.$.findListAjax.generateRequest();
            },

            onFindListResponse: function(e) {
                this.set('resultList', e.detail.response);
            },

            /* ==============================================================
               프로젝트 선택 → 우측 P&L 데이터 로드
               ============================================================== */

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row || !row.pjtCd) return;

                this.set('selectedPjtCd', row.pjtCd);
                this.set('baseCurrency', row.baseCurrency || 'KRW');
                this._loadCostGrpList();
                this._loadCostCodeList();
                this._loadPlStmt();
            },

            /* ==============================================================
               P&L 손익계산서 조회
               ============================================================== */

            onFindPlStmt: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                var vt = this.plParam.viewType;
                if (vt === 'GRP' && !this.plParam.costGrpCd) {
                    UT.alert('원가그룹을 선택해 주세요.');
                    return;
                }
                if (vt === 'CODE' && !this.plParam.costCd) {
                    UT.alert('원가코드를 선택해 주세요.');
                    return;
                }
                this._loadPlStmt();
            },

            _loadPlStmt: function() {
                this.set('plSearchParam', {
                    ecPjtCd:   this.selectedPjtCd,
                    viewType:  this.plParam.viewType,
                    basisType: this.plParam.basisType,
                    costGrpCd: this.plParam.costGrpCd || '',
                    costCd:    this.plParam.costCd || ''
                });
                this.$.findPlStmtAjax.generateRequest();
            },

            onFindPlStmtResponse: function(e) {
                var data = e.detail.response;
                if (data && data.plList) {
                    this.set('plResultList', data.plList);
                } else {
                    // 기본 P&L 항목 구조 초기화
                    this.set('plResultList', this._getDefaultPlItems());
                }
            },

            /**
             * P&L 기본 항목 구조 반환
             * - 매출액, 재료비, 노무비, 제조경비, 제조원가합계,
             *   매출총이익, 판매관리비, 영업이익, 영업이익률(%)
             */
            _getDefaultPlItems: function() {
                var items = [
                    { itemNm: '매출액',       itemCd: 'REVENUE' },
                    { itemNm: '재료비',       itemCd: 'MAT_COST' },
                    { itemNm: '노무비',       itemCd: 'LABOR_COST' },
                    { itemNm: '제조경비',     itemCd: 'MFG_COST' },
                    { itemNm: '제조원가합계', itemCd: 'MFG_TOTAL' },
                    { itemNm: '매출총이익',   itemCd: 'GROSS_PROFIT' },
                    { itemNm: '판매관리비',   itemCd: 'SGA_COST' },
                    { itemNm: '영업이익',     itemCd: 'OPER_PROFIT' },
                    { itemNm: '영업이익률(%)', itemCd: 'OPER_MARGIN' }
                ];
                for (var i = 0; i < items.length; i++) {
                    items[i].sopYear = 0;
                    items[i].y1 = 0;
                    items[i].y2 = 0;
                    items[i].y3 = 0;
                    items[i].y4 = 0;
                    items[i].y5 = 0;
                    items[i].totalAmt = 0;
                }
                return items;
            },

            /* ==============================================================
               견적원가 산출
               ============================================================== */

            /* ── 데이터 점검 (Validation) ── */
            onValidateCalc: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                this.set('validateParam', { ecPjtCd: this.selectedPjtCd });
                this._validateMode = 'CHECK';
                this.$.validateCalcAjax.generateRequest();
            },

            onValidateCalcResponse: function(e) {
                var data = e.detail.response;
                if (!data || data.status !== 'OK') return;

                var msgs = data.messages || [];
                if (msgs.length === 0) {
                    if (this._validateMode === 'CALC') {
                        this._doCalculate();
                    } else {
                        UT.alert(data.summary);
                    }
                    return;
                }

                // 검증 결과 메시지 구성
                var lines = [];
                var icons = { 'ERROR': '[오류]', 'WARNING': '[경고]', 'INFO': '[참고]' };
                for (var i = 0; i < msgs.length; i++) {
                    var m = msgs[i];
                    lines.push(icons[m.level] + ' ' + m.category + ': ' + m.message);
                }
                var summary = data.summary + '\n\n' + lines.join('\n');

                if (this._validateMode === 'CALC') {
                    if (data.errorCount > 0) {
                        UT.alert('계산을 수행할 수 없습니다.\n\n' + summary);
                    } else {
                        var me = this;
                        UT.confirm(summary + '\n\n계속 산출하시겠습니까?', function() {
                            me._doCalculate();
                        });
                    }
                } else {
                    UT.alert(summary);
                }
            },

            onCalculatePlStmt: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                // 산출 전 자동 점검
                this.set('validateParam', { ecPjtCd: this.selectedPjtCd });
                this._validateMode = 'CALC';
                this.$.validateCalcAjax.generateRequest();
            },

            _doCalculate: function() {
                var me = this;
                me.set('calcParam', {
                    ecPjtCd:   me.selectedPjtCd,
                    viewType:  me.plParam.viewType,
                    basisType: me.plParam.basisType,
                    costGrpCd: me.plParam.costGrpCd || '',
                    costCd:    me.plParam.costCd || ''
                });
                me.$.calculatePlStmtAjax.generateRequest();
            },

            onCalculatePlStmtResponse: function(e) {
                var data = e.detail.response;
                if (data && data.status === 'FAIL') {
                    UT.alert(data.message);
                    return;
                }
                if (data && data.plList) {
                    this.set('plResultList', data.plList);
                }
                UT.alert('견적원가 산출이 완료되었습니다.');
            },

            /* ==============================================================
               원가그룹/원가코드 목록 로드
               ============================================================== */

            _loadCostGrpList: function() {
                this.set('grpSearchParam', { ecPjtCd: this.selectedPjtCd });
                this.$.findCostGrpListAjax.generateRequest();
            },

            onFindCostGrpListResponse: function(e) {
                var list = e.detail.response || [];
                var items = [];
                for (var i = 0; i < list.length; i++) {
                    var desc = list[i].costGrpDesc;
                    var grp  = list[i].costGrp;
                    items.push({
                        label: desc ? grp + ' - ' + desc : grp,
                        data:  grp
                    });
                }
                this.set('codes.costGrpList', items);
            },

            _loadCostCodeList: function() {
                this.set('codeSearchParam', { ecPjtCd: this.selectedPjtCd });
                this.$.findCostCodeListAjax.generateRequest();
            },

            onFindCostCodeListResponse: function(e) {
                var list = e.detail.response || [];
                var items = [];
                for (var i = 0; i < list.length; i++) {
                    var grpLabel = list[i].costGrpDesc || list[i].costGrp || '';
                    var codeLabel = list[i].costCd;
                    items.push({
                        label: grpLabel ? codeLabel + ' (' + grpLabel + ')' : codeLabel,
                        data:  list[i].costCd
                    });
                }
                this.set('codes.costCodeList', items);
            },

            /* ==============================================================
               유형 변경 핸들러
               ============================================================== */

            _onViewTypeChanged: function() {
                this.set('plParam.costGrpCd', '');
                this.set('plParam.costCd', '');
                this.set('plParam.basisType', 'UNIT');

                // 유형 변경 시 원가그룹/원가코드 목록 재로딩 (데이터 확보)
                if (this.selectedPjtCd) {
                    if (this.plParam.viewType === 'GRP' && (!this.codes.costGrpList || this.codes.costGrpList.length === 0)) {
                        this._loadCostGrpList();
                    }
                    if (this.plParam.viewType === 'CODE' && (!this.codes.costCodeList || this.codes.costCodeList.length === 0)) {
                        this._loadCostCodeList();
                    }
                }
            },

            _isViewType: function(viewType, target) {
                return viewType === target;
            },

            _hideForViewType: function(viewType, target) {
                return viewType !== target;
            },

            _viewTypeDisplay: function(viewType, target) {
                return viewType === target ? '' : 'display:none';
            },

            _clearDetail: function() {
                this.set('selectedPjtCd', '');
                this.set('baseCurrency', 'KRW');
                this.set('plResultList', []);
                this.set('codes.costGrpList', []);
                this.set('codes.costCodeList', []);
                this.set('plParam', {
                    viewType: 'PJT', basisType: 'UNIT',
                    costGrpCd: '', costCd: ''
                });
            }
        });
    </script>
</dom-module>

<dom-module id="es-pl-statement">
    <template>
        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/ec/findListEstimateCostPjt.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <sc-ajax id="findPlStmtAjax"
                 url="/bp/cost/ec/detail/findListPlStmt.do"
                 body="{{plSearchParam}}"
                 on-response="onFindPlStmtResponse">
        </sc-ajax>

        <sc-ajax id="calculatePlStmtAjax"
                 url="/bp/cost/ec/detail/calculatePlStmt.do"
                 body="{{calcParam}}"
                 on-response="onCalculatePlStmtResponse">
        </sc-ajax>

        <style>
            .tab-btn { padding:6px 14px; border:none; background:#f0f1f5; cursor:pointer; font-size:12px; border-radius:4px 4px 0 0; }
            .tab-btn.active { background:#6954FE; color:#fff; font-weight:600; }
            .form-table { width:100%; border-collapse:collapse; }
            .form-table th { padding:8px 12px; background:#f8f9fc; text-align:left; font-weight:600; font-size:12px; width:140px; border:1px solid #e0e0e0; }
            .form-table td { padding:6px 12px; border:1px solid #e0e0e0; }
            .section-title { font-size:14px; font-weight:700; color:#30374F; padding:10px 0 8px; border-bottom:2px solid #6954FE; margin-bottom:8px; }
            .result-row { display:flex; gap:16px; margin-bottom:8px; }
            .result-item { flex:1; background:#f8f9fc; padding:12px; border-radius:6px; border:1px solid #e0e0e0; }
            .result-item label { font-size:11px; color:#667085; display:block; margin-bottom:4px; }
            .result-item .value { font-size:18px; font-weight:700; color:#30374F; }
            .filter-bar { display:flex; gap:12px; align-items:center; padding:8px 0; margin-bottom:8px; }
            .filter-bar .filter-label { font-size:12px; font-weight:600; color:#30374F; }
        </style>

        <!-- ============================================================
             조회 조건 영역
             ============================================================ -->
        <sc-search-container on-search="onFindList" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트 코드"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.pjtCd}}" on-enter="onFindList"></sc-text-field>
                    </td>
                    <th><sc-label text="사업부"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.bizUnit}}"
                                          items="{{codes.bizUnitList}}"
                                          display-field="label"
                                          value-field="data"
                                          placeholder="전체">
                        </sc-combobox-field>
                    </td>
                    <th><sc-label text="고객사"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.custNm}}"></sc-text-field>
                    </td>
                </tr>
            </table>
        </sc-search-container>

        <!-- ============================================================
             좌우 Split 레이아웃
             ============================================================ -->
        <div class="hbox flex">
            <!-- ========== 좌측: 프로젝트 목록 그리드 (flex-3) ========== -->
            <sc-grid id="gridPanel"
                     data-provider="{{resultList}}"
                     on-item-click="onProjectClick"
                     class="flex-3"
                     use-state="false">

                <sc-grid-columns>
                    <sc-data-column data-field="pjtCd"
                                    header-text="프로젝트 코드"
                                    width="130"
                                    text-align="center"
                                    on-item-click="onProjectClick">
                    </sc-data-column>

                    <sc-data-column data-field="pjtNm"
                                    header-text="프로젝트명"
                                    width="200"
                                    text-align="left">
                    </sc-data-column>

                    <sc-data-column data-field="bizUnit"
                                    header-text="사업부"
                                    width="100"
                                    text-align="center">
                    </sc-data-column>

                    <sc-data-column data-field="stsNm"
                                    header-text="상태"
                                    width="80"
                                    text-align="center">
                    </sc-data-column>
                </sc-grid-columns>
            </sc-grid>

            <div class="hspace-10"></div>

            <!-- ========== 우측: P&L 손익계산서 (flex-7) ========== -->
            <div class="vbox flex-7">
                <sc-toolbar>
                    <div class="filter-bar">
                        <span class="filter-label">유형</span>
                        <sc-combobox-field value="{{plParam.viewType}}"
                                          items="{{codes.viewTypeList}}"
                                          display-field="label"
                                          value-field="data"
                                          width="140">
                        </sc-combobox-field>
                        <span class="filter-label">기준</span>
                        <sc-combobox-field value="{{plParam.basisType}}"
                                          items="{{codes.basisTypeList}}"
                                          display-field="label"
                                          value-field="data"
                                          width="120">
                        </sc-combobox-field>
                    </div>
                    <sc-button text="조회"         on-click="onFindPlStmt"      auth-code="V"></sc-button>
                    <sc-button text="견적원가 산출" on-click="onCalculatePlStmt" auth-code="S"></sc-button>
                </sc-toolbar>

                <!-- P&L 손익계산서 그리드 -->
                <sc-panel title-text="견적원가 손익계산서 (P&L Statement) (단위: {{baseCurrency}})" class="flex">
                    <sc-grid id="plGrid"
                             data-provider="{{plResultList}}"
                             editable="false"
                             class="flex">

                        <sc-grid-columns>
                            <sc-data-column data-field="itemNm"
                                            header-text="항목"
                                            width="160"
                                            text-align="left">
                            </sc-data-column>

                            <sc-data-column data-field="sopYear"
                                            header-text="SOP Year"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y1"
                                            header-text="Y+1"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y2"
                                            header-text="Y+2"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y3"
                                            header-text="Y+3"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y4"
                                            header-text="Y+4"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="y5"
                                            header-text="Y+5"
                                            width="120"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>

                            <sc-data-column data-field="totalAmt"
                                            header-text="TOTAL"
                                            width="140"
                                            text-align="right"
                                            data-type="number"
                                            format-type="amt">
                            </sc-data-column>
                        </sc-grid-columns>
                    </sc-grid>
                </sc-panel>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'es-pl-statement',

            properties: {
                // 조회 조건 파라미터
                searchParam: {
                    type: Object,
                    value: function() { return {}; }
                },
                // 좌측 프로젝트 그리드 데이터
                resultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // 선택된 프로젝트 코드
                selectedPjtCd: {
                    type: String,
                    value: ''
                },
                // 기준통화
                baseCurrency: {
                    type: String,
                    value: 'KRW'
                },
                // P&L 조회 파라미터
                plParam: {
                    type: Object,
                    value: function() {
                        return {
                            viewType:  'PJT',
                            basisType: 'UNIT'
                        };
                    }
                },
                // P&L 결과 그리드 데이터
                plResultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // Ajax 파라미터
                plSearchParam: { type: Object, value: function() { return {}; } },
                calcParam:     { type: Object, value: function() { return {}; } },
                // 공통코드
                codes: {
                    type: Object,
                    value: function() {
                        return {
                            viewTypeList: [
                                { label: '프로젝트',  data: 'PJT' },
                                { label: '원가그룹',  data: 'GRP' },
                                { label: '원가코드',  data: 'CODE' }
                            ],
                            basisTypeList: [
                                { label: '단위당', data: 'UNIT' },
                                { label: '총액',   data: 'TOTAL' }
                            ]
                        };
                    }
                }
            },

            attached: function() {
                var me = this;
                UT.loadCodes({ bizUnitList: 'T004' }, function(codes) {
                    var merged = Object.assign({}, me.codes, codes);
                    me.set('codes', merged);
                });
                this.onFindList();
            },

            /* ==============================================================
               프로젝트 목록 조회 (좌측 그리드)
               ============================================================== */

            onFindList: function() {
                this._clearDetail();
                this.$.findListAjax.generateRequest();
            },

            onFindListResponse: function(e) {
                this.set('resultList', e.detail.response);
            },

            /* ==============================================================
               프로젝트 선택 → 우측 P&L 데이터 로드
               ============================================================== */

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row || !row.pjtCd) return;

                this.set('selectedPjtCd', row.pjtCd);
                this.set('baseCurrency', row.baseCurrency || 'KRW');
                this._loadPlStmt();
            },

            /* ==============================================================
               P&L 손익계산서 조회
               ============================================================== */

            onFindPlStmt: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                this._loadPlStmt();
            },

            _loadPlStmt: function() {
                this.set('plSearchParam', {
                    ecPjtCd:   this.selectedPjtCd,
                    viewType:  this.plParam.viewType,
                    basisType: this.plParam.basisType
                });
                this.$.findPlStmtAjax.generateRequest();
            },

            onFindPlStmtResponse: function(e) {
                var data = e.detail.response;
                if (data && data.plList) {
                    this.set('plResultList', data.plList);
                } else {
                    // 기본 P&L 항목 구조 초기화
                    this.set('plResultList', this._getDefaultPlItems());
                }
            },

            /**
             * P&L 기본 항목 구조 반환
             * - 매출액, 재료비, 노무비, 제조경비, 제조원가합계,
             *   매출총이익, 판매관리비, 영업이익, 영업이익률(%)
             */
            _getDefaultPlItems: function() {
                var items = [
                    { itemNm: '매출액',       itemCd: 'REVENUE' },
                    { itemNm: '재료비',       itemCd: 'MAT_COST' },
                    { itemNm: '노무비',       itemCd: 'LABOR_COST' },
                    { itemNm: '제조경비',     itemCd: 'MFG_COST' },
                    { itemNm: '제조원가합계', itemCd: 'MFG_TOTAL' },
                    { itemNm: '매출총이익',   itemCd: 'GROSS_PROFIT' },
                    { itemNm: '판매관리비',   itemCd: 'SGA_COST' },
                    { itemNm: '영업이익',     itemCd: 'OPER_PROFIT' },
                    { itemNm: '영업이익률(%)', itemCd: 'OPER_MARGIN' }
                ];
                for (var i = 0; i < items.length; i++) {
                    items[i].sopYear = 0;
                    items[i].y1 = 0;
                    items[i].y2 = 0;
                    items[i].y3 = 0;
                    items[i].y4 = 0;
                    items[i].y5 = 0;
                    items[i].totalAmt = 0;
                }
                return items;
            },

            /* ==============================================================
               견적원가 산출
               ============================================================== */

            onCalculatePlStmt: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                var me = this;
                UT.confirm('견적원가를 산출하시겠습니까?', function() {
                    me.set('calcParam', {
                        ecPjtCd:   me.selectedPjtCd,
                        viewType:  me.plParam.viewType,
                        basisType: me.plParam.basisType
                    });
                    me.$.calculatePlStmtAjax.generateRequest();
                });
            },

            onCalculatePlStmtResponse: function(e) {
                var data = e.detail.response;
                if (data && data.status === 'FAIL') {
                    UT.alert(data.message);
                    return;
                }
                if (data && data.plList) {
                    this.set('plResultList', data.plList);
                }
                UT.alert('견적원가 산출이 완료되었습니다.');
            },

            _clearDetail: function() {
                this.set('selectedPjtCd', '');
                this.set('baseCurrency', 'KRW');
                this.set('plResultList', []);
            }
        });
    </script>
</dom-module>

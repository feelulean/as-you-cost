<dom-module id="cc-actual-eval">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            .tab-bar {
                display: flex;
                gap: 2px;
                border-bottom: 2px solid #6954FE;
                margin-bottom: 8px;
            }
            .tab-btn {
                padding: 8px 16px;
                border: none;
                background: #f0f1f5;
                cursor: pointer;
                font-size: 12px;
                border-radius: 4px 4px 0 0;
                white-space: nowrap;
            }
            .tab-btn:hover {
                background: #e0e1e8;
            }
            .tab-btn.active {
                background: #6954FE;
                color: #fff;
                font-weight: 600;
            }
            .detail-form-table {
                width: 100%;
                border-collapse: collapse;
            }
            .detail-form-table th {
                background: #f7f8fa;
                padding: 6px 10px;
                text-align: right;
                font-weight: 500;
                font-size: 12px;
                color: #555;
                border: 1px solid #e0e0e0;
                white-space: nowrap;
            }
            .detail-form-table td {
                padding: 4px 8px;
                border: 1px solid #e0e0e0;
                font-size: 12px;
            }
            .section-title {
                font-size: 13px;
                font-weight: 600;
                color: #333;
                padding: 8px 0 4px 0;
                border-bottom: 1px solid #ddd;
                margin-bottom: 8px;
            }
            .info-bar {
                display: flex;
                gap: 16px;
                padding: 6px 12px;
                background: #f8f9fc;
                border: 1px solid #e0e0e0;
                border-radius: 4px;
                margin-bottom: 8px;
                font-size: 12px;
            }
            .info-bar .info-item {
                display: flex;
                gap: 4px;
            }
            .info-bar .info-item label {
                font-weight: 600;
                color: #555;
            }
            .info-bar .info-item span {
                color: #30374F;
            }
            .left-panel {
                width: 300px;
                min-width: 280px;
                border-right: 1px solid #e0e0e0;
                padding-right: 10px;
                display: flex;
                flex-direction: column;
            }
            .right-panel {
                flex: 1;
                padding-left: 10px;
                display: flex;
                flex-direction: column;
                overflow: auto;
            }
            .main-layout {
                display: flex;
                flex: 1;
                overflow: hidden;
            }
            .left-section {
                margin-bottom: 12px;
            }
            .left-section .section-label {
                font-size: 12px;
                font-weight: 600;
                color: #30374F;
                margin-bottom: 6px;
            }
            .part-grid-wrapper {
                flex: 1;
                min-height: 120px;
            }
        </style>

        <!-- CC 프로젝트 목록 Ajax -->
        <sc-ajax id="findPjtListAjax"
                 url="/bp/cost/cc/findListCurrentCostPjt.do"
                 body="{{pjtSearchParam}}"
                 on-response="onFindPjtListResponse">
        </sc-ajax>

        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->

        <!-- 프로젝트 정보 조회 -->
        <sc-ajax id="findPjtInfoAjax"
                 url="/bp/cost/cc/findCurrentCostPjt.do"
                 body="{{pjtInfoParam}}"
                 on-response="onFindPjtInfoResponse">
        </sc-ajax>

        <!-- 목표원가코드 목록 조회 -->
        <sc-ajax id="findTgtCostCodeListAjax"
                 url="/bp/cost/cc/detail/findListTgtCostCode.do"
                 body="{{tgtCodeSearchParam}}"
                 on-response="onFindTgtCostCodeListResponse">
        </sc-ajax>

        <!-- 품번코드 목록 조회 -->
        <sc-ajax id="findPartListAjax"
                 url="/bp/cost/cc/detail/findListActPart.do"
                 body="{{partSearchParam}}"
                 on-response="onFindPartListResponse">
        </sc-ajax>

        <!-- 품번코드 저장 -->
        <sc-ajax id="savePartListAjax"
                 url="/bp/cost/cc/detail/saveListActPart.do"
                 body="{{savePartParam}}"
                 on-response="onSavePartListResponse">
        </sc-ajax>

        <!-- 실적 재료비 추정 조회 -->
        <sc-ajax id="findActMaterialAjax"
                 url="/bp/cost/cc/detail/findListActMaterial.do"
                 body="{{matSearchParam}}"
                 on-response="onFindActMaterialResponse">
        </sc-ajax>

        <!-- 실적 재료비 추정 계산 -->
        <sc-ajax id="calcActMaterialAjax"
                 url="/bp/cost/cc/detail/calculateActMaterial.do"
                 body="{{calcMatParam}}"
                 on-response="onCalcActMaterialResponse">
        </sc-ajax>

        <!-- 실적 재료비 추정 저장 -->
        <sc-ajax id="saveActMaterialAjax"
                 url="/bp/cost/cc/detail/saveListActMaterial.do"
                 body="{{saveMatParam}}"
                 on-response="onSaveActMaterialResponse">
        </sc-ajax>

        <!-- 실적 달성도 평가 조회 -->
        <sc-ajax id="findActEvalAjax"
                 url="/bp/cost/cc/detail/findListActEval.do"
                 body="{{evalSearchParam}}"
                 on-response="onFindActEvalResponse">
        </sc-ajax>

        <!-- 좌우 분할 레이아웃 -->
        <div class="hbox flex">
            <!-- 좌측: CC 프로젝트 목록 -->
            <div class="vbox" style="width:260px; min-width:240px;">
                <sc-search-container on-search="onFindPjtList" auth-code="V">
                    <table>
                        <colgroup>
                            <col style="width:70px"/><col/>
                        </colgroup>
                        <tr>
                            <th><sc-label text="프로젝트"></sc-label></th>
                            <td><sc-text-field value="{{pjtSearchParam.pjtCd}}" on-enter="onFindPjtList" placeholder="코드/명칭"></sc-text-field></td>
                        </tr>
                    </table>
                </sc-search-container>

                <sc-grid id="pjtGrid"
                         data-provider="{{pjtList}}"
                         selection-mode="radio"
                         on-item-click="onProjectClick"
                         class="flex">
                    <sc-grid-columns>
                        <sc-data-column data-field="pjtCd" header-text="프로젝트코드" width="110" text-align="center"></sc-data-column>
                        <sc-data-column data-field="pjtNm" header-text="프로젝트명" width="140"></sc-data-column>
                    </sc-grid-columns>
                </sc-grid>
            </div>

            <div class="hspace-10"></div>

            <!-- 우측: 기존 콘텐츠 -->
            <div class="vbox flex" style="overflow:auto;">

        <!-- ============================================================
             프로젝트 정보 표시
             ============================================================ -->
        <div class="info-bar">
            <div class="info-item">
                <label>프로젝트코드:</label>
                <span>{{pjtInfo.ccPjtCd}}</span>
            </div>
            <div class="info-item">
                <label>프로젝트명:</label>
                <span>{{pjtInfo.pjtNm}}</span>
            </div>
            <div class="info-item">
                <label>현상차수:</label>
                <span>{{pjtInfo.ccRev}}</span>
            </div>
        </div>

        <!-- ============================================================
             좌우 Split 레이아웃
             ============================================================ -->
        <div class="main-layout">

            <!-- ========== 좌측: 목표원가코드 선택 + 품번코드 ========== -->
            <div class="left-panel">

                <!-- 목표원가코드 선택 -->
                <div class="left-section">
                    <div class="section-label">목표원가코드</div>
                    <sc-combobox-field value="{{selectedTgtCostCd}}"
                                      items="{{codes.tgtCostCodeList}}"
                                      display-field="label"
                                      value-field="data"
                                      placeholder="목표원가코드 선택"
                                      on-value-changed="_onTgtCostCodeChanged">
                    </sc-combobox-field>
                </div>

                <!-- 품번코드 입력 -->
                <div class="section-title">품번코드</div>

                <div class="part-grid-wrapper">
                    <sc-grid id="partGrid"
                             data-provider="{{partList}}"
                             editable="true"
                             style="height:100%;">

                        <sc-toolbar>
                            <sc-button text="추가"  on-click="onAddPartRow"   auth-code="S"></sc-button>
                            <sc-button text="저장"  on-click="onSavePartList" auth-code="S"></sc-button>
                        </sc-toolbar>

                        <sc-grid-columns>
                            <sc-data-column data-field="seqNo"
                                            header-text="No"
                                            width="40"
                                            text-align="center"
                                            editable="false">
                            </sc-data-column>

                            <sc-data-column data-field="partCd"
                                            header-text="품번"
                                            width="120"
                                            text-align="center"
                                            editable="true"
                                            required="true">
                            </sc-data-column>

                            <sc-data-column data-field="partNm"
                                            header-text="품명"
                                            width="120"
                                            text-align="left"
                                            editable="true">
                            </sc-data-column>
                        </sc-grid-columns>

                        <sc-grid-fields>
                            <sc-grid-field data-field="ccPjtCd"></sc-grid-field>
                            <sc-grid-field data-field="ccRev"></sc-grid-field>
                            <sc-grid-field data-field="tgtCostCd"></sc-grid-field>
                            <sc-grid-field data-field="partSeq"></sc-grid-field>
                        </sc-grid-fields>
                    </sc-grid>
                </div>
            </div>

            <!-- ========== 우측: 실적 재료비 추정 + 실적 달성도 평가 ========== -->
            <div class="right-panel">

                <!-- Section 1: 실적 재료비 추정 -->
                <div class="section-title">실적 재료비 추정</div>

                <sc-grid id="actMaterialGrid"
                         data-provider="{{actMaterialList}}"
                         editable="true"
                         style="min-height:200px; flex:1;"
                         on-cell-value-changed="_onMaterialCellChanged">

                    <sc-toolbar>
                        <sc-button text="계산"  on-click="onCalcActMaterial"  auth-code="S"></sc-button>
                        <sc-button text="저장"  on-click="onSaveActMaterial"  auth-code="S"></sc-button>
                    </sc-toolbar>

                    <sc-grid-columns>
                        <sc-data-column data-field="seqNo"
                                        header-text="순번"
                                        width="50"
                                        text-align="center"
                                        editable="false">
                        </sc-data-column>

                        <sc-data-column data-field="partCd"
                                        header-text="품번"
                                        width="100"
                                        text-align="center"
                                        editable="false">
                        </sc-data-column>

                        <sc-data-column data-field="partNm"
                                        header-text="품명"
                                        width="120"
                                        text-align="left"
                                        editable="false">
                        </sc-data-column>

                        <sc-data-column data-field="pimsCurrency"
                                        header-text="PIMS통화"
                                        width="80"
                                        text-align="center"
                                        editable="false">
                        </sc-data-column>

                        <sc-data-column data-field="pimsUnitPrice"
                                        header-text="PIMS단가"
                                        width="110"
                                        text-align="right"
                                        data-type="number"
                                        format="#,###.##"
                                        editable="false">
                        </sc-data-column>

                        <sc-combobox-column data-field="evalCurrency"
                                           header-text="평가용통화"
                                           width="100"
                                           editable="true"
                                           items="{{codes.currencyList}}"
                                           display-field="label"
                                           value-field="data">
                        </sc-combobox-column>

                        <sc-data-column data-field="exchRate"
                                        header-text="환율"
                                        width="90"
                                        text-align="right"
                                        data-type="number"
                                        format="#,###.##"
                                        editable="true">
                        </sc-data-column>

                        <sc-data-column data-field="evalUnitPrice"
                                        header-text="평가용단가"
                                        width="110"
                                        text-align="right"
                                        data-type="number"
                                        format="#,###.##"
                                        editable="true">
                        </sc-data-column>

                        <sc-data-column data-field="estMatCost"
                                        header-text="추정재료비"
                                        width="120"
                                        text-align="right"
                                        data-type="number"
                                        format-type="amt"
                                        editable="false">
                        </sc-data-column>
                    </sc-grid-columns>

                    <sc-grid-fields>
                        <sc-grid-field data-field="ccPjtCd"></sc-grid-field>
                        <sc-grid-field data-field="ccRev"></sc-grid-field>
                        <sc-grid-field data-field="tgtCostCd"></sc-grid-field>
                        <sc-grid-field data-field="matSeq"></sc-grid-field>
                    </sc-grid-fields>
                </sc-grid>

                <!-- Section 2: 실적 달성도 평가 -->
                <div class="section-title" style="margin-top:12px;">실적 달성도 평가</div>

                <sc-grid id="actEvalGrid"
                         data-provider="{{actEvalList}}"
                         editable="false"
                         style="min-height:200px; flex:1;">

                    <sc-grid-columns>
                        <sc-data-column data-field="itemNm"
                                        header-text="원가항목"
                                        width="160"
                                        text-align="left">
                        </sc-data-column>

                        <sc-data-column data-field="ecCostAmt"
                                        header-text="견적원가"
                                        width="120"
                                        text-align="right"
                                        data-type="number"
                                        format-type="amt">
                        </sc-data-column>

                        <sc-data-column data-field="tgtCostAmt"
                                        header-text="목표원가"
                                        width="120"
                                        text-align="right"
                                        data-type="number"
                                        format-type="amt">
                        </sc-data-column>

                        <sc-data-column data-field="saveTgtAmt"
                                        header-text="절감목표"
                                        width="120"
                                        text-align="right"
                                        data-type="number"
                                        format-type="amt">
                        </sc-data-column>

                        <sc-data-column data-field="actCostAmt"
                                        header-text="실적원가"
                                        width="120"
                                        text-align="right"
                                        data-type="number"
                                        format-type="amt">
                        </sc-data-column>

                        <sc-data-column data-field="saveActAmt"
                                        header-text="절감액"
                                        width="120"
                                        text-align="right"
                                        data-type="number"
                                        format-type="amt">
                        </sc-data-column>

                        <sc-data-column data-field="achvRate"
                                        header-text="달성도(%)"
                                        width="100"
                                        text-align="right"
                                        data-type="number">
                        </sc-data-column>

                        <sc-data-column data-field="achvYn"
                                        header-text="달성여부"
                                        width="80"
                                        text-align="center">
                        </sc-data-column>
                    </sc-grid-columns>

                    <sc-grid-fields>
                        <sc-grid-field data-field="ccPjtCd"></sc-grid-field>
                        <sc-grid-field data-field="ccRev"></sc-grid-field>
                        <sc-grid-field data-field="tgtCostCd"></sc-grid-field>
                        <sc-grid-field data-field="itemCd"></sc-grid-field>
                    </sc-grid-fields>
                </sc-grid>
            </div>
        </div>

            </div><!-- /vbox flex (우측) -->
        </div><!-- /hbox flex (좌우분할) -->
    </template>

    <script>
        Polymer({
            is: 'cc-actual-eval',

            properties: {
                /* ── URL 파라미터 ── */
                ccPjtCd: {
                    type: String,
                    value: ''
                },
                ccRev: {
                    type: String,
                    value: ''
                },

                /* ── 프로젝트 정보 ── */
                pjtInfo: {
                    type: Object,
                    value: function() { return {}; }
                },

                /* ── 선택된 목표원가코드 ── */
                selectedTgtCostCd: {
                    type: String,
                    value: ''
                },

                /* ── 품번코드 목록 ── */
                partList: {
                    type: Array,
                    value: function() { return []; }
                },

                /* ── 실적 재료비 추정 데이터 ── */
                actMaterialList: {
                    type: Array,
                    value: function() { return []; }
                },

                /* ── 실적 달성도 평가 데이터 ── */
                actEvalList: {
                    type: Array,
                    value: function() { return []; }
                },

                /* ── CC 프로젝트 목록 ── */
                pjtSearchParam: { type: Object, value: function() { return {}; } },
                pjtList:        { type: Array,  value: function() { return []; } },

                /* ── Ajax 파라미터 ── */
                pjtInfoParam:       { type: Object, value: function() { return {}; } },
                tgtCodeSearchParam: { type: Object, value: function() { return {}; } },
                partSearchParam:    { type: Object, value: function() { return {}; } },
                savePartParam:      { type: Object, value: function() { return {}; } },
                matSearchParam:     { type: Object, value: function() { return {}; } },
                calcMatParam:       { type: Object, value: function() { return {}; } },
                saveMatParam:       { type: Object, value: function() { return {}; } },
                evalSearchParam:    { type: Object, value: function() { return {}; } },

                /* ── 공통코드 ── */
                codes: {
                    type: Object,
                    value: function() {
                        return {
                            tgtCostCodeList: [],
                            currencyList: [
                                { label: 'KRW', data: 'KRW' },
                                { label: 'USD', data: 'USD' },
                                { label: 'EUR', data: 'EUR' },
                                { label: 'JPY', data: 'JPY' },
                                { label: 'CNY', data: 'CNY' }
                            ]
                        };
                    }
                }
            },

            /* ==============================================================
               라이프사이클 — 초기화
               ============================================================== */

            attached: function() {
                var param = UT.getParameter();
                if (param) {
                    this.ccPjtCd = param.ccPjtCd || '';
                    this.ccRev   = param.ccRev   || '';
                }
                this.$.findPjtListAjax.generateRequest();
                if (this.ccPjtCd) {
                    this._loadProjectData();
                }
            },

            /* ==============================================================
               CC 프로젝트 목록
               ============================================================== */

            onFindPjtList: function() {
                this.$.findPjtListAjax.generateRequest();
            },

            onFindPjtListResponse: function(e) {
                this.set('pjtList', e.detail.response || []);
            },

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row) return;
                this._clearDetail();
                this.ccPjtCd = row.pjtCd;
                this.ccRev   = row.ccRev || '';
                this._loadProjectData();
            },

            _loadProjectData: function() {
                this._loadPjtInfo();
                this._loadTgtCostCodeList();
            },

            _clearDetail: function() {
                this.set('pjtInfo', {});
                this.set('selectedTgtCostCd', '');
                this.set('partList', []);
                this.set('actMaterialList', []);
                this.set('actEvalList', []);
                this.set('codes.tgtCostCodeList', []);
            },

            /* ==============================================================
               프로젝트 정보 조회
               ============================================================== */

            _loadPjtInfo: function() {
                this.set('pjtInfoParam', {
                    ccPjtCd: this.ccPjtCd,
                    ccRev:   this.ccRev
                });
                this.$.findPjtInfoAjax.generateRequest();
            },

            onFindPjtInfoResponse: function(e) {
                var data = e.detail.response;
                if (data) {
                    this.set('pjtInfo', data);
                }
            },

            /* ==============================================================
               목표원가코드 목록 조회
               ============================================================== */

            _loadTgtCostCodeList: function() {
                this.set('tgtCodeSearchParam', {
                    ccPjtCd: this.ccPjtCd,
                    ccRev:   this.ccRev
                });
                this.$.findTgtCostCodeListAjax.generateRequest();
            },

            onFindTgtCostCodeListResponse: function(e) {
                var list = e.detail.response || [];
                var items = [];
                for (var i = 0; i < list.length; i++) {
                    items.push({
                        label: list[i].tgtCostNm || list[i].tgtCostCd,
                        data:  list[i].tgtCostCd
                    });
                }
                this.set('codes.tgtCostCodeList', items);
            },

            /* ==============================================================
               목표원가코드 선택 변경
               ============================================================== */

            _onTgtCostCodeChanged: function() {
                if (!this.selectedTgtCostCd) return;
                this._loadPartList();
                this._loadActMaterial();
                this._loadActEval();
            },

            /* ==============================================================
               품번코드 — 조회 / 추가 / 저장
               ============================================================== */

            _loadPartList: function() {
                this.set('partSearchParam', {
                    ccPjtCd:    this.ccPjtCd,
                    ccRev:      this.ccRev,
                    tgtCostCd:  this.selectedTgtCostCd
                });
                this.$.findPartListAjax.generateRequest();
            },

            onFindPartListResponse: function(e) {
                var data = e.detail.response;
                if (data && Array.isArray(data)) {
                    this.set('partList', data);
                } else if (data && data.partList) {
                    this.set('partList', data.partList);
                } else {
                    this.set('partList', []);
                }
            },

            onAddPartRow: function() {
                if (!this.selectedTgtCostCd) {
                    UT.alert('목표원가코드를 먼저 선택해 주세요.');
                    return;
                }

                var grid = this.$.partGrid;
                if (!grid) return;

                var seqNo = (this.partList ? this.partList.length : 0) + 1;
                grid.insertRow(0, {
                    ccPjtCd:    this.ccPjtCd,
                    ccRev:      this.ccRev,
                    tgtCostCd:  this.selectedTgtCostCd,
                    seqNo:      seqNo,
                    partCd:     '',
                    partNm:     ''
                });
            },

            onSavePartList: function() {
                if (!this.selectedTgtCostCd) {
                    UT.alert('목표원가코드를 먼저 선택해 주세요.');
                    return;
                }

                var grid = this.$.partGrid;
                if (!grid) return;

                var modifiedRows = grid.getModifiedRows();
                if (!modifiedRows || modifiedRows.length === 0) {
                    UT.alert('MSG_COM_00006');
                    return;
                }

                // 품번 필수값 검증
                for (var i = 0; i < modifiedRows.length; i++) {
                    if (!modifiedRows[i].partCd) {
                        UT.alert('품번을 입력해 주세요.');
                        return;
                    }
                }

                var me = this;
                UT.confirm('MSG_COM_00002', function() {
                    me.set('savePartParam', {
                        ccPjtCd:    me.ccPjtCd,
                        ccRev:      me.ccRev,
                        tgtCostCd:  me.selectedTgtCostCd,
                        saveList:   modifiedRows
                    });
                    me.$.savePartListAjax.generateRequest();
                });
            },

            onSavePartListResponse: function() {
                UT.alert('MSG_COM_00003');
                this._loadPartList();
            },

            /* ==============================================================
               실적 재료비 추정 — 조회 / 계산 / 저장
               ============================================================== */

            _loadActMaterial: function() {
                this.set('matSearchParam', {
                    ccPjtCd:    this.ccPjtCd,
                    ccRev:      this.ccRev,
                    tgtCostCd:  this.selectedTgtCostCd
                });
                this.$.findActMaterialAjax.generateRequest();
            },

            onFindActMaterialResponse: function(e) {
                var data = e.detail.response;
                if (data && Array.isArray(data)) {
                    this.set('actMaterialList', data);
                } else if (data && data.materialList) {
                    this.set('actMaterialList', data.materialList);
                } else {
                    this.set('actMaterialList', []);
                }
            },

            /**
             * 재료비 셀 값 변경 시 추정재료비 자동 계산
             * 추정재료비 = 평가용단가 * 환율 (PIMS단가와 무관하게 평가용 기준)
             */
            _onMaterialCellChanged: function(e) {
                var field = e.detail.dataField;
                if (field === 'evalUnitPrice' || field === 'exchRate' || field === 'evalCurrency') {
                    var grid = this.$.actMaterialGrid;
                    if (!grid) return;
                    var rowIndex = e.detail.rowIndex;

                    var evalUnitPrice = Number(grid.getCellData(rowIndex, 'evalUnitPrice')) || 0;
                    var exchRate      = Number(grid.getCellData(rowIndex, 'exchRate'))      || 1;

                    // 추정재료비 = 평가용단가 x 환율
                    var estMatCost = Math.round(evalUnitPrice * exchRate * 100) / 100;
                    grid.setCellData(rowIndex, 'estMatCost', estMatCost);
                }
            },

            /**
             * 계산 버튼 — 서버에 재료비 계산 요청
             * PIMS 단가 및 환율 기반으로 재료비를 일괄 재계산
             */
            onCalcActMaterial: function() {
                if (!this.selectedTgtCostCd) {
                    UT.alert('목표원가코드를 먼저 선택해 주세요.');
                    return;
                }

                var me = this;
                UT.confirm('실적 재료비를 계산하시겠습니까?', function() {
                    me.set('calcMatParam', {
                        ccPjtCd:    me.ccPjtCd,
                        ccRev:      me.ccRev,
                        tgtCostCd:  me.selectedTgtCostCd
                    });
                    me.$.calcActMaterialAjax.generateRequest();
                });
            },

            onCalcActMaterialResponse: function(e) {
                var data = e.detail.response;
                if (data && Array.isArray(data)) {
                    this.set('actMaterialList', data);
                } else if (data && data.materialList) {
                    this.set('actMaterialList', data.materialList);
                }
                UT.alert('실적 재료비 계산이 완료되었습니다.');
                // 재료비 계산 후 실적 달성도 평가도 재조회
                this._loadActEval();
            },

            /**
             * 실적 재료비 추정 저장
             */
            onSaveActMaterial: function() {
                if (!this.selectedTgtCostCd) {
                    UT.alert('목표원가코드를 먼저 선택해 주세요.');
                    return;
                }

                var grid = this.$.actMaterialGrid;
                if (!grid) return;

                var modifiedRows = grid.getModifiedRows();
                if (!modifiedRows || modifiedRows.length === 0) {
                    UT.alert('MSG_COM_00006');
                    return;
                }

                var me = this;
                UT.confirm('MSG_COM_00002', function() {
                    me.set('saveMatParam', {
                        ccPjtCd:    me.ccPjtCd,
                        ccRev:      me.ccRev,
                        tgtCostCd:  me.selectedTgtCostCd,
                        saveList:   modifiedRows
                    });
                    me.$.saveActMaterialAjax.generateRequest();
                });
            },

            onSaveActMaterialResponse: function() {
                UT.alert('MSG_COM_00003');
                this._loadActMaterial();
            },

            /* ==============================================================
               실적 달성도 평가 — 조회 (읽기전용, 자동 계산 결과)
               ============================================================== */

            _loadActEval: function() {
                this.set('evalSearchParam', {
                    ccPjtCd:    this.ccPjtCd,
                    ccRev:      this.ccRev,
                    tgtCostCd:  this.selectedTgtCostCd
                });
                this.$.findActEvalAjax.generateRequest();
            },

            onFindActEvalResponse: function(e) {
                var data = e.detail.response;
                if (data && Array.isArray(data)) {
                    this.set('actEvalList', data);
                } else if (data && data.evalList) {
                    this.set('actEvalList', data.evalList);
                } else {
                    this.set('actEvalList', this._getDefaultEvalItems());
                }
            },

            /**
             * 실적 달성도 평가 기본 항목 구조
             */
            _getDefaultEvalItems: function() {
                var items = [
                    { itemNm: '매출액',          itemCd: 'REVENUE' },
                    { itemNm: '재료비',          itemCd: 'MAT_COST' },
                    { itemNm: '노무비',          itemCd: 'LABOR_COST' },
                    { itemNm: '  직접노무비',    itemCd: 'DIRECT_LABOR' },
                    { itemNm: '  간접노무비',    itemCd: 'INDIRECT_LABOR' },
                    { itemNm: '제조경비',        itemCd: 'MFG_COST' },
                    { itemNm: '  생산직접경비',  itemCd: 'PROD_DIRECT' },
                    { itemNm: '  인건비성경비',  itemCd: 'LABOR_RELATED' },
                    { itemNm: '  기타제조경비',  itemCd: 'ETC_MFG' },
                    { itemNm: '  외주가공비',    itemCd: 'OUTSRC_COST' },
                    { itemNm: '  금형비',        itemCd: 'MOLD_COST' },
                    { itemNm: '판매관리비',      itemCd: 'SGA_COST' },
                    { itemNm: '영업이익',        itemCd: 'OPER_PROFIT' },
                    { itemNm: '영업이익률(%)',    itemCd: 'OPER_MARGIN' }
                ];
                for (var i = 0; i < items.length; i++) {
                    items[i].ecCostAmt  = 0;
                    items[i].tgtCostAmt = 0;
                    items[i].saveTgtAmt = 0;
                    items[i].actCostAmt = 0;
                    items[i].saveActAmt = 0;
                    items[i].achvRate   = 0;
                    items[i].achvYn     = '';
                }
                return items;
            }
        });
    </script>
</dom-module>

<dom-module id="es-ec-profit-mgt">
    <template>
        <!-- ============================================================
             Ajax 선언부
             ============================================================ -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/ec/profit/findListEcPjtForProfit.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <sc-ajax id="findProfitAjax"
                 url="/bp/cost/ec/profit/findEcProfit.do"
                 body="{{profitSearchParam}}"
                 on-response="onFindProfitResponse">
        </sc-ajax>

        <sc-ajax id="aggregateMatCostAjax"
                 url="/bp/cost/ec/profit/aggregateMaterialCost.do"
                 body="{{aggregateParam}}"
                 on-response="onAggregateMatCostResponse">
        </sc-ajax>

        <sc-ajax id="saveProfitAjax"
                 url="/bp/cost/ec/profit/saveEcProfit.do"
                 body="{{saveParam}}"
                 on-response="onSaveProfitResponse">
        </sc-ajax>

        <!-- ============================================================
             조회 조건 영역
             ============================================================ -->
        <sc-search-container on-search="onFindList" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:120px"/><col/>
                    <col style="width:120px"/><col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트 코드"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.pjtCd}}" on-enter="onFindList"></sc-text-field>
                    </td>
                    <th><sc-label text="고객사"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.custNm}}"></sc-text-field>
                    </td>
                </tr>
            </table>
        </sc-search-container>

        <!-- ============================================================
             좌우 Split 레이아웃
             ============================================================ -->
        <div class="hbox flex">
            <!-- ========== 좌측: 프로젝트 목록 그리드 (flex-4) ========== -->
            <sc-grid id="gridPanel"
                     data-provider="{{resultList}}"
                     on-item-click="onProjectClick"
                     class="flex-4"
                     use-state="false">

                <sc-grid-columns>
                    <sc-data-column data-field="pjtCd"
                                    header-text="프로젝트 코드"
                                    width="130"
                                    text-align="center"
                                    on-item-click="onProjectClick">
                    </sc-data-column>

                    <sc-data-column data-field="pjtNm"
                                    header-text="프로젝트명"
                                    width="200"
                                    text-align="left">
                    </sc-data-column>

                    <sc-data-column data-field="custNm"
                                    header-text="고객사"
                                    width="120">
                    </sc-data-column>

                    <sc-data-column data-field="stsNm"
                                    header-text="상태"
                                    width="80"
                                    text-align="center">
                    </sc-data-column>
                </sc-grid-columns>
            </sc-grid>

            <div class="hspace-10"></div>

            <!-- ========== 우측: 원가 요약 + WACC 분석 (flex-6) ========== -->
            <div class="vbox flex-6">
                <sc-toolbar>
                    <sc-button text="재료비 취합(BOM)" on-click="onAggregateMaterialCost" auth-code="S"></sc-button>
                    <sc-button text="WACC 계산"        on-click="onCalculateWacc"          auth-code="V"></sc-button>
                    <sc-button text="저장"             on-click="onSaveProfitData"         auth-code="S"></sc-button>
                </sc-toolbar>

                <!-- 견적기준가 (표준원가) 요약 패널 -->
                <sc-panel title-text="견적기준가 (표준원가) 요약" class="flex-5">
                    <table class="tb-form">
                        <colgroup>
                            <col style="width:150px"/><col/>
                            <col style="width:150px"/><col/>
                        </colgroup>
                        <tr>
                            <th><sc-label text="재료비 (BOM 연계)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.matCost}}"
                                                 format-type="amt" readonly="true">
                                </sc-number-field>
                            </td>
                            <th><sc-label text="노무비"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.laborCost}}"
                                                 format-type="amt"
                                                 on-change="_onCostFieldChanged">
                                </sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="제조경비/감가상각비"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.mfgCost}}"
                                                 format-type="amt"
                                                 on-change="_onCostFieldChanged">
                                </sc-number-field>
                            </td>
                            <th><sc-label text="판관비"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.sgaCost}}"
                                                 format-type="amt"
                                                 on-change="_onCostFieldChanged">
                                </sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="총 견적원가"></sc-label></th>
                            <td colspan="3">
                                <sc-number-field value="{{profitData.totalEstmCost}}"
                                                 format-type="amt" readonly="true"
                                                 class="font-bold">
                                </sc-number-field>
                            </td>
                        </tr>
                    </table>
                </sc-panel>

                <!-- 수익성 분석 Factor (WACC) 패널 -->
                <sc-panel title-text="수익성 분석 Factor (WACC)" class="flex-5">
                    <table class="tb-form">
                        <colgroup>
                            <col style="width:180px"/><col/>
                            <col style="width:180px"/><col/>
                        </colgroup>
                        <tr>
                            <th><sc-label text="타인자본비용 (Kd, %)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.kdRate}}"></sc-number-field>
                            </td>
                            <th><sc-label text="법인세율 (t, %)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.taxRate}}"></sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="부채 (B)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.debtAmt}}" format-type="amt"></sc-number-field>
                            </td>
                            <th><sc-label text="자기자본 (S)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.equityAmt}}" format-type="amt"></sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="무위험이자율 (Rf, %)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.rfRate}}"></sc-number-field>
                            </td>
                            <th><sc-label text="시장기대수익률 (E(Rm), %)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.ermRate}}"></sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="베타 (Beta)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.betaVal}}"></sc-number-field>
                            </td>
                            <th><sc-label text="자기자본비용 (Ke, %)"></sc-label></th>
                            <td>
                                <sc-number-field value="{{profitData.keRate}}" readonly="true"></sc-number-field>
                            </td>
                        </tr>
                        <tr>
                            <th><sc-label text="WACC (%)"></sc-label></th>
                            <td colspan="3">
                                <sc-number-field value="{{profitData.waccRate}}"
                                                 readonly="true" class="font-bold">
                                </sc-number-field>
                            </td>
                        </tr>
                    </table>
                </sc-panel>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'es-ec-profit-mgt',

            properties: {
                // 조회 조건
                searchParam: {
                    type: Object,
                    value: function() { return {}; }
                },
                // 좌측 그리드 데이터
                resultList: {
                    type: Array,
                    value: function() { return []; }
                },
                // 선택된 프로젝트 코드
                selectedPjtCd: {
                    type: String,
                    value: ''
                },
                // 우측 폼 데이터
                profitData: {
                    type: Object,
                    value: function() { return {}; }
                },
                // Ajax 파라미터
                profitSearchParam: { type: Object, value: function() { return {}; } },
                aggregateParam:    { type: Object, value: function() { return {}; } },
                saveParam:         { type: Object, value: function() { return {}; } }
            },

            /* ==============================================================
               프로젝트 목록 조회 (좌측 그리드)
               ============================================================== */

            onFindList: function() {
                this.$.findListAjax.generateRequest();
            },

            onFindListResponse: function(e) {
                this.set('resultList', e.detail.response);
            },

            /* ==============================================================
               프로젝트 선택 → 우측 상세 로드
               ============================================================== */

            onProjectClick: function(e) {
                var row = e.detail.data;
                if (!row || !row.pjtCd) return;

                this.set('selectedPjtCd', row.pjtCd);
                this.set('selectedSts', row.sts || 'T');
                this._readOnly = (row.sts && row.sts !== 'T');
                this.set('profitSearchParam', { ecPjtCd: row.pjtCd });
                this.$.findProfitAjax.generateRequest();
            },

            onFindProfitResponse: function(e) {
                var data = e.detail.response;
                if (data && data.ecPjtCd) {
                    this.set('profitData', data);
                } else {
                    // 수익성 데이터 미등록 → 빈 폼 초기화
                    this.set('profitData', {
                        ecPjtCd:       this.selectedPjtCd,
                        matCost:       0,
                        laborCost:     0,
                        mfgCost:       0,
                        sgaCost:       0,
                        totalEstmCost: 0,
                        kdRate:        0,
                        taxRate:       0,
                        debtAmt:       0,
                        equityAmt:     0,
                        rfRate:        0,
                        ermRate:       0,
                        betaVal:       0,
                        keRate:        0,
                        waccRate:      0
                    });
                }
            },

            /* ==============================================================
               재료비 취합 (BOM → PCM_EC_BOM 합계 조회)
               ============================================================== */

            onAggregateMaterialCost: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                if (this._readOnly) {
                    UT.alert('진행 중인 프로젝트의 수익성 데이터는 수정할 수 없습니다.\n작성중(T) 상태의 프로젝트만 수정 가능합니다.');
                    return;
                }
                this.set('aggregateParam', { ecPjtCd: this.selectedPjtCd });
                this.$.aggregateMatCostAjax.generateRequest();
            },

            onAggregateMatCostResponse: function(e) {
                var result = e.detail.response;
                var matCost = Number(result.totalMatCost) || 0;
                this.set('profitData.matCost', matCost);
                this._recalcTotalEstmCost();
                UT.alert('BOM 재료비 KRW ' + matCost.toLocaleString() + '이 반영되었습니다.');
            },

            /* ==============================================================
               원가 항목 변경 시 총 견적원가 자동 합산
               ============================================================== */

            _onCostFieldChanged: function() {
                this._recalcTotalEstmCost();
            },

            /**
             * 총 견적원가 = 재료비 + 노무비 + 제조경비 + 판관비
             */
            _recalcTotalEstmCost: function() {
                var d = this.profitData;
                var total = (Number(d.matCost) || 0)
                          + (Number(d.laborCost) || 0)
                          + (Number(d.mfgCost) || 0)
                          + (Number(d.sgaCost) || 0);
                this.set('profitData.totalEstmCost', total);
            },

            /* ==============================================================
               WACC 계산 — CAPM + 가중평균자본비용 공식
               ============================================================== */

            /**
             * WACC 계산 (2단계 공식)
             *
             * [1단계] 자기자본비용 (CAPM)
             *   Ke = Rf + Beta × (E(Rm) - Rf)
             *
             * [2단계] 가중평균자본비용 (WACC)
             *   WACC = Kd × (1 - t) × [B / (B + S)] + Ke × [S / (B + S)]
             *
             * ※ 입력값이 % 단위이므로 소수점 변환(÷100) 후 연산,
             *   최종 결과를 다시 % 단위로 복원(×100) 하여 표시한다.
             */
            onCalculateWacc: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }

                var d = this.profitData;

                // 입력값 추출 (% → 소수 변환)
                var Kd   = (Number(d.kdRate)  || 0) / 100;   // 타인자본비용
                var t    = (Number(d.taxRate) || 0) / 100;    // 법인세율
                var Rf   = (Number(d.rfRate)  || 0) / 100;    // 무위험이자율
                var ERm  = (Number(d.ermRate) || 0) / 100;    // 시장기대수익률
                var Beta = Number(d.betaVal)  || 0;           // 베타 (배수, 변환 불요)
                var B    = Number(d.debtAmt)   || 0;          // 부채
                var S    = Number(d.equityAmt) || 0;          // 자기자본

                // 검증: 부채 + 자본 > 0
                if ((B + S) <= 0) {
                    UT.alert('부채(B)와 자기자본(S)의 합계가 0보다 커야 합니다.');
                    return;
                }

                // ──────────────────────────────────────────────
                // [1단계] CAPM: 자기자본비용 (Ke)
                //   Ke = Rf + Beta × (E(Rm) - Rf)
                // ──────────────────────────────────────────────
                var Ke = Rf + Beta * (ERm - Rf);

                // ──────────────────────────────────────────────
                // [2단계] WACC: 가중평균자본비용
                //   WACC = Kd × (1 - t) × [B / (B+S)]
                //        + Ke × [S / (B+S)]
                // ──────────────────────────────────────────────
                var totalCapital = B + S;
                var debtWeight   = B / totalCapital;   // 부채 비중
                var equityWeight = S / totalCapital;    // 자본 비중

                var WACC = Kd * (1 - t) * debtWeight
                         + Ke * equityWeight;

                // 소수 → % 복원 (소수점 2자리 반올림)
                var kePercent   = Math.round(Ke   * 10000) / 100;
                var waccPercent = Math.round(WACC * 10000) / 100;

                // 결과 바인딩
                this.set('profitData.keRate',   kePercent);
                this.set('profitData.waccRate', waccPercent);

                // 총 견적원가 재합산 (원가 항목 변경 시를 대비)
                this._recalcTotalEstmCost();

                UT.alert('WACC 계산 완료: Ke=' + kePercent + '%, WACC=' + waccPercent + '%');
            },

            /* ==============================================================
               저장
               ============================================================== */

            onSaveProfitData: function() {
                if (!this.selectedPjtCd) {
                    UT.alert('좌측 그리드에서 프로젝트를 선택해 주세요.');
                    return;
                }
                if (this._readOnly) {
                    UT.alert('진행 중인 프로젝트의 수익성 데이터는 수정할 수 없습니다.\n작성중(T) 상태의 프로젝트만 수정 가능합니다.');
                    return;
                }

                this._recalcTotalEstmCost();

                var me = this;
                UT.confirm('MSG_COM_00002', function() {
                    me.set('saveParam', me.profitData);
                    me.$.saveProfitAjax.generateRequest();
                });
            },

            onSaveProfitResponse: function() {
                UT.alert('MSG_COM_00003');
            }
        });
    </script>
</dom-module>

<dom-module id="es-target-cost-guide-list">
    <template>
        <!-- ============================================================
             Ajax 선언부 — Controller 호출
             ============================================================ -->
        <sc-ajax id="findListAjax"
                 url="/bp/cost/tc/guide/findListTargetCostGuide.do"
                 body="{{searchParam}}"
                 on-response="onFindListResponse">
        </sc-ajax>

        <sc-ajax id="calculateGuideAjax"
                 url="/bp/cost/tc/guide/calculateTargetGuide.do"
                 body="{{searchParam}}"
                 on-response="onCalculateGuideResponse">
        </sc-ajax>

        <sc-ajax id="saveListAjax"
                 url="/bp/cost/tc/guide/saveListTargetCostGuide.do"
                 body="{{saveParam}}"
                 on-response="onSaveListResponse">
        </sc-ajax>

        <!-- ============================================================
             조회 조건 영역 (Search Container)
             ============================================================ -->
        <sc-search-container on-search="onFindList" auth-code="V">
            <table>
                <colgroup>
                    <col style="width:100px"/>
                    <col/>
                    <col style="width:100px"/>
                    <col/>
                    <col style="width:100px"/>
                    <col/>
                </colgroup>
                <tr>
                    <th><sc-label text="프로젝트" required="true"></sc-label></th>
                    <td>
                        <sc-text-field value="{{searchParam.tgtPjtCd}}"
                                       on-enter="onFindList"
                                       required="true"
                                       placeholder="목표원가 프로젝트 코드">
                        </sc-text-field>
                    </td>
                    <th><sc-label text="사업부" required="true"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.bizUnit}}"
                                          items="{{codes.bizUnitList}}"
                                          display-field="label"
                                          value-field="data"
                                          required="true">
                        </sc-combobox-field>
                    </td>
                    <th><sc-label text="제품군" required="true"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.prodGrp}}"
                                          items="{{codes.prodGrpList}}"
                                          display-field="label"
                                          value-field="data"
                                          required="true">
                        </sc-combobox-field>
                    </td>
                </tr>
                <tr>
                    <th><sc-label text="OEM"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.oemNm}}"
                                          items="{{codes.oemList}}"
                                          display-field="label"
                                          value-field="data">
                        </sc-combobox-field>
                    </td>
                    <th><sc-label text="차종"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.carType}}"
                                          items="{{codes.carTypeList}}"
                                          display-field="label"
                                          value-field="data">
                        </sc-combobox-field>
                    </td>
                    <th><sc-label text="사양"></sc-label></th>
                    <td>
                        <sc-combobox-field value="{{searchParam.specDesc}}"
                                          items="{{codes.specList}}"
                                          display-field="label"
                                          value-field="data">
                        </sc-combobox-field>
                    </td>
                </tr>
            </table>
        </sc-search-container>

        <!-- ============================================================
             데이터 그리드 (Grid) — 부문별 목표 Guide
             ============================================================ -->
        <sc-grid id="gridPanel"
                 data-provider="{{resultList}}"
                 editable="true"
                 class="flex">

            <sc-toolbar>
                <sc-button text="조회"
                           on-click="onFindList"
                           auth-code="V">
                </sc-button>
                <sc-button text="산출"
                           on-click="onCalculateGuide"
                           auth-code="S">
                </sc-button>
                <sc-button text="저장"
                           on-click="onSaveList"
                           auth-code="S">
                </sc-button>
                <span class="vt-seperator"></span>
                <sc-button id="btnToggleAmt"
                           text="단위당금액 보기"
                           on-click="onToggleAmountType"
                           auth-code="V">
                </sc-button>
            </sc-toolbar>

            <sc-grid-columns>
                <sc-data-column data-field="costItemNm"
                                header-text="원가항목"
                                width="150"
                                text-align="left"
                                editable="false">
                </sc-data-column>

                <sc-data-column data-field="deptNm"
                                header-text="주관부서"
                                width="120"
                                text-align="center"
                                editable="false">
                </sc-data-column>

                <sc-data-column data-field="ecCostAmt"
                                header-text="견적/현상원가"
                                width="130"
                                text-align="right"
                                data-type="number"
                                format-type="amt"
                                editable="false">
                </sc-data-column>

                <sc-data-column data-field="guideTgtAmt"
                                header-text="목표 Guide 금액"
                                width="130"
                                text-align="right"
                                data-type="number"
                                format-type="amt"
                                editable="true">
                </sc-data-column>

                <sc-data-column data-field="cftTgtAmt"
                                header-text="CFT 확정 금액"
                                width="130"
                                text-align="right"
                                data-type="number"
                                format-type="amt"
                                editable="true">
                </sc-data-column>

                <sc-data-column data-field="saveRate"
                                header-text="절감률(%)"
                                width="90"
                                text-align="right"
                                data-type="number"
                                format-type="percent"
                                editable="false">
                </sc-data-column>
            </sc-grid-columns>
        </sc-grid>
    </template>

    <script>
        Polymer({
            is: 'es-target-cost-guide-list',

            properties: {
                searchParam: {
                    type: Object,
                    value: function() { return {}; }
                },
                resultList: {
                    type: Array,
                    value: function() { return []; }
                },
                saveParam: {
                    type: Object,
                    value: function() { return {}; }
                },
                codes: {
                    type: Object,
                    value: function() {
                        return {
                            bizUnitList:  [ { label: 'PT', data: 'PT' }, { label: 'SEAT', data: 'SEAT' } ],
                            prodGrpList:  [ { label: 'T/M', data: 'TM' }, { label: 'AXLE', data: 'AXLE' } ],
                            oemList:      [],
                            carTypeList:  [],
                            specList:     []
                        };
                    }
                },
                /**
                 * 금액 표시 모드
                 * 'total' = 총금액,  'unit' = 단위당금액
                 */
                amountMode: {
                    type: String,
                    value: 'total'
                }
            },

            /* =============================================================
               조회
               ============================================================= */
            onFindList: function() {
                if (!this.searchParam.tgtPjtCd) {
                    UT.alert('프로젝트 코드를 입력하세요.');
                    return;
                }
                this.$.findListAjax.generateRequest();
            },

            onFindListResponse: function(e) {
                var list = e.detail.response || [];
                // 조회 시 현재 amountMode에 맞춰 표시 필드 세팅
                this._applyAmountMode(list);
                this.set('resultList', list);
            },

            /* =============================================================
               Guide 산출 (TC03 — 서버 사이드 계산)
               ============================================================= */
            onCalculateGuide: function() {
                if (!this.searchParam.tgtPjtCd) {
                    UT.alert('프로젝트 코드를 입력하세요.');
                    return;
                }

                var me = this;
                UT.confirm('견적/현상원가를 기준으로 부문별 목표 Guide를 산출하시겠습니까?', function() {
                    me.$.calculateGuideAjax.generateRequest();
                });
            },

            onCalculateGuideResponse: function(e) {
                var list = e.detail.response || [];
                this._applyAmountMode(list);
                this.set('resultList', list);
                UT.alert('부문별 목표 Guide가 산출되었습니다.');
            },

            /* =============================================================
               저장
               ============================================================= */
            onSaveList: function() {
                var grid = this.$.gridPanel;
                var modifiedRows = grid.getModifiedRows();

                if (!modifiedRows || modifiedRows.length === 0) {
                    UT.alert('MSG_COM_00006');
                    return;
                }

                // CFT 확정 금액 합계 검증 — 총 배부액 불변 원칙
                var totalGuide = 0;
                var totalCft = 0;
                var allRows = this.resultList;

                for (var i = 0; i < allRows.length; i++) {
                    totalGuide += (Number(allRows[i].guideTgtTotAmt) || 0);
                    totalCft   += (Number(allRows[i].cftTgtTotAmt)  || 0);
                }

                // CFT 확정 금액이 입력된 경우, 총 절감액과 일치 여부 확인
                if (totalCft > 0 && totalCft !== totalGuide) {
                    UT.alert('CFT 확정 금액의 합계(KRW ' + totalCft.toLocaleString()
                             + ')가 목표 Guide 총액(KRW ' + totalGuide.toLocaleString()
                             + ')과 일치하지 않습니다.');
                    return;
                }

                var me = this;
                UT.confirm('MSG_COM_00002', function() {
                    me.set('saveParam', {
                        tgtPjtCd: me.searchParam.tgtPjtCd,
                        saveList: modifiedRows
                    });
                    me.$.saveListAjax.generateRequest();
                });
            },

            onSaveListResponse: function() {
                UT.alert('MSG_COM_00003');
                this.onFindList();
            },

            /* =============================================================
               총금액 ↔ 단위당금액 토글
               ============================================================= */

            /**
             * 토글 버튼 클릭 핸들러
             * - 'total' ↔ 'unit' 전환 후, 그리드의 표시 데이터를 교체한다.
             */
            onToggleAmountType: function() {
                // 모드 전환
                if (this.amountMode === 'total') {
                    this.set('amountMode', 'unit');
                    this.$.btnToggleAmt.text = '총금액 보기';
                } else {
                    this.set('amountMode', 'total');
                    this.$.btnToggleAmt.text = '단위당금액 보기';
                }

                // 현재 그리드 데이터에 새 모드 적용
                var list = this.resultList;
                if (list && list.length > 0) {
                    this._applyAmountMode(list);
                    this.set('resultList', []);       // 강제 리렌더
                    this.set('resultList', list);
                }
            },

            /**
             * 금액 모드에 따라 표시 필드(ecCostAmt, guideTgtAmt, cftTgtAmt)에
             * 총금액 또는 단위당금액 값을 복사한다.
             *
             * DB 원본 필드 매핑:
             *   총금액   → ecCostTotAmt  / guideTgtTotAmt  / cftTgtTotAmt
             *   단위당   → ecCostUnitAmt / guideTgtUnitAmt / cftTgtUnitAmt
             *   표시용   → ecCostAmt     / guideTgtAmt     / cftTgtAmt
             */
            _applyAmountMode: function(list) {
                var isUnit = (this.amountMode === 'unit');
                var ecSrc    = isUnit ? 'ecCostUnitAmt'    : 'ecCostTotAmt';
                var guideSrc = isUnit ? 'guideTgtUnitAmt'  : 'guideTgtTotAmt';
                var cftSrc   = isUnit ? 'cftTgtUnitAmt'    : 'cftTgtTotAmt';

                for (var i = 0; i < list.length; i++) {
                    list[i].ecCostAmt   = list[i][ecSrc]   || 0;
                    list[i].guideTgtAmt = list[i][guideSrc] || 0;
                    list[i].cftTgtAmt   = list[i][cftSrc]   || 0;
                }
            },

            /**
             * guideTgtAmt / cftTgtAmt 편집 시
             * 역방향으로 원본(Tot/Unit) 필드를 동기화한다.
             * (그리드 cell-edit 이벤트에 바인딩)
             */
            onCellEdited: function(e) {
                var row   = e.detail.row;
                var field = e.detail.dataField;
                var value = Number(e.detail.value) || 0;
                var qty   = Number(row.prodQty) || 1;

                if (field === 'guideTgtAmt' || field === 'cftTgtAmt') {
                    // 현재 모드에 따라 원본 필드 갱신
                    if (this.amountMode === 'total') {
                        row[field.replace('Amt', 'TotAmt')]  = value;
                        row[field.replace('Amt', 'UnitAmt')] = Math.round(value / qty);
                    } else {
                        row[field.replace('Amt', 'UnitAmt')] = value;
                        row[field.replace('Amt', 'TotAmt')]  = value * qty;
                    }

                    // 절감률 재계산: (견적원가 - Guide금액) / 견적원가 * 100
                    var ecTot    = Number(row.ecCostTotAmt) || 0;
                    var guideTot = Number(row.guideTgtTotAmt) || 0;
                    if (ecTot !== 0) {
                        row.saveRate = Math.round((ecTot - guideTot) / ecTot * 10000) / 100;
                    }
                }
            }
        });
    </script>
</dom-module>
